---
name: "Codex Activity Engine (v7)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "45 */4 * * *"  # runs after supervisor + sync
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  activity:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Configure token
        env:
          GH_CI_PAT: ${{ secrets.GH_CI_PAT }}
        run: |
          set -euo pipefail

          unset GH_TOKEN || true

          if [ -z "${GH_CI_PAT:-}" ]; then
            echo "ERROR: GH_CI_PAT secret missing."
            exit 1
          fi

          echo "$GH_CI_PAT" | gh auth login --with-token
          echo "Authenticated via GH_CI_PAT."

      - name: Run Activity Engine
        working-directory: repo
        env:
          GH_TOKEN: ${{ secrets.GH_CI_PAT }}
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          echo "Running Codex Activity Engine (v7) for $OWNER/$REPO"

          # Fetch codex issues (open only)
          issues="$(
            gh api \
              "/repos/$OWNER/$REPO/issues?state=open&labels=codex&per_page=100" \
              --jq '.[]'
          )"

          if [ -z "$issues" ]; then
            echo "No codex issues found—nothing to process."
            exit 0
          fi

          # Prepare gh-pages storage
          mkdir -p ../gh-pages/activity

          timestamp="$(date -u +"%Y%m%dT%H%M%SZ")"
          outfile="../gh-pages/activity/activity-$timestamp.json"

          echo "Writing activity snapshot → $outfile"

          {
            echo '['

            first=true
            echo "$issues" | jq -c '.' | while read -r issue; do
              if [ "$first" = true ]; then
                first=false
              else
                echo ','
              fi
              echo "$issue"
            done

            echo ']'
          } > "$outfile"

          echo "Activity Engine wrote snapshot successfully."

      - name: Commit Activity Snapshot
        working-directory: gh-pages
        env:
          GH_TOKEN: ${{ secrets.GH_CI_PAT }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add activity/*.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Codex Activity Engine snapshot"
          git push origin gh-pages

          echo "Activity snapshot committed and pushed."
