---
# yamllint disable rule:truthy
name: Codex – Auto Assign & Label

on:
  issues:
    types: [opened]

permissions:
  issues: write
  repository-projects: write
  contents: read

jobs:
  autoassign:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      REPO: ${{ github.repository }}
      PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}

    steps:
      - name: Start Auto-Assign
        run: |
          echo "Codex Auto-Assign running…"
          gh --version

      # -------------------------------------------------------------
      # 1. Add labels
      # -------------------------------------------------------------
      - name: Label issue
        run: |
          gh issue edit "${{ github.event.issue.number }}" \
            --add-label "codex" \
            --add-label "triage"

      # -------------------------------------------------------------
      # 2. Add to project
      # -------------------------------------------------------------
      - name: Add issue to project
        run: |
          NUM="${{ github.event.issue.number }}"

          NODE=$(gh api graphql -f query='
            query($owner:String!, $repo:String!, $num:Int!) {
              repository(owner:$owner, name:$repo) {
                issue(number:$num) { id }
              }
            }' \
            -F owner="${GITHUB_REPOSITORY_OWNER}" \
            -F repo="${GITHUB_REPOSITORY#*/}" \
            -F num="$NUM")

          ID=$(echo "$NODE" | grep -oE '"id":"[^"]+"' | sed 's/"id":"\(.*\)"/\1/')

          gh api graphql -f query='
            mutation($project:ID!, $item:ID!) {
              addProjectV2ItemById(input:{projectId:$project, contentId:$item}) {
                item { id }
              }
            }' \
            -F project="$PROJECT_ID" \
            -F item="$ID"
