---
name: Codex Self-Test Cleaner (v4)

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "30 2 * * *"  # nightly cleanup
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  cleaner:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Ensure telemetry directories exist
        run: |
          mkdir -p gh-pages/telemetry
          mkdir -p gh-pages/dashboard
          mkdir -p gh-pages/merged

      - name: Cleanup raw telemetry files
        id: cleanup
        run: |
          MAX_AGE="${CODEX_SELFTEST_MAX_AGE_DAYS:-30}"

          echo "Cleaning telemetry files older than $MAX_AGE days…"

          DELETE_LIST=()

          while IFS= read -r file; do
            DELETE_LIST+=("$file")
          done < <(find gh-pages/telemetry -maxdepth 1 -type f -mtime +"$MAX_AGE")

          if [ ${#DELETE_LIST[@]} -eq 0 ]; then
            echo "deleted_count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Deleting ${#DELETE_LIST[@]} old telemetry files…"

          for f in "${DELETE_LIST[@]}"; do
            rm -f "$f"
          done

          echo "deleted_count=${#DELETE_LIST[@]}" >> "$GITHUB_OUTPUT"

      - name: Write cleaner telemetry entry
        run: |
          OUT="gh-pages/telemetry/cleaner-${GITHUB_RUN_ID}.json"
          TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          {
            printf '{\n'
            printf '  "component": "cleaner",\n'
            printf '  "timestamp": "%s",\n' "$TS"
            printf '  "run_id": "%s",\n' "$GITHUB_RUN_ID"
            printf '  "deleted_count": %s\n' "${{ steps.cleanup.outputs.deleted_count }}"
            printf '}\n'
          } > "$OUT"

          echo "Wrote telemetry → $OUT"

      - name: Commit changes
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/*.json || true
          git commit -m "Self-Test Cleaner telemetry update" || true
          git push origin gh-pages || true
