# yamllint disable rule:truthy
---
name: Codex Cleanup gh-pages

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  clean-gh-pages:
    name: Normalize gh-pages structure
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------
      # 1. Checkout gh-pages as a real branch
      # -------------------------------------------------------
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      # -------------------------------------------------------
      # 2. Remove legacy directories
      # -------------------------------------------------------
      - name: Remove legacy telemetry directories
        run: |
          LEGACY_DIRS=(
            "codex"
            "codex-selftest"
            "supervisor-telemetry"
            "workflow-telemetry"
            "telemetry"
          )

          for DIR in "${LEGACY_DIRS[@]}"; do
            if [[ -d "$DIR" ]]; then
              echo "Removing legacy directory: $DIR"
              rm -rf "$DIR"
            fi
          done

      # -------------------------------------------------------
      # 3. Ensure required directories exist
      # -------------------------------------------------------
      - name: Recreate required directories
        run: |
          REQUIRED_DIRS=(
            "project-telemetry"
            "activity-telemetry"
            "dashboard"
          )

          for DIR in "${REQUIRED_DIRS[@]}"; do
            if [[ ! -d "$DIR" ]]; then
              echo "Creating directory: $DIR"
              mkdir -p "$DIR"
            else
              echo "✔ Directory exists: $DIR"
            fi
          done
          # Create .gitkeep files so directories are committed
          for DIR in "${REQUIRED_DIRS[@]}"; do
            if [[ ! -f "$DIR/.gitkeep" ]]; then
              touch "$DIR/.gitkeep"
            fi
          done

      # -------------------------------------------------------
      # 4. Ensure codex-data.json exists
      # -------------------------------------------------------
      - name: Ensure codex-data.json exists
        run: |
          if [[ ! -f "codex-data.json" ]]; then
            echo "Creating empty codex-data.json"
            echo "[]" > codex-data.json
          else
            echo "✔ codex-data.json already exists"
          fi

      # -------------------------------------------------------
      # 5. Commit & push changes
      # -------------------------------------------------------
      - name: Commit and push changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "[skip ci] Codex: cleanup gh-pages structure"
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" gh-pages

      # -------------------------------------------------------
      # 6. Summary
      # -------------------------------------------------------
      - name: Summary
        run: |
          echo "-----------------------------------------"
          echo "Codex gh-pages Cleanup Completed Successfully"
          echo "-----------------------------------------"
