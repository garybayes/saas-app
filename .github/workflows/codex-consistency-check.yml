---
# yamllint disable rule:truthy
name: Codex Consistency Check

# yamllint disable-line rule:truthy
on:
  schedule:
    # Every Monday at 03:00
    - cron: "0 3 * * MON"
  workflow_dispatch:

jobs:
  consistency:
    name: Codex Consistency Sweep
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4


      - name: Consistency Sweep
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          PROJECT_URL: https://github.com/users/garybayes/projects/6
          MILESTONE: "Codex Internal"
        run: |
          echo "Starting Codex consistency sweep..."
          echo "-----------------------------------"

          fixed_missing_project=()
          fixed_missing_milestone=()

          # 1. Collect all issues with the 'codex' label
          echo "→ Fetching codex-labelled issues..."
          mapfile -t codex_issues < <(gh issue list \
            --label codex \
            --jq '.[].number')

          echo "Found ${#codex_issues[@]} codex issues."

          # 2. Check each issue
          for issue in "${codex_issues[@]}"; do
            echo ""
            echo "Checking issue #$issue ..."

            #
            # Check project membership
            #
            in_project=$(gh project item-list 6 \
              --owner "garybayes" \
              --jq ".items[].content.number" | grep -Fx "$issue" || true)

            if [[ -z "$in_project" ]]; then
              echo "  → Issue #$issue is missing from project. Adding..."
              gh project item-add \
                --owner "garybayes" \
                --number 6 \
                --content-type Issue \
                --content-id "$(gh issue view $issue --json id --jq '.id')"
              fixed_missing_project+=("$issue")
            else
              echo "  ✓ Already in project"
            fi

            #
            # Check milestone
            #
            has_milestone=$(gh issue view "$issue" \
              --json milestone \
              --jq '.milestone.title == env.MILESTONE')

            if [[ "$has_milestone" != "true" ]]; then
              echo "  → Issue #$issue missing milestone. Setting milestone '${MILESTONE}'..."
              gh issue edit "$issue" --milestone "$MILESTONE"
              fixed_missing_milestone+=("$issue")
            else
              echo "  ✓ Milestone OK"
            fi

          done

          echo ""
          echo "-----------------------------------"
          echo "Codex Consistency Sweep Complete"
          echo "-----------------------------------"
          echo ""
          echo "Issues added to project: ${#fixed_missing_project[@]}"
          printf '%s\n' "${fixed_missing_project[@]}"
          echo ""
          echo "Issues fixed for missing milestone: ${#fixed_missing_milestone[@]}"
          printf '%s\n' "${fixed_missing_milestone[@]}"
          echo ""
          echo "Done."
