---
# yamllint disable rule:truthy
name: Codex Deploy Dashboard v2.4

on:
  push:
    branches:
      - main
    paths:
      - "codex/dashboard/**"    # Only redeploy when dashboard files change
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------
      # 1. Checkout MAIN branch → repo-main/
      # ----------------------------------------------------
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          path: repo-main
          fetch-depth: 1

      # ----------------------------------------------------
      # 2. Checkout GH-PAGES branch → repo-pages/
      # ----------------------------------------------------
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: repo-pages
          fetch-depth: 1

      # ----------------------------------------------------
      # 3. Copy new dashboard files
      # ----------------------------------------------------
      - name: Sync dashboard into gh-pages
        run: |
          set -e
          echo repo-pages
          echo "Clearing old dashboard…"
          rm -rfv repo-pages/dashboard
          mkdir -pv repo-pages/dashboard
          echo repo-main
          echo "Copying updated dashboard from main → gh-pages…"
          cp -Rv repo-main/codex/dashboard/* repo-pages/dashboard/

      # ----------------------------------------------------
      # 4. Commit + push only if changed
      # ----------------------------------------------------
      - name: Commit and push dashboard
        run: |
          set -e
          cd repo-pages

          git config --global user.name  "codex-ci-bot"
          git config --global user.email "codex-ci-bot@users.noreply.github.com"

          git add dashboard/

          if ! git diff --cached --quiet; then
            echo "Changes detected → committing update."
            git commit -m "Deploy Codex Dashboard v2.4 [skip ci]"
            git push origin gh-pages
          else
            echo "No changes detected — nothing to deploy."
          fi
