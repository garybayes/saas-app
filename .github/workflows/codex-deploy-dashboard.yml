# yamllint disable rule:truthy
---
name: Deploy Codex Dashboard

on:
  push:
    branches:
      - main
    paths:
      - "codex/dashboard/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    name: Deploy Codex Dashboard to gh-pages
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}

    steps:
      # -----------------------------------------------------------
      # 1. Checkout main (dashboard source)
      # -----------------------------------------------------------
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------------
      # 2. Checkout gh-pages separately
      # -----------------------------------------------------------
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: ghp
          fetch-depth: 0

      # -----------------------------------------------------------
      # 3. Ensure required directories exist
      # -----------------------------------------------------------
      - name: Prepare directory structure
        run: |
          cd ghp
          mkdir -p dashboard
          cp ../codex/dashboard/* dashboard/

          # Ensure .nojekyll exists for static sites
          touch .nojekyll

      # -----------------------------------------------------------
      # 4. Commit and push if changes exist
      # -----------------------------------------------------------
      - name: Commit and push changes
        run: |
          cd ghp

          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          git add -A

          if git diff --cached --quiet; then
            echo "No dashboard changes to deploy."
            exit 0
          fi

          git commit -m "[skip ci] Update Codex dashboard"
          git push "https://x-access-token:${GH_TOKEN}@github.com/garybayes/saas-app.git" gh-pages

      # -----------------------------------------------------------
      # 5. Summary
      # -----------------------------------------------------------
      - name: Deployment Summary
        run: |
          echo "---------------------------------------"
          echo "Codex Dashboard Deployment Completed"
          echo "---------------------------------------"
