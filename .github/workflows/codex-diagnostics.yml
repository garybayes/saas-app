---
name: Codex Diagnostics (v7.4)

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "50 */6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  diagnostics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare telemetry directory
        run: |
          mkdir -p gh-pages/telemetry

      - name: Load configuration
        id: config
        run: |
          set -euo pipefail

          # Load repo-scoped variables (safe even if missing)
          MAIN_MS="${CODEX_MAIN_MILESTONE:-}"
          DASH_MS="${CODEX_DASHBOARD_MILESTONE:-}"
          SELFTEST_MS="${CODEX_SELFTEST_MILESTONE:-}"

          echo "main_ms=$MAIN_MS" >> "$GITHUB_OUTPUT"
          echo "dash_ms=$DASH_MS" >> "$GITHUB_OUTPUT"
          echo "selftest_ms=$SELFTEST_MS" >> "$GITHUB_OUTPUT"

      - name: Validate milestones
        id: milestones
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GI
