---
name: Codex Diagnostics (v7.4)

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "50 */6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  diagnostics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare telemetry directory
        run: |
          mkdir -p gh-pages/telemetry

      - name: Load configuration
        id: config
        run: |
          set -euo pipefail

          # Load repo-scoped variables (safe even if missing)
          MAIN_MS="${CODEX_MAIN_MILESTONE:-}"
          DASH_MS="${CODEX_DASHBOARD_MILESTONE:-}"
          SELFTEST_MS="${CODEX_SELFTEST_MILESTONE:-}"

          echo "main_ms=$MAIN_MS" >> "$GITHUB_OUTPUT"
          echo "dash_ms=$DASH_MS" >> "$GITHUB_OUTPUT"
          echo "selftest_ms=$SELFTEST_MS" >> "$GITHUB_OUTPUT"

      - name: Validate milestones
        id: milestones
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          ms_json="$(gh api "/repos/$OWNER/$REPO/milestones")"

          get_title() {
            local ms="$1"
            if [ -z "$ms" ]; then echo ""; return; fi
            echo "$ms_json" | jq -r ".[] | select(.number==$ms) | .title" || echo ""
          }

          MAIN_TITLE="$(get_title "${{ steps.config.outputs.main_ms }}")"
          DASH_TITLE="$(get_title "${{ steps.config.outputs.dash_ms }}")"
          SELFTEST_TITLE="$(get_title "${{ steps.config.outputs.selftest_ms }}")"

          echo "main_title=$MAIN_TITLE" >> "$GITHUB_OUTPUT"
          echo "dash_title=$DASH_TITLE" >> "$GITHUB_OUTPUT"
          echo "selftest_title=$SELFTEST_TITLE" >> "$GITHUB_OUTPUT"

      - name: Validate labels
        id: labels
        run: |
          LABELS_JSON="$(gh api "/repos/$GITHUB_REPOSITORY/labels")"

          REQUIRED=(codex codex-trackmain codex-trackdashboard codex-selftest)
          missing=()

          for L in "${REQUIRED[@]}"; do
            if ! echo "$LABELS_JSON" | jq -e --arg L "$L" '.[] | select(.name==$L)' >/dev/null; then
              missing+=("$L")
            fi
          done

          printf '%s\n' "${missing[@]}" | jq -R . | jq -s . > missing_labels.json
          echo "missing_labels=$(cat missing_labels.json)" >> "$GITHUB_OUTPUT"

      - name: Validate classic project (optional)
        id: project
        run: |
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          PROJ_JSON="$(gh api -H 'Accept: application/vnd.github.inertia-preview+json' \
            "/repos/$OWNER/$REPO/projects")"

          if echo "$PROJ_JSON" | jq -e '.[] | select(.name=="Codex Dual-Track Development")' >/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Write diagnostics telemetry
        id: write
        run: |
          OUT="gh-pages/telemetry/diagnostics-$(date -u +"%Y%m%dT%H%M%SZ").json"

          {
            printf '{\n'
            printf '  "component": "diagnostics",\n'
            printf '  "timestamp": "%s",\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            printf '  "repository": "%s",\n' "$GITHUB_REPOSITORY"

            printf '  "milestones": {\n'
            printf '    "main": "%s",\n' "${{ steps.milestones.outputs.main_title }}"
            printf '    "dashboard": "%s",\n' "${{ steps.milestones.outputs.dash_title }}"
            printf '    "selftest": "%s"\n' "${{ steps.milestones.outputs.selftest_title }}"
            printf '  },\n'

            printf '  "labels": {\n'
            printf '    "missing": %s\n' "${{ steps.labels.outputs.missing_labels }}"
            printf '  },\n'

            printf '  "project": {\n'
            printf '    "exists": "%s"\n' "${{ steps.project.outputs.exists }}"
            printf '  }\n'

            printf '}\n'
          } > "$OUT"

          echo "telemetry_file=$OUT" >> "$GITHUB_OUTPUT"
          echo "Telemetry written to: $OUT"

      - name: Commit telemetry
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/*.json
          git commit -m "Diagnostics telemetry update" || true
          git push origin gh-pages || true

      - name: Fail if configuration invalid
        run: |
          BAD=false

          if [ -z "${{ steps.milestones.outputs.main_title }}" ]; then BAD=true; fi
          if [ -z "${{ steps.milestones.outputs.dash_title }}" ]; then BAD=true; fi

          if [ "${BAD}" = true ]; then
            echo "CONFIG ERROR detected. Failing diagnostics job."
            exit 1
          fi
