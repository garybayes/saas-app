---
name: Codex Diagnostics (v7.7)

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "50 */6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

  # Inject repo variables into job environment
  CODEX_MAIN_MILESTONE: ${{ vars.CODEX_MAIN_MILESTONE }}
  CODEX_DASHBOARD_MILESTONE: ${{ vars.CODEX_DASHBOARD_MILESTONE }}
  CODEX_SELFTEST_MILESTONE: ${{ vars.CODEX_SELFTEST_MILESTONE }}

jobs:
  diagnostics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Ensure telemetry directory exists
        run: mkdir -p gh-pages/telemetry

      - name: Run Diagnostics
        id: diag
        run: |
          set -euo pipefail
          echo "Running diagnostics for $GITHUB_REPOSITORY"

          #
          # 1. Resolve OWNER/REPO safely
          #
          if [[ -z "${GITHUB_REPOSITORY:-}" ]]; then
            echo "ERROR: GITHUB_REPOSITORY is empty"
            exit 1
          fi

          OWNER="$(printf "%s" "$GITHUB_REPOSITORY" | cut -d'/' -f1)"
          REPO="$(printf "%s" "$GITHUB_REPOSITORY" | cut -d'/' -f2)"

          if [[ -z "$OWNER" || -z "$REPO" ]]; then
            echo "ERROR: OWNER/REPO could not be parsed"
            exit 1
          fi

          echo "OWNER=$OWNER"
          echo "REPO=$REPO"

          #
          # 2. Verify repo exists (prevents mysterious 404s)
          #
          if ! gh api "/repos/$OWNER/$REPO" >/dev/null 2>&1; then
            echo "ERROR: GitHub API could not access repository /repos/$OWNER/$REPO"
            exit 1
          fi

          #
          # 3. Load milestone variables
          #
          MAIN_MS="${CODEX_MAIN_MILESTONE:-}"
          DASH_MS="${CODEX_DASHBOARD_MILESTONE:-}"
          SELFTEST_MS="${CODEX_SELFTEST_MILESTONE:-}"

          if [[ -z "$MAIN_MS" || -z "$DASH_MS" || -z "$SELFTEST_MS" ]]; then
            echo "ERROR: One or more milestone variables are missing:"
            echo "  MAIN_MS=$MAIN_MS"
            echo "  DASH_MS=$DASH_MS"
            echo "  SELFTEST_MS=$SELFTEST_MS"
            CONFIG_ERROR="true"
          else
            echo "Using milestone numbers:"
            echo "  main      = $MAIN_MS"
            echo "  dashboard = $DASH_MS"
            echo "  selftest  = $SELFTEST_MS"
          fi

          #
          # 4. Fetch milestones
          #
          ms_json="$(gh api "/repos/$OWNER/$REPO/milestones")"

          # Pull milestone titles safely
          ms_main_title=$(echo "$ms_json" | jq -r \
            --arg ms "$MAIN_MS" '.[] | select((.number|tostring)==$ms) | .title // empty')

          ms_dash_title=$(echo "$ms_json" | jq -r \
            --arg ms "$DASH_MS" '.[] | select((.number|tostring)==$ms) | .title // empty')

          ms_self_title=$(echo "$ms_json" | jq -r \
            --arg ms "$SELFTEST_MS" '.[] | select((.number|tostring)==$ms) | .title // empty')

          if [[ -z "$ms_main_title" || -z "$ms_dash_title" || -z "$ms_self_title" ]]; then
            echo "ERROR: One or more milestone numbers do not match an existing milestone"
            CONFIG_ERROR="true"
          fi

          #
          # 5. Validate required labels
          #
          labels_json="$(gh api "/repos/$OWNER/$REPO/labels")"

          required_labels=(
            codex
            codex-selftest
            codex-trackmain
            codex-trackdashboard
          )

          missing_labels=()
          for lbl in "${required_labels[@]}"; do
            if ! echo "$labels_json" | jq -e --arg L "$lbl" '.[] | select(.name==$L)' >/dev/null; then
              missing_labels+=( "$lbl" )
            fi
          done

          #
          # 6. Build telemetry payload
          #
          ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          outfile="gh-pages/telemetry/diagnostics-${ts//:/}.json"

          {
            printf '{\n'
            printf '  "component": "diagnostics",\n'
            printf '  "timestamp": "%s",\n' "$ts"
            printf '  "repository": "%s",\n' "$GITHUB_REPOSITORY"

            printf '  "milestones": {\n'
            printf '    "main": "%s",\n' "$ms_main_title"
            printf '    "dashboard": "%s",\n' "$ms_dash_title"
            printf '    "selftest": "%s"\n' "$ms_self_title"
            printf '  },\n'

            printf '  "missing_labels": %s,\n' \
              "$(printf '%s\n' "${missing_labels[@]}" | jq -R . | jq -s .)"

            printf '  "config_error": "%s"\n' "${CONFIG_ERROR:-false}"
            printf '}\n'
          } > "$outfile"

          echo "Wrote diagnostics to: $outfile"

          #
          # 7. Fail workflow if config error detected
          #
          if [[ "${CONFIG_ERROR:-false}" == "true" ]]; then
            echo "CONFIG ERROR detected. Failing diagnostics job."
            exit 1
          fi

      - name: Commit telemetry
        if: always()
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add telemetry/*.json || true
          git commit -m "Diagnostics Telemetry Update" || echo "No changes"
          git push origin gh-pages
