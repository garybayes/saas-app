---
name: Codex Diagnostics (v7.5)

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "50 */6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  diagnostics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Ensure telemetry directory
        run: |
          mkdir -p gh-pages/telemetry

      - name: Load configuration variables
        id: config
        run: |
          set -euo pipefail

          echo "main_ms=${CODEX_MAIN_MILESTONE:-}" >> "$GITHUB_OUTPUT"
          echo "dash_ms=${CODEX_DASHBOARD_MILESTONE:-}" >> "$GITHUB_OUTPUT"
          echo "selftest_ms=${CODEX_SELFTEST_MILESTONE:-}" >> "$GITHUB_OUTPUT"

      - name: Collect diagnostics
        id: diag
        working-directory: repo
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          MAIN_MS="${{ steps.config.outputs.main_ms }}"
          DASH_MS="${{ steps.config.outputs.dash_ms }}"
          SELFTEST_MS="${{ steps.config.outputs.selftest_ms }}"

          echo "Using milestone numbers:"
          echo "  main      = $MAIN_MS"
          echo "  dashboard = $DASH_MS"
          echo "  selftest  = $SELFTEST_MS"

          # Fetch milestones
          ms_json="$(gh api "/repos/$OWNER/$REPO/milestones")"

          ms_main_title="$(echo "$ms_json" | jq -r \
            --arg N "$MAIN_MS" '.[] | select((.number|tostring)==$N) | .title')"

          ms_dash_title="$(echo "$ms_json" | jq -r \
            --arg N "$DASH_MS" '.[] | select((.number|tostring)==$N) | .title')"

          ms_selftest_title="$(echo "$ms_json" | jq -r \
            --arg N "$SELFTEST_MS" '.[] | select((.number|tostring)==$N) | .title')"

          # Validate labels
          labels_json="$(gh api "/repos/$OWNER/$REPO/labels")"
          missing_labels=()

          for L in codex codex-selftest codex-trackmain codex-trackdashboard; do
            if ! echo "$labels_json" | jq -e --arg L "$L" '.[] | select(.name==$L)' >/dev/null; then
              missing_labels+=( "$L" )
            fi
          done

          # Validate project
          proj_json="$(gh api -H 'Accept: application/vnd.github.inertia-preview+json' \
            "/repos/$OWNER/$REPO/projects")"

          project_ok="true"
          if ! echo "$proj_json" | jq -e '.[] | select(.name=="Codex Dual-Track Development")' >/dev/null; then
            project_ok="false"
          fi

          # Build JSON output
          out="{
            \"component\": \"diagnostics\",
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"repository\": \"$GITHUB_REPOSITORY\",
            \"milestones\": {
              \"main\": \"$ms_main_title\",
              \"dashboard\": \"$ms_dash_title\",
              \"selftest\": \"$ms_selftest_title\"
            },
            \"labels\": {
              \"missing\": $(printf '%s\n' "${missing_labels[@]}" | jq -R . | jq -s .)
            },
            \"project\": {
              \"exists\": \"$project_ok\"
            },
            \"gh_pages\": {
              \"dashboard_exists\": \"$( [ -f "../gh-pages/dashboard/dashboard.json" ] && echo true || echo false )\",
              \"telemetry_exists\": \"$( [ -d "../gh-pages/telemetry" ] && echo true || echo false )\"
            }
          }"

          outfile="../gh-pages/telemetry/diagnostics-$(date -u +%Y%m%dT%H%M%SZ).json"
          echo "$out" > "$outfile"
          echo "Wrote: $outfile"

      - name: Commit telemetry
        working-directory: gh-pages
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/*.json || true
          git commit -m "Diagnostics update" || true
          git push origin gh-pages
