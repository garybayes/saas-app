# yamllint disable rule:truthy
---
name: Codex Diagnostics

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  diagnostics:
    name: Run Codex Diagnostics
    runs-on: ubuntu-latest

    env:
      CODEX_PROJECT_URL: ${{ vars.CODEX_PROJECT_URL }}
      CODEX_PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}
      CODEX_PROJECT_NUMBER: ${{ vars.CODEX_PROJECT_NUMBER }}
      CODEX_MAIN_MILESTONE: ${{ vars.CODEX_MAIN_MILESTONE }}
      CODEX_DASHBOARD_MILESTONE: ${{ vars.CODEX_DASHBOARD_MILESTONE }}
      CODEX_MAIN_STALE_DAYS: ${{ vars.CODEX_MAIN_STALE_DAYS }}
      CODEX_MAIN_ESCALATE_DAYS: ${{ vars.CODEX_MAIN_ESCALATE_DAYS }}
      CODEX_DASHBOARD_STALE_DAYS: ${{ vars.CODEX_DASHBOARD_STALE_DAYS }}
      CODEX_DASHBOARD_ESCALATE_DAYS: ${{ vars.CODEX_DASHBOARD_ESCALATE_DAYS }}
      CODEX_ACTIVITY_STALE_DAYS: ${{ vars.CODEX_ACTIVITY_STALE_DAYS }}
      CODEX_ACTIVITY_ESCALATE_DAYS: ${{ vars.CODEX_ACTIVITY_ESCALATE_DAYS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify GitHub CLI
        run: gh --version

      - name: Check Repository Variables
        run: |
          echo "Checking Codex required environment variables..."
          REQUIRED_VARS=(
            CODEX_PROJECT_URL
            CODEX_PROJECT_ID
            CODEX_PROJECT_NUMBER
            CODEX_MAIN_MILESTONE
            CODEX_DASHBOARD_MILESTONE
            CODEX_MAIN_STALE_DAYS
            CODEX_MAIN_ESCALATE_DAYS
            CODEX_DASHBOARD_STALE_DAYS
            CODEX_DASHBOARD_ESCALATE_DAYS
            CODEX_ACTIVITY_STALE_DAYS
            CODEX_ACTIVITY_ESCALATE_DAYS
          )

          EXIT_CODE=0
          for VAR in "${REQUIRED_VARS[@]}"; do
            if [[ -z "${!VAR}" ]]; then
              echo "::error::Missing repository variable: $VAR"
              EXIT_CODE=1
            else
              echo "✔ $VAR is present"
            fi
          done

          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "::error::Missing required variables — fix before running Codex."
            exit 1
          fi

      - name: Check gh-pages branch
        run: |
          echo "Checking if gh-pages branch exists..."
          if ! git ls-remote --exit-code origin gh-pages > /dev/null 2>&1; then
            echo "::error::gh-pages branch does not exist."
            exit 1
          fi
          echo "✔ gh-pages branch exists."

      - name: Checkout gh-pages branch into subdirectory
        run: |
          echo "Fetching gh-pages files..."
          git fetch origin gh-pages
          mkdir ghp
          git --work-tree=ghp checkout origin/gh-pages -- .

      - name: Validate telemetry directories
        run: |
          echo "Checking telemetry structure inside gh-pages..."

          REQUIRED_DIRS=(
            "activity-telemetry"
            "project-telemetry"
          )

          for DIR in "${REQUIRED_DIRS[@]}"; do
            if [[ ! -d "ghp/$DIR" ]]; then
              echo "::error::Missing directory on gh-pages: $DIR"
              exit 1
            fi
            echo "✔ $DIR exists"
          done

          if [[ ! -f "ghp/codex-data.json" ]]; then
            echo "::error::Missing codex-data.json on gh-pages"
            exit 1
          fi

          echo "✔ codex-data.json exists"

      - name: Validate dashboard directory
        run: |
          echo "Checking deployed dashboard directory..."

          if [[ ! -d "ghp/dashboard" ]]; then
            echo "::error::Missing dashboard directory on gh-pages"
            exit 1
          fi

          echo "✔ dashboard directory exists"

      - name: Validate dashboard source (codex/dashboard)
        run: |
          echo "Checking source dashboard under main branch..."

          if [[ ! -d "codex/dashboard" ]]; then
            echo "::error::Missing codex/dashboard source directory"
            exit 1
          fi

          echo "✔ codex/dashboard source directory exists"

      - name: Summary
        run: |
          echo "----------------------------------------"
          echo "Codex Diagnostics Completed Successfully"
          echo "----------------------------------------"
