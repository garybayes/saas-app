---
# yamllint disable rule:truthy
name: Codex â€“ Diagnostics

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  diag:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      REPO: ${{ github.repository }}

      CODEX_PROJECT_URL: ${{ vars.CODEX_PROJECT_URL }}
      CODEX_PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}
      CODEX_PROJECT_NUMBER: ${{ vars.CODEX_PROJECT_NUMBER }}

      CODEX_MAIN_MILESTONE: ${{ vars.CODEX_MAIN_MILESTONE }}
      CODEX_DASHBOARD_MILESTONE: ${{ vars.CODEX_DASHBOARD_MILESTONE }}

      CODEX_MAIN_STALE_DAYS: ${{ vars.CODEX_MAIN_STALE_DAYS }}
      CODEX_MAIN_ESCALATE_DAYS: ${{ vars.CODEX_MAIN_ESCALATE_DAYS }}
      CODEX_DASHBOARD_STALE_DAYS: ${{ vars.CODEX_DASHBOARD_STALE_DAYS }}
      CODEX_DASHBOARD_ESCALATE_DAYS: ${{ vars.CODEX_DASHBOARD_ESCALATE_DAYS }}
      CODEX_ACTIVITY_STALE_DAYS: ${{ vars.CODEX_ACTIVITY_STALE_DAYS }}
      CODEX_ACTIVITY_ESCALATE_DAYS: ${{ vars.CODEX_ACTIVITY_ESCALATE_DAYS }}

    steps:
      - name: Print variables
        run: |
          echo "Project URL: $CODEX_PROJECT_URL"
          echo "Project ID:  $CODEX_PROJECT_ID"
          echo "Project #:   $CODEX_PROJECT_NUMBER"
          echo "Main:        $CODEX_MAIN_MILESTONE"
          echo "Dash:        $CODEX_DASHBOARD_MILESTONE"

      - name: Test GitHub authentication
        run: |
          gh auth status

      - name: Validate Project URL
        run: |
          URL="$CODEX_PROJECT_URL"
          NUM=$(echo "$URL" | grep -oE '[0-9]+$')
          echo "Detected project number: $NUM"
          gh project view "$NUM" --owner "${GITHUB_REPOSITORY_OWNER}"

      - name: Check gh-pages exists
        run: |
          set -e
          git clone --depth 1 "https://github.com/$REPO" repo
          cd repo
          git fetch origin gh-pages || true
          git checkout gh-pages || echo "gh-pages branch not found."
