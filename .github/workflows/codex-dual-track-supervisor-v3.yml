# ----------------------------------------------------------
# 1. Checkout gh-pages into ./repo-pages
# ----------------------------------------------------------
- name: Checkout gh-pages
  uses: actions/checkout@v4
  with:
    ref: gh-pages
    path: repo-pages
    fetch-depth: 1

# ----------------------------------------------------------
# 2. Generate Supervisor Telemetry Snapshot
# ----------------------------------------------------------
- name: Write supervisor telemetry
  run: |
    set -e
    mkdir -p repo-pages/supervisor-telemetry

    TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    cat <<EOF > repo-pages/supervisor-telemetry/latest.json
{
  "timestamp": "$TS",
  "status": "ok",
  "source": "supervisor-v3"
}
EOF

# ----------------------------------------------------------
# 3. Commit + Push
# ----------------------------------------------------------
- name: Commit supervisor telemetry
  run: |
    cd repo-pages

    git config --global user.name  "codex-ci-bot"
    git config --global user.email "codex-ci-bot@users.noreply.github.com"

    git add supervisor-telemetry/latest.json

    if ! git diff --cached --quiet; then
      git commit -m "Supervisor telemetry update [skip ci]"
      git push origin gh-pages
    else
      echo "No telemetry changes to commit."
    fi
