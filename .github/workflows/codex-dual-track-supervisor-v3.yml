---
# yamllint disable rule:truthy
name: Codex Dual-Track Supervisor v3

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  supervisor:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      REPO: ${{ github.repository }}
      PROJECT_URL: ${{ vars.CODEX_PROJECT_URL }}
      MAIN_MILESTONE: ${{ vars.CODEX_MAIN_MILESTONE }}
      DASH_MILESTONE: ${{ vars.CODEX_DASHBOARD_MILESTONE }}
      MAIN_STALE: ${{ vars.CODEX_MAIN_STALE_DAYS }}
      DASH_STALE: ${{ vars.CODEX_DASHBOARD_STALE_DAYS }}
      MAIN_ESC: ${{ vars.CODEX_MAIN_ESCALATE_DAYS }}
      DASH_ESC: ${{ vars.CODEX_DASHBOARD_ESCALATE_DAYS }}

    steps:
      - name: Fetch supervisor status
        run: |
          echo "Codex Dual-Track Supervisor startingâ€¦"
          gh --version

      - name: Scan sprint issues
        id: sprint_scan
        run: |
          ISSUES=$(gh issue list --state open --json number,title,milestone,updatedAt,url)
          echo "$ISSUES" > issues.json

          COUNT=$(echo "$ISSUES" | jq \
            --arg M "$MAIN_MILESTONE" \
            '[ .[] | select(.milestone.title == $M) ] | length')

          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Scan dashboard issues
        id: dash_scan
        run: |
          ISSUES=$(cat issues.json)

          COUNT=$(echo "$ISSUES" | jq \
            --arg M "$DASH_MILESTONE" \
            '[ .[] | select(.milestone.title == $M) ] | length')

          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Analyze state
        run: |
          echo "Sprint issues in active milestone: ${{ steps.sprint_scan.outputs.count }}"
          echo "Dashboard issues in upgrade milestone: ${{ steps.dash_scan.outputs.count }}"

          # This supervisor does not mutate issues directly.
          echo "Supervisor v3 completed successfully."
