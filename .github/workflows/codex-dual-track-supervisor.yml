---
name: Codex Dual-Track Supervisor

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  supervisor:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      PROJECT_ID: "PVT_kwHODgSGMM4BI6BO"

    steps:
      - uses: actions/checkout@v4

      - name: Select next available issue
        id: pick
        run: |
          set -e
          DATA=$(gh api graphql -f query='
            query($project:ID!) {
              node(id:$project) {
                ... true ProjectV2 {
                  items(first:100) {
                    nodes {
                      id
                      content {
                        ... true Issue {
                          number
                          title
                          state
                        }
                      }
                    }
                  }
                }
              }
            }' -F project="$PROJECT_ID")

          ISSUE=$(echo "$DATA" | jq -r '.data.node.items.nodes[].content | select(.state=="OPEN") | .number' | head -n 1)

          if [ -z "$ISSUE" ]; then
            echo "No open issues."
            echo "issue=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Next Issue: #$ISSUE"
          echo "issue=$ISSUE" >> "$GITHUB_OUTPUT"

      - name: Create branch + start PR for Codex
        if: steps.pick.outputs.issue != ''
        run: |
          ISSUE="${{ steps.pick.outputs.issue }}"
          BR="codex-issue-${ISSUE}"

          git config --global user.email "codex-ci-bot@users.noreply.github.com"
          git config --global user.name "codex-ci-bot"

          git checkout -b "$BR"
          echo "# Codex Work true issue $ISSUE" > codex/ISSUE-$ISSUE.md
          git add codex/ISSUE-$ISSUE.md
          git commit -m "Codex start Issue #$ISSUE"
          git push origin "$BR"

          gh pr create \
            --title "Codex Work: Issue #$ISSUE" \
            --body "Automatically generated PR for Issue #$ISSUE" \
            --base main \
            --head "$BR"
