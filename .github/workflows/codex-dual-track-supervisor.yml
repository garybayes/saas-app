name: Codex Dual-Track Supervisor

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'GitHub issue number to start work on'
        required: true
        type: string
      track:
        description: 'Track: a = Core / Backend, b = Dashboard / Telemetry'
        required: true
        type: choice
        options:
          - a
          - b

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  dual-track:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      OWNER: garybayes
      REPO: saas-app
      PROJECT_ID: PVT_kwHODgSGMM4BI6BO

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------
      # 1. Resolve issue, title, slug, and track
      # ----------------------------------------------------------
      - name: Resolve issue & track
        id: resolve
        run: |
          set -e

          ISSUE_NUMBER_INPUT="${{ inputs.issue_number }}"
          TRACK_INPUT="${{ inputs.track }}"

          # Strip anything non-numeric from issue number
          ISSUE_NUMBER=$(echo "$ISSUE_NUMBER_INPUT" | tr -dc '0-9')

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "Issue number could not be resolved from: $ISSUE_NUMBER_INPUT"
            exit 1
          fi

          if [ -z "$TRACK_INPUT" ]; then
            echo "Track input is required (a or b)."
            exit 1
          fi

          TRACK="$TRACK_INPUT"

          echo "Using ISSUE_NUMBER=$ISSUE_NUMBER"
          echo "Using TRACK=$TRACK"

          # Fetch title via GitHub API
          TITLE=$(gh api "/repos/$OWNER/$REPO/issues/$ISSUE_NUMBER" --jq '.title')
          if [ -z "$TITLE" ] || [ "$TITLE" = "null" ]; then
            echo "Failed to fetch issue title for #$ISSUE_NUMBER"
            exit 1
          fi

          # Build a safe slug from the title
          SLUG=$(printf "%s" "$TITLE" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//')

          echo "Issue title: $TITLE"
          echo "Slug: $SLUG"

          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "track=$TRACK" >> "$GITHUB_OUTPUT"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "slug=$SLUG" >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------------
      # 2. Setup git identity
      # ----------------------------------------------------------
      - name: Setup git identity
        run: |
          git config user.name "codex-ci-bot"
          git config user.email "codex-bot@users.noreply.github.com"

      # ----------------------------------------------------------
      # 3. Create branch and track marker file
      # ----------------------------------------------------------
      - name: Create track branch and marker file
        id: branch
        run: |
          set -e

          ISSUE_NUMBER="${{ steps.resolve.outputs.issue_number }}"
          TRACK="${{ steps.resolve.outputs.track }}"
          TITLE="${{ steps.resolve.outputs.title }}"
          SLUG="${{ steps.resolve.outputs.slug }}"

          # Uppercase track for display
          TRACK_UPPER=$(echo "$TRACK" | tr '[:lower:]' '[:upper:]')

          BRANCH="codex-track-${TRACK}-${ISSUE_NUMBER}-${SLUG}"

          echo "Creating branch: $BRANCH"

          git fetch origin main
          git checkout -b "$BRANCH" origin/main

          # Create track directory & marker file
          mkdir -p "codex/track-${TRACK}"
          FILE="codex/track-${TRACK}/issue-${ISSUE_NUMBER}.md"

          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat > "$FILE" <<EOF
# Codex Track ${TRACK_UPPER} - Issue #${ISSUE_NUMBER}

- Title: ${TITLE}
- Track: ${TRACK_UPPER}
- Created by: Codex Dual-Track Supervisor workflow
- Last updated: ${NOW}

This file is a placeholder for Codex work on this issue.
It ensures non-empty commits and provides an anchor for future edits.
EOF

          git add "$FILE"
          git commit -m "Codex Track ${TRACK_UPPER}: start work on #${ISSUE_NUMBER}"
          git push origin "$BRANCH"

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------------
      # 4. Open PR linked to the issue
      # ----------------------------------------------------------
      - name: Open Pull Request
        id: pr
        run: |
          ISSUE_NUMBER="${{ steps.resolve.outputs.issue_number }}"
          TRACK="${{ steps.resolve.outputs.track }}"
          TITLE="${{ steps.resolve.outputs.title }}"
          BRANCH="${{ steps.branch.outputs.branch }}"

          TRACK_UPPER=$(echo "$TRACK" | tr '[:lower:]' '[:upper:]')

          PR_TITLE="Codex Track ${TRACK_UPPER}: #${ISSUE_NUMBER} ${TITLE}"
          PR_BODY="Automated Codex Dual-Track PR for issue #${ISSUE_NUMBER}.

Track: ${TRACK_UPPER}
Linked issue: #${ISSUE_NUMBER}

This PR was created by the Codex Dual-Track Supervisor workflow.
"

          echo "Creating PR from $BRANCH â†’ main"

          PR_URL=$(gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --label "codex" \
            --label "track-${TRACK}")

          echo "PR_URL=$PR_URL"
          echo "url=$PR_URL" >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------------
      # 5. Add PR to Codex Dual-Track Development project
      # ----------------------------------------------------------
      - name: Add PR to Codex project
        run: |
          set -e

          PR_URL="${{ steps.pr.outputs.url }}"
          if [ -z "$PR_URL" ]; then
            echo "No PR URL found; skipping project insertion."
            exit 0
          fi

          # Extract PR number
          PR_NUMBER=$(echo "$PR_URL" | sed 's#.*/pull/##')

          echo "PR number: $PR_NUMBER"

          # Get PR node ID
          PR_NODE_ID=$(gh api graphql -f query='
            query($owner:String!, $repo:String!, $num:Int!) {
              repository(owner:$owner, name:$repo) {
                pullRequest(number:$num) { id }
              }
            }' \
            -F owner="$OWNER" \
            -F repo="$REPO" \
            -F num="$PR_NUMBER" \
            --jq '.data.repository.pullRequest.id')

          if [ -z "$PR_NODE_ID" ] || [ "$PR_NODE_ID" = "null" ]; then
            echo "Failed to resolve PR node ID."
            exit 1
          fi

          echo "PR node ID: $PR_NODE_ID"

          # Add to ProjectV2
          gh api graphql -f query='
            mutation($project:ID!, $item:ID!) {
              addProjectV2ItemById(input:{projectId:$project, contentId:$item}) {
                item { id }
              }
            }
          ' \
          -F project="$PROJECT_ID" \
          -F item="$PR_NODE_ID"

          echo "PR added to Codex Dual-Track Development project."
