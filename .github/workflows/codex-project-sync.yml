---
name: Codex Project Sync (v9.8)

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"   # every 4 hours
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare telemetry directory
        run: mkdir -p gh-pages/telemetry/project-sync

      - name: Sync Codex Issues
        id: sync
        working-directory: repo
        run: |
          set -euo pipefail

          echo "Loading Codex milestone configuration from repo variables..."

          MAIN_MS=$(gh variable get CODEX_MAIN_MILESTONE -q 2>/dev/null || echo "")
          DASH_MS=$(gh variable get CODEX_DASHBOARD_MILESTONE -q 2>/dev/null || echo "")
          SELFTEST_MS=$(gh variable get CODEX_SELFTEST_MILESTONE -q 2>/dev/null || echo "")

          echo "Milestones:"
          echo "  MAIN_MS      = ${MAIN_MS:-<missing>}"
          echo "  DASH_MS      = ${DASH_MS:-<missing>}"
          echo "  SELFTEST_MS  = ${SELFTEST_MS:-<missing>}"

          if [ -z "$MAIN_MS" ] || [ -z "$DASH_MS" ] || [ -z "$SELFTEST_MS" ]; then
            echo "ERROR: One or more Codex milestone variables are missing."
            echo "Expected repo variables:"
            echo "  CODEX_MAIN_MILESTONE"
            echo "  CODEX_DASHBOARD_MILESTONE"
            echo "  CODEX_SELFTEST_MILESTONE"
            exit 1
          fi

          echo "Fetching Codex issues..."
          raw="$(gh api "/repos/$GITHUB_REPOSITORY/issues?state=all&labels=codex&per_page=100")"

          echo "$raw" | jq -c '.[]' | while read -r issue; do
            num=$(echo "$issue" | jq -r '.number')
            title=$(echo "$issue" | jq -r '.title')
            labels=$(echo "$issue" | jq -r '.labels[].name')
            current_ms=$(echo "$issue" | jq -r '.milestone.number // empty')

            echo ""
            echo "#$num: $title"

            IS_SELFTEST=$(echo "$labels" | grep -q '^codex-selftest$' && echo true || echo false)
            IS_MAIN=$(echo "$labels" | grep -q '^codex-trackmain$' && echo true || echo false)
            IS_DASH=$(echo "$labels" | grep -q '^codex-trackdashboard$' && echo true || echo false)

            if [[ "$IS_SELFTEST" == "true" ]]; then
              TARGET="$SELFTEST_MS"
              echo " → Self-test → milestone $TARGET"

            elif [[ "$IS_MAIN" == "true" ]]; then
              TARGET="$MAIN_MS"
              echo " → Main track → milestone $TARGET"

            elif [[ "$IS_DASH" == "true" ]]; then
              TARGET="$DASH_MS"
              echo " → Dashboard track → milestone $TARGET"

            else
              echo " → Trackless Codex issue → leaving milestone empty, adding needs-attention"
              gh issue edit "$num" --add-label "needs-attention"
              continue
            fi

            if [[ -z "$TARGET" ]]; then
              echo " ❌ ERROR: Target milestone EMPTY — refusing to set milestone."
              continue
            fi

            if [[ "$current_ms" != "$TARGET" ]]; then
              echo " → Updating milestone from '$current_ms' → '$TARGET'"
              gh issue edit "$num" --milestone "$TARGET"
            else
              echo " → Milestone already correct"
            fi
          done

          echo "sync_status=ok" >> "$GITHUB_OUTPUT"

      - name: Write Telemetry
        if: always()
        run: |
          mkdir -p gh-pages/telemetry/project-sync
          outfile="gh-pages/telemetry/project-sync/sync-$(date -u +"%Y%m%dT%H%M%SZ").json"
          {
            printf '{\n'
            printf '  "component": "project-sync",\n'
            printf '  "timestamp": "%s",\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            printf '  "status": "%s"\n' "${{ steps.sync.outputs.sync_status || 'failed' }}"
            printf '}\n'
          } > "$outfile"

      - name: Commit & Push Telemetry
        if: always()
        working-directory: gh-pages
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/project-sync/*.json || true
          git commit -m "Codex Project Sync telemetry update" || exit 0
          git push origin gh-pages
