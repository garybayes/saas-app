---
name: "Codex Project Sync (v9.3)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"  # every 4 hours
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write
  metadata: read

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}  # required for API calls

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Start sync
        run: |
          set -euo pipefail
          echo "Running Codex Project Sync v9.3 for $GITHUB_REPOSITORY"

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          # ------------------------------------------------------------
          # 1. Load milestone numbers from repo variables
          # ------------------------------------------------------------
          MS_MAIN=$(gh variable get CODEX_MAIN_MILESTONE --repo "$OWNER/$REPO" --jq '.value')
          MS_DASH=$(gh variable get CODEX_DASHBOARD_MILESTONE --repo "$OWNER/$REPO" --jq '.value')

          echo "Using milestones:"
          echo "  Main      : $MS_MAIN"
          echo "  Dashboard : $MS_DASH"

          # ------------------------------------------------------------
          # 2. Convert milestone numbers → milestone titles
          # ------------------------------------------------------------
          MS_MAIN_TITLE=$(gh api "/repos/$OWNER/$REPO/milestones/$MS_MAIN" --jq '.title' || echo "")
          MS_DASH_TITLE=$(gh api "/repos/$OWNER/$REPO/milestones/$MS_DASH" --jq '.title' || echo "")

          if [ -z "$MS_MAIN_TITLE" ] || [ -z "$MS_DASH_TITLE" ]; then
            echo "❌ ERROR: One or more milestone titles could not be resolved."
            echo "Main=$MS_MAIN_TITLE | Dashboard=$MS_DASH_TITLE"
            exit 1
          fi

          echo "Resolved titles:"
          echo "  Main      : $MS_MAIN_TITLE"
          echo "  Dashboard : $MS_DASH_TITLE"

          # ------------------------------------------------------------
          # 3. Fetch codex issues (all states)
          # ------------------------------------------------------------
          echo "Fetching codex issues…"

          issues_json=$(gh api "/repos/$OWNER/$REPO/issues?state=all&labels=codex&per_page=100")

          echo "$issues_json" | jq -cr '.[] | [.number, .title] | @tsv' | \
          while IFS=$'\t' read -r NUM TITLE; do
            echo "#$NUM: $TITLE"

            # ----------------------------------------------------------------
            # 4. Determine track from labels
            # ----------------------------------------------------------------
            TRACK="main"
            LABELS=$(echo "$issues_json" | jq -r ".[] | select(.number==$NUM) | .labels[].name")

            if echo "$LABELS" | grep -q "codex-trackdashboard"; then
              TRACK="dashboard"
            fi

            # Map track → milestone title
            TARGET_MS_TITLE="$MS_MAIN_TITLE"
            if [ "$TRACK" = "dashboard" ]; then
              TARGET_MS_TITLE="$MS_DASH_TITLE"
            fi

            echo " → Track = $TRACK → Milestone = $TARGET_MS_TITLE"

            # ----------------------------------------------------------------
            # 5. Update the issue
            # ----------------------------------------------------------------
            echo "   Updating issue #$NUM…"

            if ! gh issue edit "$NUM" \
                --repo "$OWNER/$REPO" \
                --milestone "$TARGET_MS_TITLE"; then
              echo "⚠ Failed to update #$NUM"
              continue
            fi

            echo "   Updated successfully."
          done

          echo "Project sync completed successfully."
