---
name: "Codex Project Sync (v9.2)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"  # every 4 hours
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  project-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Configure token
        run: |
          echo "Using GH_TOKEN (provided automatically by GitHub Actions)."
        env:
          GH_TOKEN: ${{ secrets.GH_CI_PAT }}

      - name: Run Project Sync
        working-directory: repo
        env:
          GH_TOKEN: ${{ secrets.GH_CI_PAT }}

        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          echo "Running Codex Project Sync v9.2 for $OWNER/$REPO"

          # ---------------------------------------------------------------------
          # Load milestone numbers from repo variables
          # ---------------------------------------------------------------------
          MAIN_MS=$(gh variable get CODEX_MAIN_MILESTONE --repo "$OWNER/$REPO" --json value --jq '.value')
          DASH_MS=$(gh variable get CODEX_DASHBOARD_MILESTONE --repo "$OWNER/$REPO" --json value --jq '.value')

          echo "Using milestones:"
          echo "  Main: $MAIN_MS"
          echo "  Dashboard: $DASH_MS"

          # ---------------------------------------------------------------------
          # Fetch codex issues
          # ---------------------------------------------------------------------
          echo "Fetching codex issues…"
          ISSUES=$(gh issue list \
            --label "codex" \
            --state all \
            --json number,title,labels,milestone \
            --repo "$OWNER/$REPO")

          if [[ "$ISSUES" == "[]" ]]; then
            echo "No codex issues found. Exiting."
            exit 0
          fi

          echo "$ISSUES" | jq -r '.[] | "#\(.number): \(.title)"'

          # ---------------------------------------------------------------------
          # Process each issue
          # ---------------------------------------------------------------------
          echo "$ISSUES" | jq -c '.[]' | while read -r ISSUE; do
            NUM=$(echo "$ISSUE"        | jq '.number')
            TITLE=$(echo "$ISSUE"      | jq -r '.title')
            MS=$(echo "$ISSUE"         | jq '.milestone.number // null')
            LABELS=$(echo "$ISSUE"     | jq -r '[.labels[].name]')

            echo ""
            echo "Processing #$NUM \"$TITLE\""

            # -----------------------------------------------------------------
            # Determine correct milestone
            # -----------------------------------------------------------------
            TARGET_MS="$MAIN_MS"   # default to main track

            if echo "$LABELS" | jq -e '.[] | select(. == "codex-trackdashboard")' >/dev/null; then
              TARGET_MS="$DASH_MS"
            fi

            if [[ "$MS" != "$TARGET_MS" ]]; then
              echo " → Updating milestone to $TARGET_MS"
              gh issue edit "$NUM" \
                --repo "$OWNER/$REPO" \
                --milestone "$TARGET_MS"
            else
              echo " ✓ Milestone correct"
            fi

            # -----------------------------------------------------------------
            # Fix malformed labels → MUST be an array
            # -----------------------------------------------------------------
            FIXED_LABELS=$(echo "$LABELS" | jq -r '.[]')
            echo " → Ensuring correct label array..."

            gh issue edit "$NUM" \
              --repo "$OWNER/$REPO" \
              $(printf -- "--label %s " $FIXED_LABELS)

          done

          # ---------------------------------------------------------------------
          # Write telemetry summary
          # ---------------------------------------------------------------------
          mkdir -p ../gh-pages/telemetry

          OUTFILE="../gh-pages/telemetry/project-sync-$(date -u +"%Y%m%dT%H%M%SZ").json"
          {
            printf '{\n'
            printf '  "component": "project-sync",\n'
            printf '  "timestamp": "%s",\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            printf '  "repository": "%s"\n' "$GITHUB_REPOSITORY"
            printf '}\n'
          } > "$OUTFILE"

          echo "Wrote telemetry: $OUTFILE"

      - name: Commit telemetry
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/*.json
          git commit -m "Project Sync telemetry update" || echo "No changes detected"
          git push origin gh-pages
