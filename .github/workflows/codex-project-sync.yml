---
# yamllint disable rule:truthy
name: Codex Project Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: write
  actions: read
  repository-projects: read
  issues: read

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # 1. Checkout MAIN for scripts
      # ---------------------------
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------
      # 2. Enable GitHub CLI
      # ---------------------------
      - name: Enable GitHub CLI
        run: gh --version
        env:
          GH_TOKEN: ${{ secrets.GH_CI_PAT }}

      # ---------------------------
      # 3. Fetch project items (with pagination)
      # ---------------------------
      - name: Collect project items
        id: collect
        env:
          GH_TOKEN: ${{ secrets.GH_CI_PAT }}
          PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}
        run: |
          QUERY='
          query($project: ID!, $after: String) {
            node(id: $project) {
              ... on ProjectV2 {
                items(first: 100, after: $after) {
                  pageInfo {
                    hasNextPage
                    endCursor
                  }
                  nodes {
                    id
                    content {
                      __typename
                      ... on Issue {
                        number
                        title
                        labels(first: 20) {
                          nodes { name }
                        }
                      }
                    }
                  }
                }
              }
            }
          }'

          items=()
          after_param=()

          while true; do
            if [[ -z "${after_param[*]}" ]]; then
              json=$(gh api graphql -f project="$PROJECT_ID" -f query="$QUERY")
            else
              json=$(gh api graphql -f project="$PROJECT_ID" -f query="$QUERY" -f after="${after_param[0]}")
            fi

            # Extract item nodes
            new_nodes=$(echo "$json" | jq -c '.data.node.items.nodes[]?')
            if [[ -n "$new_nodes" ]]; then
              while IFS= read -r item; do
                items+=("$item")
              done <<< "$new_nodes"
            fi

            hasNext=$(echo "$json" | jq '.data.node.items.pageInfo.hasNextPage')
            endCursor=$(echo "$json" | jq -r '.data.node.items.pageInfo.endCursor')

            echo "Collected ${#items[@]} items so far..."

            if [[ "$hasNext" != "true" ]]; then
              break
            fi

            after_param=("$endCursor")
          done

          echo "Total items collected: ${#items[@]}"

          # Write array to file
          printf '%s\n' "${items[@]}" | jq -s '.' > project_items.json

      # ---------------------------
      # 4. Checkout GH-PAGES
      # ---------------------------
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      # ---------------------------
      # 5. Ensure project_items.json exists
      # ---------------------------
      - name: Verify output file
        run: |
          if [[ ! -f "project_items.json" ]]; then
            echo "::error::project_items.json missing after checkout switch"
            exit 1
          fi

      # ---------------------------
      # 6. Commit updated file
      # ---------------------------
      - name: Commit project_items.json to gh-pages
        env:
          GH_TOKEN: ${{ secrets.GH_CI_PAT }}
        run: |
          git add project_items.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          git commit -m "[skip ci] Update project_items.json"
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" gh-pages
