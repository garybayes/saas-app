---
name: "Codex Project Sync (v9.5)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"  # every 4 hours
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  project_sync:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1. Checkout gh-pages (WITH GIT ENABLED — required for commits)
      # ------------------------------------------------------------
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0
          persist-credentials: false

      # ------------------------------------------------------------
      # 2. Checkout repository (source files)
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      # ------------------------------------------------------------
      # 3. Prepare telemetry output directory (self-healing)
      # ------------------------------------------------------------
      - name: Prepare telemetry directory
        run: |
          mkdir -p gh-pages/telemetry

      # ------------------------------------------------------------
      # 4. Load configuration
      # ------------------------------------------------------------
      - name: Load milestone + label configuration
        id: config
        run: |
          set -euo pipefail

          MAIN_MS="${CODEX_MAIN_MILESTONE:-}"
          DASH_MS="${CODEX_DASHBOARD_MILESTONE:-}"
          SELF_MS="${CODEX_SELFTEST_MILESTONE:-}"
          PROJECT_NUM="${CODEX_PROJECT_NUMBER:-}"

          echo "main_ms=$MAIN_MS" >> "$GITHUB_OUTPUT"
          echo "dash_ms=$DASH_MS" >> "$GITHUB_OUTPUT"
          echo "self_ms=$SELF_MS" >> "$GITHUB_OUTPUT"
          echo "project_num=$PROJECT_NUM" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # 5. Query codex issues
      # ------------------------------------------------------------
      - name: Fetch codex issues
        id: issues
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          echo "Fetching Codex issues from $OWNER/$REPO"

          # Search ONLY issues labeled "codex"
          ISSUES_JSON="$(gh api \
            "/repos/$OWNER/$REPO/issues?labels=codex&state=all&per_page=100")"

          echo "$ISSUES_JSON" > issues.json
          echo "Fetched $(jq length issues.json) Codex issues"

          echo "issues_json_path=issues.json" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # 6. Process issues — validate labels and milestone
      # ------------------------------------------------------------
      - name: Process Codex issues
        run: |
          set -euo pipefail

          MAIN_MS="${{ steps.config.outputs.main_ms }}"
          DASH_MS="${{ steps.config.outputs.dash_ms }}"
