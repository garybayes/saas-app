# yamllint disable rule:truthy
---
name: Codex Project Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:  # yamllint disable rule:truthy
  contents: read
  issues: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}
  PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}
  MAIN_MILESTONE: ${{ vars.CODEX_MAIN_MILESTONE }}
  DASHBOARD_MILESTONE: ${{ vars.CODEX_DASHBOARD_MILESTONE }}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4

      - name: Fetch project items with pagination
        id: fetch
        run: |
          echo "Fetching project items with pagination..."

          QUERY='
          query($project: ID!, $after: String) {
            node(id: $project) {
              ... on ProjectV2 {
                items(first: 100, after: $after) {
                  pageInfo {
                    hasNextPage
                    endCursor
                  }
                  nodes {
                    id
                    content {
                      __typename
                      ... on Issue {
                        number
                        title
                        labels(first: 20) {
                          nodes { name }
                        }
                      }
                    }
                  }
                }
              }
            }
          }'

          items=()
          after_param=()
          has_next=true

          while $has_next; do
            if [[ -z "${after_param[*]}" ]]; then
              json=$(gh api graphql -f project="$PROJECT_ID" -f query="$QUERY")
            else
              json=$(gh api graphql -f project="$PROJECT_ID" -f query="$QUERY" -f after="${after_param[0]}")
            fi

            # Extract issue items
            new_nodes=$(echo "$json" | jq -c '.data.node.items.nodes[]?')
            if [[ -n "$new_nodes" ]]; then
              while IFS= read -r item; do
                items+=("$item")
              done <<< "$new_nodes"
            fi

            echo "Collected ${#items[@]} items so far..."

            # Pagination status
            has_next=$(echo "$json" | jq '.data.node.items.pageInfo.hasNextPage')
            end_cursor=$(echo "$json" | jq -r '.data.node.items.pageInfo.endCursor')

            if [[ "$has_next" == "true" ]]; then
              after_param=("$end_cursor")
            fi
          done

          echo "Total items collected: ${#items[@]}"

          printf '%s\n' "${items[@]}" > project_items.json
          echo "items_file=project_items.json" >> "$GITHUB_OUTPUT"

      - name: Process project items and apply labels
        run: |
          FILE="${{ steps.fetch.outputs.items_file }}"

          if [[ ! -f "$FILE" ]]; then
            echo "::error::Project items file not found"
            exit 1
          fi

          echo "Processing project items..."

          jq -c '.' "$FILE" | while read -r item; do
            issue_number=$(echo "$item" | jq -r '.content.number')

            if [[ "$issue_number" == "null" ]]; then
              continue
            fi

            echo "Syncing Issue #$issue_number..."

            # Apply core Codex label
            gh issue edit "$issue_number" --add-label "codex" || true

            # Apply track labels
            gh issue edit "$issue_number" --add-label "codex-tracksprint" || true
            gh issue edit "$issue_number" --add-label "codex-trackdashboard" || true
          done

      - name: Done
        run: echo "Codex Project Sync Complete."
