---
name: Codex Project Sync (v9.7)

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare telemetry directory
        run: mkdir -p gh-pages/telemetry/project-sync

      - name: Load Milestone Configuration
        id: cfg
        run: |
          echo "main_ms=${CODEX_MAIN_MILESTONE:-}" >> $GITHUB_OUTPUT
          echo "dash_ms=${CODEX_DASHBOARD_MILESTONE:-}" >> $GITHUB_OUTPUT
          echo "selftest_ms=${CODEX_SELFTEST_MILESTONE:-}" >> $GITHUB_OUTPUT

      - name: Sync Codex Issues
        id: sync
        working-directory: repo
        env:
          MAIN_MS: ${{ steps.cfg.outputs.main_ms }}
          DASH_MS: ${{ steps.cfg.outputs.dash_ms }}
          SELFTEST_MS: ${{ steps.cfg.outputs.selftest_ms }}
        run: |
          set -euo pipefail

          echo "Milestones:"
          echo "  MAIN_MS      = $MAIN_MS"
          echo "  DASH_MS      = $DASH_MS"
          echo "  SELFTEST_MS  = $SELFTEST_MS"

          raw="$(gh api "/repos/$GITHUB_REPOSITORY/issues?state=all&labels=codex&per_page=100")"

          echo "$raw" | jq -c '.[]' | while read -r issue; do
            num=$(echo "$issue" | jq -r '.number')
            title=$(echo "$issue" | jq -r '.title')
            labels=$(echo "$issue" | jq -r '.labels[].name')
            current_ms=$(echo "$issue" | jq -r '.milestone.number // empty')

            echo ""
            echo "#$num: $title"

            IS_SELFTEST=$(echo "$labels" | grep -q '^codex-selftest$' && echo true || echo false)
            IS_MAIN=$(echo "$labels" | grep -q '^codex-trackmain$' && echo true || echo false)
            IS_DASH=$(echo "$labels" | grep -q '^codex-trackdashboard$' && echo true || echo false)

            if [[ "$IS_SELFTEST" == "true" ]]; then
              TARGET="$SELFTEST_MS"
              echo " → Self-test → milestone $TARGET"

            elif [[ "$IS_MAIN" == "true" ]]; then
              TARGET="$MAIN_MS"
              echo " → Main → milestone $TARGET"

            elif [[ "$IS_DASH" == "true" ]]; then
              TARGET="$DASH_MS"
              echo " → Dashboard → milestone $TARGET"

            else
              echo " → Codex-only trackless → Leaving unassigned, marking needs-attention"
              gh issue edit "$num" --add-label "needs-attention"
              continue
            fi

            if [[ -z "$TARGET" ]]; then
              echo " ❌ ERROR: Target milestone EMPTY — refusing to set milestone."
              continue
            fi

            if [[ "$current_ms" != "$TARGET" ]]; then
              echo " → Updating milestone from '$current_ms' → '$TARGET'"
              gh issue edit "$num" --milestone "$TARGET"
            else
              echo " → Milestone already correct"
            fi
          done

          echo "sync_status=ok" >> $GITHUB_OUTPUT

      - name: Write Telemetry
        if: always()
        run: |
          mkdir -p gh-pages/telemetry/project-sync
          outfile="gh-pages/telemetry/project-sync/sync-$(date -u +"%Y%m%dT%H%M%SZ").json"
          echo '{"component":"project-sync","status":"completed"}' > "$outfile"

      - name: Push Telemetry
        if: always()
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/project-sync/*.json || true
          git commit -m "Project Sync telemetry update" || exit 0
          git push origin gh-pages
