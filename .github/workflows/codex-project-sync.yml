---
name: Codex Project Sync (v9)

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"  # every 4 hours, offset from supervisor
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write
  repository-projects: write

jobs:
  project-sync:
    runs-on: ubuntu-latest
    name: Codex Project Sync

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      CODEX_MAIN_MILESTONE: ${{ vars.CODEX_MAIN_MILESTONE }}
      CODEX_DASHBOARD_MILESTONE: ${{ vars.CODEX_DASHBOARD_MILESTONE }}

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Validate GitHub token
        shell: bash
        run: |
          set -e

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "ERROR: GH_TOKEN (from GH_CI_PAT) is missing."
            exit 1
          fi

          echo "Validating GitHub API authentication..."
          if ! gh api rate_limit >/dev/null 2>&1; then
            echo "ERROR: GitHub API authentication failed with GH_TOKEN."
            exit 1
          fi

          echo "GitHub API authentication OK."

      - name: Run Codex Project Sync
        shell: bash
        working-directory: repo
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          echo "Running Codex Project Sync v9 for $OWNER/$REPO"

          main_ms="${CODEX_MAIN_MILESTONE:-}"
          dash_ms="${CODEX_DASHBOARD_MILESTONE:-}"

          if [ -z "$main_ms" ] || [ -z "$dash_ms" ]; then
            echo "ERROR: CODEX_MAIN_MILESTONE or CODEX_DASHBOARD_MILESTONE is not set."
            exit 1
          fi

          echo "Using milestones:"
          echo "  Main      : $main_ms"
          echo "  Dashboard : $dash_ms"

          echo "Fetching Codex issues..."
          issues_json="$(
            gh api \
              --paginate \
              -H "Accept: application/vnd.github+json" \
              "/repos/$OWNER/$REPO/issues" \
              -f state=all \
              -f labels=codex \
              -f per_page=100
          )"

          if [ -z "$issues_json" ] || [ "$issues_json" = "[]" ]; then
            echo "No Codex issues found. Nothing to sync."
            exit 0
          fi

          fixed_main=0
          fixed_dash=0
          skipped_no_ms=0
          unchanged=0

          echo "$issues_json" | jq -rc '
            .[]
            | {
                number,
                state,
                milestone: (.milestone.number // null),
                labels: [ .labels[].name ]
              }
          ' | while read -r row; do
            number=$(echo "$row" | jq -r '.number')
            state=$(echo "$row" | jq -r '.state')
            milestone=$(echo "$row" | jq -r '.milestone // empty')
            labels_json=$(echo "$row" | jq -c '.labels')

            has_main=$(echo "$labels_json" | jq -e 'index("codex-trackmain")' >/dev/null 2>&1 && echo "yes" || echo "no")
            has_dash=$(echo "$labels_json" | jq -e 'index("codex-trackdashboard")' >/dev/null 2>&1 && echo "yes" || echo "no")

            # Closed issues are left untouched (for now) to avoid rewriting history
            if [ "$state" = "closed" ]; then
              echo "Issue #$number is closed; leaving track labels unchanged."
              unchanged=$((unchanged + 1))
              continue
            fi

            if [ -z "${milestone:-}" ]; then
              echo "Issue #$number has no milestone; skipping track alignment."
              skipped_no_ms=$((skipped_no_ms + 1))
              continue
            fi

            echo "Processing issue #$number (milestone=$milestone, main=$main_ms, dash=$dash_ms)"

            add_label=""
            remove_label=""

            if [ "$milestone" = "$main_ms" ]; then
              # Main track should have codex-trackmain only
              if [ "$has_main" = "no" ]; then
                add_label="codex-trackmain"
              fi
              if [ "$has_dash" = "yes" ]; then
                remove_label="codex-trackdashboard"
              fi
              if [ -n "$add_label" ] || [ -n "$remove_label" ]; then
                echo "→ Aligning #$number to MAIN track"
                if [ -n "$add_label" ] && [ -n "$remove_label" ]; then
                  gh issue edit "$number" \
                    --add-label "$add_label" \
                    --remove-label "$remove_label"
                elif [ -n "$add_label" ]; then
                  gh issue edit "$number" --add-label "$add_label"
                elif [ -n "$remove_label" ]; then
                  gh issue edit "$number" --remove-label "$remove_label"
                fi
                fixed_main=$((fixed_main + 1))
              else
                unchanged=$((unchanged + 1))
              fi
            elif [ "$milestone" = "$dash_ms" ]; then
              # Dashboard track should have codex-trackdashboard only
              if [ "$has_dash" = "no" ]; then
                add_label="codex-trackdashboard"
              fi
              if [ "$has_main" = "yes" ]; then
                remove_label="codex-trackmain"
              fi
              if [ -n "$add_label" ] || [ -n "$remove_label" ]; then
                echo "→ Aligning #$number to DASHBOARD track"
                if [ -n "$add_label" ] && [ -n "$remove_label" ]; then
                  gh issue edit "$number" \
                    --add-label "$add_label" \
                    --remove-label "$remove_label"
                elif [ -n "$add_label" ]; then
                  gh issue edit "$number" --add-label "$add_label"
                elif [ -n "$remove_label" ]; then
                  gh issue edit "$number" --remove-label "$remove_label"
                fi
                fixed_dash=$((fixed_dash + 1))
              else
                unchanged=$((unchanged + 1))
              fi
            else
              echo "Issue #$number in non-Codex milestone ($milestone); leaving track labels unchanged."
              unchanged=$((unchanged + 1))
            fi
          done

          echo "Codex Project Sync summary:"
          echo "  Main track updates     : $fixed_main"
          echo "  Dashboard track updates: $fixed_dash"
          echo "  Skipped (no milestone) : $skipped_no_ms"
          echo "  Unchanged              : $unchanged"

          # Write telemetry in gh-pages/telemetry
          ts="$(date -u +"%Y%m%dT%H%M%SZ")"
          outdir="../gh-pages/telemetry"
          mkdir -p "$outdir"
          outfile="$outdir/project-sync-$ts.json"

          {
            printf '{\n'
            printf '  "component": "project-sync",\n'
            printf '  "timestamp": "%s",\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            printf '  "repository": "%s",\n' "$GITHUB_REPOSITORY"
            printf '  "main_milestone": "%s",\n' "$main_ms"
            printf '  "dashboard_milestone": "%s",\n' "$dash_ms"
            printf '  "stats": {\n'
            printf '    "fixed_main": %s,\n' "$fixed_main"
            printf '    "fixed_dashboard": %s,\n' "$fixed_dash"
            printf '    "skipped_no_milestone": %s,\n' "$skipped_no_ms"
            printf '    "unchanged": %s\n' "$unchanged"
            printf '  }\n'
            printf '}\n'
          } > "$outfile"

          echo "Wrote project sync telemetry to: $outfile"

      - name: Commit telemetry
        shell: bash
        working-directory: gh-pages
        run: |
          set -e

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/*.json || true
          git commit -m "Codex Project Sync telemetry update" || echo "No changes"
          git push origin gh-pages || true
