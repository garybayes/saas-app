# yamllint disable rule:truthy
---
name: Codex Project Sync

on:
  schedule:
    - cron: "*/30 * * * *"   # Every 30 minutes
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  repository-projects: write

jobs:
  sync:
    name: Sync Issues with Codex Project Board
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}
      PROJECT_NUMBER: ${{ vars.CODEX_PROJECT_NUMBER }}
      MAIN_MILESTONE: ${{ vars.CODEX_MAIN_MILESTONE }}
      DASHBOARD_MILESTONE: ${{ vars.CODEX_DASHBOARD_MILESTONE }}

    steps:
      # -----------------------------------------------------------
      # 1. Setup
      # -----------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # -----------------------------------------------------------
      # 2. Pull all project items
      # -----------------------------------------------------------
      - name: Fetch project items from API
        id: project
        run: |
          echo "Querying project items..."

          JSON=$(gh api graphql -f query='
            query($id: ID!) {
              node(id: $id) {
                ... on ProjectV2 {
                  items(first: 200) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          number
                          title
                          milestone { title }
                          labels(first: 20) {
                            nodes { name }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f id="$PROJECT_ID")

          echo "$JSON" > project.json
          echo "project_json=project.json" >> "$GITHUB_OUTPUT"

      # -----------------------------------------------------------
      # 3. Iterate over items and verify consistency
      # -----------------------------------------------------------
      - name: Process project items
        id: validation
        run: |
          FILE="${{ steps.project.outputs.project_json }}"

          echo "Validating project items..."

          ITEMS=$(jq -c '.data.node.items.nodes[]' "$FILE")

          MISSING_COUNT=0
          FIXED_COUNT=0

          while IFS= read -r ITEM; do
            ISSUE=$(jq -r '.content.number' <<< "$ITEM")

            if [[ "$ISSUE" == "null" ]]; then
              echo "→ Found non-issue project item. Removing..."
              ITEM_ID=$(jq -r '.id' <<< "$ITEM")

              gh api graphql -f query='
                mutation($id: ID!) {
                  deleteProjectV2Item(input: {itemId: $id}) {
                    deletedItemId
                  }
                }
              ' -f id="$ITEM_ID"

              continue
            fi

            TITLE=$(jq -r '.content.title' <<< "$ITEM")
            MILESTONE=$(jq -r '.content.milestone.title // empty' <<< "$ITEM")

            LABELS=$(jq -r '.content.labels.nodes[].name' <<< "$ITEM" || true)

            echo "Issue #$ISSUE — $TITLE"
            echo "  Milestone: $MILESTONE"
            echo "  Labels: $LABELS"

            # ---------------------------------------
            # Ensure required labels exist
            # ---------------------------------------
            if [[ "$MILESTONE" == "$MAIN_MILESTONE" && "$LABELS" != *"main-track"* ]]; then
              echo "  → Adding missing main-track label"
              gh issue edit "$ISSUE" --add-label "main-track"
              ((FIXED_COUNT++))
            fi

            if [[ "$MILESTONE" == "$DASHBOARD_MILESTONE" && "$LABELS" != *"dashboard-track"* ]]; then
              echo "  → Adding missing dashboard-track label"
              gh issue edit "$ISSUE" --add-label "dashboard-track"
              ((FIXED_COUNT++))
            fi

            if [[ "$LABELS" != *"codex"* ]]; then
              echo "  → Adding missing codex label"
              gh issue edit "$ISSUE" --add-label "codex"
              ((FIXED_COUNT++))
            fi

          done <<< "$ITEMS"

          echo "fixed=$FIXED_COUNT" >> "$GITHUB_OUTPUT"
          echo "missing=$MISSING_COUNT" >> "$GITHUB_OUTPUT"

      # -----------------------------------------------------------
      # 4. Write telemetry snapshot
      # -----------------------------------------------------------
      - name: Write project telemetry snapshot
        run: |
          SNAPSHOT="project-telemetry/project-$(date +%s).json"
          mkdir -p project-telemetry

          jq '.' project.json > "$SNAPSHOT"

          echo "Created telemetry: $SNAPSHOT"

      # -----------------------------------------------------------
      # 5. Summary
      # -----------------------------------------------------------
      - name: Sync Summary
        run: |
          echo "---------------------------------------"
          echo "Codex Project Sync Completed"
          echo "Fixed labels: ${{ steps.validation.outputs.fixed }}"
          echo "---------------------------------------"
