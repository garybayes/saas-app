---
name: "Codex Project Sync (v9.4)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"  # every 4 hours
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

env:
  CODEX_COMPONENT: projectsync
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Run Codex Project Sync
        id: sync
        working-directory: repo
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          main_ms=$(gh variable get CODEX_MAIN_MILESTONE --repo "$OWNER/$REPO" --jq '.value')
          dash_ms=$(gh variable get CODEX_DASHBOARD_MILESTONE --repo "$OWNER/$REPO" --jq '.value')

          echo "Main milestone: $main_ms"
          echo "Dashboard milestone: $dash_ms"

          issues=$(gh api "/repos/$OWNER/$REPO/issues" \
            -f labels="codex" \
            -f state="open" \
            -f per_page=100)

          count=$(echo "$issues" | jq 'length')
          echo "Found $count Codex issues"

          declare -a updated=()

          for i in $(seq 0 $((count - 1))); do
            number=$(echo "$issues" | jq -r ".[$i].number")
            title=$(echo "$issues" | jq -r ".[$i].title")
            labels=$(echo "$issues" | jq -r ".[$i].labels[].name")

            echo "Processing #$number $title"

            has_main=false
            has_dash=false

            if echo "$labels" | grep -q "codex-trackmain"; then
              has_main=true
            fi
            if echo "$labels" | grep -q "codex-trackdashboard"; then
              has_dash=true
            fi

            # prevent contamination
            if [ "$has_main" = true ] && [ "$has_dash" = true ]; then
              echo " → Removing dashboard label from mixed-track issue"
              gh api --method PATCH "/repos/$OWNER/$REPO/issues/$number" \
                -f labels='["codex","codex-trackmain"]'
              updated+=("$number")
              continue
            fi

            if [ "$has_main" = true ]; then
              echo " → Setting milestone to MAIN ($main_ms)"
              gh api --method PATCH "/repos/$OWNER/$REPO/issues/$number" \
                -f milestone="$main_ms"
              updated+=("$number")
            elif [ "$has_dash" = true ]; then
              echo " → Setting milestone to DASHBOARD ($dash_ms)"
              gh api --method PATCH "/repos/$OWNER/$REPO/issues/$number" \
                -f milestone="$dash_ms"
              updated+=("$number")
            fi
          done

          echo "updated=$(printf '%s\n' "${updated[@]:-}" | jq -R . | jq -s .)" \
            >> "$GITHUB_OUTPUT"

      - name: Write Telemetry (Always-On)
        if: always()
        working-directory: gh-pages
        run: |
          mkdir -p telemetry
          ts="$(date -u +"%Y%m%dT%H%M%SZ")"
          outfile="telemetry/projectsync-$ts.json"

          {
            printf '{\n'
            printf '  "component": "projectsync",\n'
            printf '  "timestamp": "%s",\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            printf '  "updated": %s,\n' '${{ steps.sync.outputs.updated }}'
            printf '  "repository": "%s"\n' "$GITHUB_REPOSITORY"
            printf '}\n'
          } > "$outfile"

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/*.json
          git commit -m "Project Sync telemetry update" || echo "No changes"
          git push origin gh-pages
