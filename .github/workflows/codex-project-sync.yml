---
name: Codex Project Sync (v9.6)

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"   # every 4 hours
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Load repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare telemetry directory
        run: mkdir -p gh-pages/telemetry/project-sync

      - name: Load Milestone Configuration
        id: cfg
        run: |
          echo "MAIN_MS=${CODEX_MAIN_MILESTONE:-}" >> $GITHUB_OUTPUT
          echo "DASH_MS=${CODEX_DASHBOARD_MILESTONE:-}" >> $GITHUB_OUTPUT
          echo "SELFTEST_MS=${CODEX_SELFTEST_MILESTONE:-}" >> $GITHUB_OUTPUT

      - name: Sync Codex Issues
        id: sync
        working-directory: repo
        run: |
          set -euo pipefail

          MAIN_MS="${{ steps.cfg.outputs.MAIN_MS }}"
          DASH_MS="${{ steps.cfg.outputs.DASH_MS }}"
          SELFTEST_MS="${{ steps.cfg.outputs.SELFTEST_MS }}"

          echo "Using milestones:"
          echo "  Main      = $MAIN_MS"
          echo "  Dashboard = $DASH_MS"
          echo "  SelfTest  = $SELFTEST_MS"

          # Fetch only Codex-labeled issues
          raw="$(gh api "/repos/$GITHUB_REPOSITORY/issues?state=all&labels=codex&per_page=100")"

          echo "$raw" | jq -c '.[]' | while read -r issue; do
            num=$(echo "$issue" | jq -r '.number')
            title=$(echo "$issue" | jq -r '.title')
            labels=$(echo "$issue" | jq -r '.labels[].name')
            current_ms=$(echo "$issue" | jq -r '.milestone.number // empty')

            echo ""
            echo "#$num: $title"

            # Classify issue type
            IS_SELFTEST=$(echo "$labels" | grep -q '^codex-selftest$' && echo true || echo false)
            IS_MAIN=$(echo "$labels" | grep -q '^codex-trackmain$' && echo true || echo false)
            IS_DASH=$(echo "$labels" | grep -q '^codex-trackdashboard$' && echo true || echo false)

            # === ROUTING LOGIC ===

            if [[ "$IS_SELFTEST" == "true" ]]; then
              TARGET="$SELFTEST_MS"
              echo " → Self-test issue → milestone $TARGET"

            elif [[ "$IS_MAIN" == "true" ]]; then
              TARGET="$MAIN_MS"
              echo " → Main track → milestone $TARGET"

            elif [[ "$IS_DASH" == "true" ]]; then
              TARGET="$DASH_MS"
              echo " → Dashboard track → milestone $TARGET"

            else
              # codex-only, trackless
              echo " → Trackless Codex issue: NO milestone will be assigned."
              echo " → Adding needs-attention label."
              gh issue edit "$num" --add-label "needs-attention"
              continue
            fi

            # Only update if milestone differs
            if [[ "$current_ms" != "$TARGET" ]]; then
              echo " → Updating milestone from '$current_ms' to '$TARGET'"
              gh issue edit "$num" --milestone "$TARGET"
            else
              echo " → Milestone already correct"
            fi

          done

          echo "sync_status=ok" >> "$GITHUB_OUTPUT"

      - name: Write Telemetry Record
        if: always()
        run: |
          mkdir -p gh-pages/telemetry/project-sync
          outfile="gh-pages/telemetry/project-sync/sync-$(date -u +"%Y%m%dT%H%M%SZ").json"

          echo "Writing telemetry → $outfile"
          {
            echo '{'
            echo '  "component": "project-sync",'
            echo '  "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",'
            echo '  "status": "'${{ steps.sync.outputs.sync_status || 'failed' }}'"'
            echo '}'
          } > "$outfile"

      - name: Commit & Push Telemetry
        if: always()
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/project-sync/*.json || true
          git commit -m "Codex Project Sync telemetry update" || exit 0
          git push origin gh-pages
