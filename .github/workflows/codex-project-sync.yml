# yamllint disable rule:truthy
---
name: Codex Project Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"  # every 30 minutes

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}
  PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}
  MAIN_MILESTONE: ${{ vars.CODEX_MAIN_MILESTONE }}
  DASHBOARD_MILESTONE: ${{ vars.CODEX_DASHBOARD_MILESTONE }}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch all project items (with pagination)
        id: fetch
        run: |
          echo "Fetching project items with pagination..."

          QUERY='
          query($project: ID!, $after: String) {
            node(id: $project) {
              ... on ProjectV2 {
                items(first: 100, after: $after) {
                  pageInfo {
                    hasNextPage
                    endCursor
                  }
                  nodes {
                    id
                    content {
                      __typename
                      ... on Issue {
                        number
                        title
                        labels(first: 20) {
                          nodes { name }
                        }
                      }
                    }
                  }
                }
              }
            }
          }'

          items=()
          after_param=()   # empty array for first request (no after)
          has_next=true

          while $has_next; do
          # Build dynamic arguments
            if [[ -z "${after_param[*]}" ]]; then
              json=$(gh api graphql -f project="$PROJECT_ID" -f query="$QUERY")
            else
              json=$(gh api graphql -f project="$PROJECT_ID" -f query="$QUERY" -f after="${after_param[0]}")
            fi

            # Extract nodes
            new_nodes=$(echo "$json" | jq -c '.data.node.items.nodes[]?')
            if [[ -n "$new_nodes" ]]; then
              while IFS= read -r item; do
                items+=("$item")
              done <<< "$new_nodes"
            fi

            echo "Collected ${#items[@]} items so far..."

            # Pagination state
            has_next=$(echo "$json" | jq '.data.node.items.pageInfo.hasNextPage')
            end_cursor=$(echo "$json" | jq -r '.data.node.items.pageInfo.endCursor')

            if [[ "$has_next" == "true" ]]; then
              after_param=("$end_cursor")
            fi
          done

          echo "Total items collected: ${#items[@]}"
          printf '%s\n' "${items[@]}" > project_items.json
          echo "items_file=project_items.json" >> "$GITHUB_OUTPUT"          items=()

      - name: Process project items and apply Codex labels
        run: |
          FILE="${{ steps.fetch.outputs.items_file }}"

          if [[ ! -f "$FILE" ]]; then
            echo "::error::No project items file found."
            exit 1
          fi

          echo "Processing project items..."

          jq -c '.' "$FILE" | while read item; do
            issue_number=$(echo "$item" | jq -r '.content.number')

            if [[ "$issue_number" == "null" ]]; then
              continue
            fi

            echo "Processing Issue #$issue_number..."

            # Determine labels based on milestones
            LABEL_MAIN="codex-tracksprint"
            LABEL_DASH="codex-trackdashboard"

            # Apply labels
            echo "Applying labelsâ€¦"
            gh issue edit "$issue_number" --add-label "$LABEL_MAIN" || true
            gh issue edit "$issue_number" --add-lab_
