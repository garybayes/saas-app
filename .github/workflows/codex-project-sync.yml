---
name: "Codex Project Sync (v9.1)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"  # every 4 hours + offset
  workflow_dispatch: {}
  repository_dispatch:
    types: [codex-project-sync]

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    name: "Codex Project Sync"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Configure GitHub token (v7 auth)
        env:
          GH_CI_PAT: ${{ secrets.GH_CI_PAT }}
        run: |
          set -euo pipefail
          echo "Unsetting GH_TOKEN (GitHub auto-inject)…"
          unset GH_TOKEN

          if [ -n "${GH_CI_PAT:-}" ]; then
            echo "$GH_CI_PAT" | gh auth login --with-token
            echo "Authenticated via GH_CI_PAT"
          else
            echo "ERROR: GH_CI_PAT is missing or empty."
            exit 1
          fi

      - name: Load Codex config variables
        id: config
        run: |
          set -euo pipefail

          MAIN_MS=$(gh variable get CODEX_MAIN_MILESTONE --jq '.value')
          DASH_MS=$(gh variable get CODEX_DASHBOARD_MILESTONE --jq '.value')

          echo "main_ms=$MAIN_MS" >> "$GITHUB_OUTPUT"
          echo "dash_ms=$DASH_MS" >> "$GITHUB_OUTPUT"

          echo "Loaded:"
          echo "  Main milestone      = $MAIN_MS"
          echo "  Dashboard milestone = $DASH_MS"

      - name: Fetch Codex issues via Search API (safe mode)
        id: fetch
        run: |
          set -euo pipefail
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          echo "Fetching Codex issues…"

          # Search API is the ONLY safe way to filter by label
          issues_json="$(
            gh api \
              --paginate \
              -H "Accept: application/vnd.github+json" \
              "/search/issues" \
              -f q="repo:$OWNER/$REPO label:codex is:issue" \
              -f per_page=100 \
            | jq '.items'
          )"

          # Filter PRs just in case
          issues_json="$(echo "$issues_json" | jq 'map(select(.pull_request? == null))')"

          count=$(echo "$issues_json" | jq 'length')
          echo "Found $count Codex issues."

          echo "issues_json=$issues_json" >> "$GITHUB_OUTPUT"

      - name: Sync issues to milestones
        run: |
          set -euo pipefail
          MAIN_MS="${{ steps.config.outputs.main_ms }}"
          DASH_MS="${{ steps.config.outputs.dash_ms }}"

          echo "$MAIN_MS" | grep -qE '^[0-9]+$' || { echo "Invalid MAIN milestone"; exit 1; }
          echo "$DASH_MS" | grep -qE '^[0-9]+$' || { echo "Invalid DASH milestone"; exit 1; }

          issues='${{ steps.fetch.outputs.issues_json }}'
          echo "$issues" | jq -c '.[]' | while read -r issue; do
            number=$(echo "$issue" | jq -r '.number')
            title=$(echo "$issue" | jq -r '.title')
            labels=$(echo "$issue" | jq -r '[.labels[].name]')

            echo "→ Processing #$number: $title"

            # Determine track
            if echo "$labels" | jq -e 'index("codex-trackmain")' >/dev/null; then
              target="$MAIN_MS"
            elif echo "$labels" | jq -e 'index("codex-trackdashboard")' >/dev/null; then
              target="$DASH_MS"
            else
              echo "  Skipping — no track label"
              continue
            fi

            echo "  → Applying milestone $target"
            gh api \
              -X PATCH \
              "/repos/${GITHUB_REPOSITORY}/issues/$number" \
              -f milestone="$target" >/dev/null

          done

      - name: Summary
        run: |
          echo "Codex Project Sync v9.1 completed."
