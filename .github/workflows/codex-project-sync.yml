---
"name": "Codex Project Sync (v8)"

"on":
  schedule:
    - cron: "15 */4 * * *"  # every 4 hours + 15 min offset from supervisor
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write
  repository-projects: write

jobs:
  project_sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: repo


      - name: Configure token
        run: |
          if gh auth token >/dev/null 2>&1; then
            echo "Using gh auth token"
          else
            if [ -n "${GH_CI_PAT:-}" ]; then
              gh auth login --with-token <<< "$GH_CI_PAT"
            else
              echo "ERROR: No token found."
              exit 1
            fi
          fi

      - name: Read repo variables
        id: vars
        run: |
          echo "main_ms=${{ vars.CODEX_MAIN_MILESTONE }}" >> "$GITHUB_OUTPUT"
          echo "dash_ms=${{ vars.CODEX_DASHBOARD_MILESTONE }}" >> "$GITHUB_OUTPUT"

      - name: Run project sync engine
        id: sync
        working-directory: repo
        run: |
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          main_ms="${{ steps.vars.outputs.main_ms }}"
          dash_ms="${{ steps.vars.outputs.dash_ms }}"

          # Milestone 6 = Codex Internal (excluded)
          INTERNAL_MS=6

          fetch_all() {
            gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/$OWNER/$REPO/issues?state=all&per_page=100" \
              --paginate \
              --jq '.[] | {number, labels, milestone, title}'
          }

          all="$(fetch_all)"

          corrections_main=0
          corrections_dash=0
          corrections_codex=0
          corrections_project=0
          declare -a correction_details

          ensure_label() {
            local labels_json="$1"
            local wanted="$2"
            echo "$labels_json" | jq -e --arg w "$wanted" '.[] | select(.name==$w)' >/dev/null 2>&1
          }

          fix_issue() {
            local n="$1"
            local ml="$2"
            local track="$3"

            echo "Correcting issue #$n â†’ milestone=$ml track=$track"

            gh api \
              -X PATCH \
              -H "Accept: application/vnd.github+json" \
              "/repos/$OWNER/$REPO/issues/$n" \
              --raw-field milestone="$ml" \
              --raw-field labels[]=codex \
              --raw-field labels[]="$track" \
              >/dev/null

            corrections_project=$((corrections_project+1))
            correction_details+=("{\"number\":$n,\"changes\":[\"milestone\",\"$track\"]}")
          }

          # Parse issues
          echo "$all" | jq -c '.' | while read -r issue; do
            n=$(echo "$issue" | jq -r '.number')
            ms=$(echo "$issue" | jq -r '.milestone.number // empty')
            title=$(echo "$issue" | jq -r '.title')
            labels=$(echo "$issue" | jq '.labels')

            # Skip Codex Internal
            if [ "$ms" = "$INTERNAL_MS" ]; then
              continue
            fi

            # Skip self-test issues
            if echo "$labels" | jq -e '.[] | select(.name=="codex-selftest")' >/dev/null 2>&1; then
              continue
            fi

            # Ensure codex label
            if ! ensure_label "$labels" "codex"; then
              gh api \
                -X PATCH \
                -H "Accept: application/vnd.github+json" \
                "/repos/$OWNER/$REPO/issues/$n" \
                --raw-field labels[]=codex \
                >/dev/null
              corrections_codex=$((corrections_codex+1))
              correction_details+=("{\"number\":$n,\"changes\":[\"add_codex_label\"]}")
            fi

            # Determine correct track + milestone
            if echo "$title" | grep -qi "dashboard"; then
              track="codex-trackdashboard"
              ms_target="$dash_ms"
            else
              track="codex-trackmain"
              ms_target="$main_ms"
            fi

            # Fix track label
            if ! ensure_label "$labels" "$track"; then
              gh api \
                -X PATCH \
                -H "Accept: application/vnd.github+json" \
                "/repos/$OWNER/$REPO/issues/$n" \
                --raw-field labels[]=codex \
                --raw-field labels[]="$track" \
                >/dev/null
              if [ "$track" = "codex-trackmain" ]; then
                corrections_main=$((corrections_main+1))
              else
                corrections_dash=$((corrections_dash+1))
              fi
              correction_details+=("{\"number\":$n,\"changes\":[\"track_label_$track\"]}")
            fi

            # Fix milestone mismatch
            if [ "$ms" != "$ms_target" ]; then
              fix_issue "$n" "$ms_target" "$track"
            fi

          done

          summary="{\"corrections\":{
            \"codex_label\":$corrections_codex,
            \"track_main\":$corrections_main,
            \"track_dashboard\":$corrections_dash,
            \"project_adjustments\":$corrections_project
          },\"details\":[${correction_details[*]}]}"

          echo "$summary" > sync.json
          echo "summary_path=repo/sync.json" >> "$GITHUB_OUTPUT"

      - name: Write telemetry
        run: |
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          outfile="gh-pages/telemetry/sync-${GITHUB_RUN_ID}.json"

          printf '{\n' > "$outfile"
          printf '  "component": "sync",\n' >> "$outfile"
          printf '  "status": "ok",\n' >> "$outfile"
          printf '  "timestamp": "%s",\n' "$ts" >> "$outfile"
          printf '  "run_id": "%s",\n' "$GITHUB_RUN_ID" >> "$outfile"
          printf '  "run_number": "%s",\n' "$GITHUB_RUN_NUMBER" >> "$outfile"
          printf '  "repository": "%s",\n' "$GITHUB_REPOSITORY" >> "$outfile"
          printf '  "corrections": %s\n' "$(cat repo/sync.json)" >> "$outfile"
          printf '}\n' >> "$outfile"

      - name: Commit telemetry
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add telemetry/
          if git commit -m "Project Sync telemetry ${GITHUB_RUN_ID}"; then
            git push
          else
            echo "No changes to commit."
          fi
