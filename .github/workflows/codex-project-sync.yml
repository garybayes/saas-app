---
name: "Codex Project Sync (v9.9)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"  # every 4 hours + offset
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

  # Inject Codex milestone configuration
  CODEX_MAIN_MILESTONE: ${{ vars.CODEX_MAIN_MILESTONE }}
  CODEX_DASHBOARD_MILESTONE: ${{ vars.CODEX_DASHBOARD_MILESTONE }}
  CODEX_SELFTEST_MILESTONE: ${{ vars.CODEX_SELFTEST_MILESTONE }}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare telemetry directory
        run: |
          mkdir -p gh-pages/telemetry/project-sync

      - name: Load milestone configuration
        id: cfg
        run: |
          set -euo pipefail

          MAIN_MS="${CODEX_MAIN_MILESTONE:-}"
          DASH_MS="${CODEX_DASHBOARD_MILESTONE:-}"
          SELFTEST_MS="${CODEX_SELFTEST_MILESTONE:-}"

          echo "Loaded Codex milestone configuration:"
          echo "  MAIN_MS      = ${MAIN_MS:-<missing>}"
          echo "  DASH_MS      = ${DASH_MS:-<missing>}"
          echo "  SELFTEST_MS  = ${SELFTEST_MS:-<missing>}"

          if [ -z "$MAIN_MS" ] || [ -z "$DASH_MS" ] || [ -z "$SELFTEST_MS" ]; then
            echo "ERROR: One or more Codex milestone variables are missing."
            exit 1
          fi

          echo "main_ms=$MAIN_MS" >> "$GITHUB_OUTPUT"
          echo "dash_ms=$DASH_MS" >> "$GITHUB_OUTPUT"
          echo "selftest_ms=$SELFTEST_MS" >> "$GITHUB_OUTPUT"

      - name: Fetch all Codex-labeled issues
        id: issues
        working-directory: repo
        run: |
          set -euo pipefail

          echo "Fetching issues labeled 'codex'..."
          gh issue list \
            --label codex \
            --state all \
            --limit 500 \
            --json number,title,labels,milestone \
            > codex_issues.json

          echo "Fetched $(jq length codex_issues.json) issues."

      - name: Apply Project Sync rules
        id: apply
        working-directory: repo
        run: |
          set -euo pipefail

          MAIN_MS="${{ steps.cfg.outputs.main_ms }}"
          DASH_MS="${{ steps.cfg.outputs.dash_ms }}"
          SELFTEST_MS="${{ steps.cfg.outputs.selftest_ms }}"

          echo "[" > project_sync_output.json

          for row in $(jq -c '.[]' codex_issues.json); do
            NUMBER=$(echo "$row" | jq -r '.number')
            TITLE=$(echo "$row" | jq -r '.title')
            HAS_SELFTEST=$(echo "$row" | jq '.labels | map(select(.name=="codex-selftest")) | length')

            # Parent track detection
            HAS_MAIN=$(echo "$row" | jq '.labels | map(select(.name=="codex-trackmain")) | length')
            HAS_DASH=$(echo "$row" | jq '.labels | map(select(.name=="codex-trackdashboard")) | length')

            CURRENT_MS=$(echo "$row" | jq -r '.milestone.number // ""')

            TARGET_MS=""

            if [ "$HAS_SELFTEST" -gt 0 ]; then
              TARGET_MS="$SELFTEST_MS"
            elif [ "$HAS_MAIN" -gt 0 ]; then
              TARGET_MS="$MAIN_MS"
            elif [ "$HAS_DASH" -gt 0 ]; then
              TARGET_MS="$DASH_MS"
            else
              # Codex-only issue with unknown parent → fail safe
              TARGET_MS=""
            fi

            # TRACK-SAFETY: Do NOT assign milestone if ambiguous
            if [ -z "$TARGET_MS" ]; then
              echo "Ambiguous issue #$NUMBER → applying fail-safe protection."

              # Optionally add label
              gh issue edit "$NUMBER" --add-label codex-attention || true

              echo "{\"number\": $NUMBER, \"result\": \"ambiguous\"}," >> project_sync_output.json
              continue
            fi

            if [ "$CURRENT_MS" != "$TARGET_MS" ]; then
              echo "Updating #$NUMBER → milestone $TARGET_MS"
              gh issue edit "$NUMBER" --milestone "$TARGET_MS" || true
              echo "{\"number\": $NUMBER, \"result\": \"updated\", \"milestone\": $TARGET_MS}," >> project_sync_output.json
            else
              echo "{\"number\": $NUMBER, \"result\": \"unchanged\", \"milestone\": $TARGET_MS}," >> project_sync_output.json
            fi

          done

          echo "{\"done\": true}]" >> project_sync_output.json

      - name: Write telemetry
        run: |
          set -euo pipefail

          OUTFILE="gh-pages/telemetry/project-sync/project-sync-${{ github.run_id }}-$(date -u +"%Y%m%dT%H%M%SZ").json"
          cp repo/project_sync_output.json "$OUTFILE"

          echo "Telemetry written to: $OUTFILE"

      - name: Commit telemetry
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/project-sync/*.json
          git commit -m "Codex Project Sync telemetry update" || echo "No changes"
          git push origin gh-pages
