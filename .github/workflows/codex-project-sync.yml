---
name: "Codex Project Sync (v9.11.2)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  project_sync:
    runs-on: ubuntu-latest

    steps:
      # Checkout gh-pages for telemetry writing
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      # Checkout main repo (read-only)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      # Ensure telemetry directory exists
      - name: Prepare telemetry directory
        run: mkdir -p gh-pages/telemetry

      # Load milestone config from repo variables
      - name: Load configuration
        id: config
        run: |
          set -euo pipefail

          MAIN_MS="${{ vars.CODEX_MAIN_MILESTONE }}"
          DASH_MS="${{ vars.CODEX_DASHBOARD_MILESTONE }}"
          SELFTEST_MS="${{ vars.CODEX_SELFTEST_MILESTONE }}"

          echo "MAIN_MS=$MAIN_MS"
          echo "DASH_MS=$DASH_MS"
          echo "SELFTEST_MS=$SELFTEST_MS"

          if [[ -z "$MAIN_MS" || -z "$DASH_MS" || -z "$SELFTEST_MS" ]]; then
            echo "ERROR: Missing milestone variables."
            exit 1
          fi

          echo "main_ms=$MAIN_MS" >> "$GITHUB_OUTPUT"
          echo "dash_ms=$DASH_MS" >> "$GITHUB_OUTPUT"
          echo "selftest_ms=$SELFTEST_MS" >> "$GITHUB_OUTPUT"

      # Fetch only codex issues (search removed)
      - name: Fetch Codex issues
        id: fetch
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          echo "Fetching codex-labeled issues…"

          gh api \
            "/repos/$OWNER/$REPO/issues?state=all&labels=codex&per_page=100" \
            --jq '.[] | {number, title, milestone: (.milestone.number // null), labels: [.labels[].name]}' \
            > codex.json

          echo "Fetched:"
          jq -r '.number, .title' codex.json | nl

      # Apply milestone rules
      - name: Apply routing rules
        id: apply
        run: |
          set -euo pipefail

          MAIN_MS="${{ steps.config.outputs.main_ms }}"
          DASH_MS="${{ steps.config.outputs.dash_ms }}"
          SELFTEST_MS="${{ steps.config.outputs.selftest_ms }}"

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          echo "Processing Codex issues…"

          while read -r issue; do
            NUM=$(echo "$issue" | jq -r '.number')
            TITLE=$(echo "$issue" | jq -r '.title')
            CURRENT_MS=$(echo "$issue" | jq -r '.milestone')
            HAS_SELFTEST=$(echo "$issue" | jq -r '.labels | index("codex-selftest")')

            echo "#$NUM: $TITLE"

            # Rule 1: Self-test → SELFTEST_MS
            if [[ "$HAS_SELFTEST" != "null" ]]; then
              echo " → Self-test issue → milestone $SELFTEST_MS"
              gh api -X PATCH "/repos/$OWNER/$REPO/issues/$NUM" -f milestone="$SELFTEST_MS"
              continue
            fi

            # Rule 2: Codex-trackmain → MAIN_MS
            if echo "$issue" | jq -e '.labels | index("codex-trackmain")' >/dev/null; then
              echo " → Main track → milestone $MAIN_MS"
              gh api -X PATCH "/repos/$OWNER/$REPO/issues/$NUM" -f milestone="$MAIN_MS"
              continue
            fi

            # Rule 3: Codex-trackdashboard → DASH_MS
            if echo "$issue" | jq -e '.labels | index("codex-trackdashboard")' >/dev/null; then
              echo " → Dashboard track → milestone $DASH_MS"
              gh api -X PATCH "/repos/$OWNER/$REPO/issues/$NUM" -f milestone="$DASH_MS"
              continue
            fi

            # Rule 4: Codex-only → no milestone + attention needed
            echo " → Codex-only (no track). Leaving without milestone."
            gh api -X PATCH "/repos/$OWNER/$REPO/issues/$NUM" -f milestone=""

          done < <(jq -c '.[]' codex.json)

      # Write telemetry file
      - name: Write telemetry file
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          FILE="gh-pages/telemetry/project-sync-${TS}.json"

          jq -n \
            --arg timestamp "$TS" \
            --arg repo "$GITHUB_REPOSITORY" \
            '{component:"project-sync", timestamp:$timestamp, repository:$repo}' \
            > "$FILE"

          echo "Telemetry written to: $FILE"

      # Commit telemetry update
      - name: Commit telemetry
        working-directory: gh-pages
        run: |
          set -euo pipefail

          git add telemetry/*.json
          git commit -m "Project Sync telemetry update" || true
          git push origin gh-pages
