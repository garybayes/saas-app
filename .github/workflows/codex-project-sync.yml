---
# yamllint disable rule:truthy
name: Codex Project Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: write
  actions: read
  repository-projects: read
  issues: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable GitHub CLI
        run: gh --version
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Fetch project items with pagination
        id: collect
        env:
          GH_TOKEN: ${{ github.token }}
          PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}
        run: |
          QUERY='
          query($project: ID!, $after: String) {
            node(id: $project) {
              ... on ProjectV2 {
                items(first: 100, after: $after) {
                  pageInfo {
                    hasNextPage
                    endCursor
                  }
                  nodes {
                    id
                    content {
                      __typename
                      ... on Issue {
                        number
                        title
                        labels(first: 20) {
                          nodes { name }
                        }
                      }
                    }
                  }
                }
              }
            }
          }'

          items=()
          after_param=()

          while true; do
            if [[ -z "${after_param[*]}" ]]; then
              json=$(gh api graphql -f project="$PROJECT_ID" -f query="$QUERY")
            else
              json=$(gh api graphql -f project="$PROJECT_ID" -f query="$QUERY" -f after="${after_param[0]}")
            fi

            # Extract nodes
            new_nodes=$(echo "$json" | jq -c '.data.node.items.nodes[]?')
            if [[ -n "$new_nodes" ]]; then
              while IFS= read -r item; do
                items+=("$item")
              done <<< "$new_nodes"
            fi

            hasNext=$(echo "$json" | jq '.data.node.items.pageInfo.hasNextPage')
            end_cursor=$(echo "$json" | jq -r '.data.node.items.pageInfo.endCursor')

            echo "Collected ${#items[@]} items so far..."

            if [[ "$hasNext" != "true" ]]; then
              break
            fi

            after_param=("$end_cursor")
          done

          echo "Total items collected: ${#items[@]}"

          printf '%s\n' "${items[@]}" | jq -s '.' > project_items.json

          echo "file=project_items.json" >> $GITHUB_OUTPUT

      - name: Checkout gh-pages
        run: |
          git fetch origin gh-pages
          git checkout gh-pages

      - name: Write output to gh-pages
        run: |
          mv project_items.json project_items.json

      - name: Commit project_items.json to gh-pages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git add project_items.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git commit -m "[skip ci] Update project_items.json"
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" gh-pages
