---
name: "Codex Project Sync (v9.11.3)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  project_sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare telemetry directory
        run: mkdir -p gh-pages/telemetry

      - name: Load milestone configuration
        id: config
        run: |
          set -euo pipefail

          MAIN_MS="${{ vars.CODEX_MAIN_MILESTONE }}"
          DASH_MS="${{ vars.CODEX_DASHBOARD_MILESTONE }}"
          SELFTEST_MS="${{ vars.CODEX_SELFTEST_MILESTONE }}"

          echo "MAIN_MS=$MAIN_MS"
          echo "DASH_MS=$DASH_MS"
          echo "SELFTEST_MS=$SELFTEST_MS"

          if [[ -z "$MAIN_MS" || -z "$DASH_MS" || -z "$SELFTEST_MS" ]]; then
            echo "ERROR: Missing milestone variables."
            exit 1
          fi

          echo "main_ms=$MAIN_MS" >> "$GITHUB_OUTPUT"
          echo "dash_ms=$DASH_MS" >> "$GITHUB_OUTPUT"
          echo "selftest_ms=$SELFTEST_MS" >> "$GITHUB_OUTPUT"

      - name: Fetch Codex issues
        id: fetch
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          echo "Fetching codex-labeled issues…"

          gh api \
            "/repos/$OWNER/$REPO/issues?state=all&labels=codex&per_page=100" \
            --jq '.[] | {number, title, milestone: (.milestone.number // null), labels: [.labels[].name]}' \
            > codex.json

          echo "Fetched issues:"
          jq -r '.[] | "#\(.number): \(.title)"' codex.json

      - name: Apply Project Sync routing rules
        run: |
          set -euo pipefail
          MAIN_MS="${{ steps.config.outputs.main_ms }}"
          DASH_MS="${{ steps.config.outputs.dash_ms }}"
          SELFTEST_MS="${{ steps.config.outputs.selftest_ms }}"

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          # Loop through each issue object inside the array
          jq -c '.[]' codex.json | while read -r issue; do
            NUM=$(echo "$issue" | jq -r '.number')
            TITLE=$(echo "$issue" | jq -r '.title')
            CURRENT_MS=$(echo "$issue" | jq -r '.milestone')
            LABELS=$(echo "$issue" | jq -r '.labels')

            echo ""
            echo "#$NUM: $TITLE"

            # Self-test Rule
            if echo "$LABELS" | jq -e 'index("codex-selftest")' >/dev/null; then
              echo " → Self-test → milestone $SELFTEST_MS"
              gh api -X PATCH "/repos/$OWNER/$REPO/issues/$NUM" -f milestone="$SELFTEST_MS"
              continue
            fi

            # Main Track Rule
            if echo "$LABELS" | jq -e 'index("codex-trackmain")' >/dev/null; then
              echo " → Main track → milestone $MAIN_MS"
              gh api -X PATCH "/repos/$OWNER/$REPO/issues/$NUM" -f milestone="$MAIN_MS"
              continue
            fi

            # Dashboard Track Rule
            if echo "$LABELS" | jq -e 'index("codex-trackdashboard")' >/dev/null; then
              echo " → Dashboard track → milestone $DASH_MS"
              gh api -X PATCH "/repos/$OWNER/$REPO/issues/$NUM" -f milestone="$DASH_MS"
              continue
            fi

            # Codex-only (no track) — leave unassigned
            echo " → Codex-only, no track — leaving milestone unchanged."
          done

      - name: Write Project Sync telemetry
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          FILE="gh-pages/telemetry/project-sync-${TS}.json"

          jq -n \
            --arg timestamp "$TS" \
            --arg repo "$GITHUB_REPOSITORY" \
            '{component:"project-sync", timestamp:$timestamp, repository:$repo}' \
            > "$FILE"

          echo "Telemetry written → $FILE"

      - name: Commit telemetry
        working-directory: gh-pages
        run: |
          git add telemetry/*.json
          git commit -m "Project Sync telemetry update" || true
          git push origin gh-pages
