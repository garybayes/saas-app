---
name: "Codex Project Sync (v9.12)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"  # Every 4 hours, offset from supervisor
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  project_sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare telemetry
        run: mkdir -p gh-pages/telemetry

      - name: Load milestone configuration
        id: config
        run: |
          set -euo pipefail

          echo "Loading Codex milestone variables…"

          MAIN_MS="${CODEX_MAIN_MILESTONE:-}"
          DASH_MS="${CODEX_DASHBOARD_MILESTONE:-}"
          SELFTEST_MS="${CODEX_SELFTEST_MILESTONE:-}"

          echo "main=$MAIN_MS"      >> "$GITHUB_OUTPUT"
          echo "dash=$DASH_MS"      >> "$GITHUB_OUTPUT"
          echo "selftest=$SELFTEST_MS" >> "$GITHUB_OUTPUT"

      - name: Fetch Codex issues
        run: |
          set -euo pipefail
          cd repo

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          echo "Fetching codex-labeled issues…"

          gh api \
            "/repos/$OWNER/$REPO/issues?state=all&labels=codex&per_page=100" \
            --jq '.[] | {number, title, milestone: (.milestone.number // null), labels: [.labels[].name]}' \
            | jq -s '.' > codex.json

          echo "Fetched issues:"
          jq -r '.[] | "#\(.number): \(.title)"' codex.json

      - name: Apply Project Sync rules
        id: sync
        run: |
          set -euo pipefail
          cd repo

          MAIN_MS="${{ steps.config.outputs.main }}"
          DASH_MS="${{ steps.config.outputs.dash }}"
          SELFTEST_MS="${{ steps.config.outputs.selftest }}"

          SUMMARY_FILE="project-sync-summary.json"
          echo "[]" > "$SUMMARY_FILE"

          process_issue() {
            local num="$1"
            local title="$2"
            local ms="$3"
            local labels="$4"
            local new_ms=""

            if [[ "$labels" == *"codex-selftest"* ]]; then
              new_ms="$SELFTEST_MS"
            elif [[ "$labels" == *"codex-main"* ]]; then
              new_ms="$MAIN_MS"
            elif [[ "$labels" == *"codex-dashboard"* ]]; then
              new_ms="$DASH_MS"
            elif [[ "$labels" == *"codex-only"* ]]; then
              # Unknown parent → no milestone change
              new_ms=""
            else
              # Codex but unlabeled track → warn and skip
              echo "WARN: Issue #$num missing track label — skipping."
              return
            fi

            # Only update if different & non-empty
            if [[ -n "$new_ms" && "$new_ms" != "$ms" ]]; then
              echo "Updating #$num → milestone $new_ms"
              gh issue edit "$num" --milestone "$new_ms"

              # Append to summary file
              jq \
                --arg num "$num" \
                --arg old "$ms" \
                --arg new "$new_ms" \
                '. += [{"number": $num, "old_ms": $old, "new_ms": $new}]' \
                "$SUMMARY_FILE" > tmp.json && mv tmp.json "$SUMMARY_FILE"
            fi
          }

          jq -c '.[]' codex.json | while read -r issue; do
            num=$(echo "$issue" | jq -r '.number')
            title=$(echo "$issue" | jq -r '.title')
            ms=$(echo "$issue" | jq -r '.milestone // ""')
            labels=$(echo "$issue" | jq -r '.labels | join(",")')

            echo "Processing #$num \"$title\""
            process_issue "$num" "$title" "$ms" "$labels"
          done

          cp "$SUMMARY_FILE" ../gh-pages/telemetry/project-sync-"$(date -u +"%Y%m%dT%H%M%SZ")".json

      - name: Commit telemetry
        run: |
          set -euo pipefail
          cd gh-pages

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/*.json || true
          git commit -m "Codex Project Sync telemetry update" || true
          git push origin gh-pages
