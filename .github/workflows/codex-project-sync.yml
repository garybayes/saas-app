---
name: "Codex Project Sync (v9.11.1)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "15 */4 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages (full clone)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0
          persist-credentials: true

      - name: Checkout repository (isolated)
        uses: actions/checkout@v4
        with:
          path: repo
          fetch-depth: 1
          persist-credentials: false

      - name: Load configuration
        id: config
        run: |
          set -euo pipefail
          MAIN_MS="${{ vars.CODEX_MAIN_MILESTONE }}"
          DASH_MS="${{ vars.CODEX_DASHBOARD_MILESTONE }}"
          SELFTEST_MS="${{ vars.CODEX_SELFTEST_MILESTONE }}"

          echo "main=$MAIN_MS" >> "$GITHUB_OUTPUT"
          echo "dash=$DASH_MS" >> "$GITHUB_OUTPUT"
          echo "selftest=$SELFTEST_MS" >> "$GITHUB_OUTPUT"

      - name: Validate configuration
        run: |
          set -euo pipefail

          if [ -z "${{ steps.config.outputs.main }}" ] ||
             [ -z "${{ steps.config.outputs.dash }}" ] ||
             [ -z "${{ steps.config.outputs.selftest }}" ]; then

            echo "ERROR: One or more Codex milestone variables missing."
            exit 1
          fi

      - name: Fetch Codex issues
        id: fetch
        run: |
          set -euo pipefail

          ISSUES=$(gh issue list \
            --label "codex" \
            --state all \
            --json number,title,labels,body,milestone)

          echo "$ISSUES" > repo/issues.json
          echo "issues_path=repo/issues.json" >> "$GITHUB_OUTPUT"

      - name: Process issues
        run: |
          set -euo pipefail

          MAIN_MS="${{ steps.config.outputs.main }}"
          DASH_MS="${{ steps.config.outputs.dash }}"
          SELFTEST_MS="${{ steps.config.outputs.selftest }}"
          FILE="${{ steps.fetch.outputs.issues_path }}"

          jq -c '.[]' "$FILE" | while read -r issue; do
            NUM=$(echo "$issue" | jq -r '.number')
            TITLE=$(echo "$issue" | jq -r '.title')
            LABELS=$(echo "$issue" | jq -r '.labels[].name')

            echo "#$NUM: $TITLE"

            # Self-test issues
            if echo "$LABELS" | grep -q "codex-selftest"; then
              echo " → Self-test issue"
              if [ -z "$SELFTEST_MS" ]; then
                echo "   ❌ EMPTY milestone — refusing to set."
                continue
              fi
              gh issue edit "$NUM" --milestone "$SELFTEST_MS"
              continue
            fi

            # Main track
            if echo "$LABELS" | grep -q "codex-trackmain"; then
              echo " → Main
