name: Codex Self-Test v3 (Full Refresh)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  codex_self_test:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      PROJECT_ID: "PVT_kwHODgSGMM4BI6BO"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure git identity
        run: |
          git config --global user.name "codex-ci-bot"
          git config --global user.email "codex-ci-bot@users.noreply.github.com"

      - name: Create self-test issue
        id: create_issue
        run: |
          set -e
          URL=$(gh issue create --title "Codex Self-Test Issue" --body "Self-test pipeline run.")
          NUM=$(echo "$URL" | grep -oE '[0-9]+$')

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "number=$NUM" >> $GITHUB_OUTPUT

      - name: Add issue to Codex project
        id: add_to_project
        run: |
          set -e

          NUM="${{ steps.create_issue.outputs.number }}"

          NODE=$(gh api graphql -f query='
            query($o:String!, $r:String!, $n:Int!) {
              repository(owner:$o, name:$r) {
                issue(number:$n) { id }
              }
            }' \
            -F o="${GITHUB_REPOSITORY_OWNER}" \
            -F r="${GITHUB_REPOSITORY#*/}" \
            -F n="$NUM")

          ISSUE_NODE=$(echo "$NODE" | grep -oE '"id":"[^"]+"' | sed 's/"id":"\(.*\)"/\1/')

          gh api graphql -f query='
            mutation($p:ID!, $i:ID!) {
              addProjectV2ItemById(input:{projectId:$p, contentId:$i}) {
                item { id }
              }
            }' \
            -F p="$PROJECT_ID" \
            -F i="$ISSUE_NODE"

      - name: Close self-test issue
        run: |
          gh issue close "${{ steps.create_issue.outputs.number }}" \
            --comment "Codex self-test completed successfully."

      - name: Store telemetry snapshot
        run: |
          mkdir -p codex-selftest

          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          NUM="${{ steps.create_issue.outputs.number }}"

          cat > codex-selftest/latest.json <<EOF
{
  "timestamp": "$TS",
  "status": "success",
  "issue": $NUM
}
EOF

          git add codex-selftest/latest.json
          git commit -m "Self-test telemetry update [skip ci]" || true
          git push origin "$GITHUB_REF_NAME" || true
