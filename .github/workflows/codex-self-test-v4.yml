---
# yamllint disable rule:truthy
name: Codex Self-Test v4

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write
  issues: write
  repository-projects: write

jobs:
  selftest:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Configure git identity
        run: |
          git config --global user.name "codex-ci-bot"
          git config --global user.email "codex-ci-bot@users.noreply.github.com"

      - name: Create issue
        id: create
        run: |
          URL=$(gh issue create --title "Codex Self-Test Cycle" --body "Automated system test.")
          NUM=$(echo "$URL" | grep -oE '[0-9]+$')
          echo "number=$NUM" >> $GITHUB_OUTPUT

      - name: Add to project
        run: |
          gh project item-add "${PROJECT_ID}" \
            --url "https://github.com/$REPO/issues/${{ steps.create.outputs.number }}" || true

      - name: Close issue
        run: |
          gh issue close "${{ steps.create.outputs.number }}" \
            --comment "Codex self-test completed."

      - name: Write telemetry
        run: |
          mkdir -p codex-selftest
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          printf '{\n' > codex-selftest/latest.json
          printf '  "timestamp": "%s",\n' "$TS" >> codex-selftest/latest.json
          printf '  "source": "self-test-v4",\n' >> codex-selftest/latest.json
          printf '  "issue": %s\n' "${{ steps.create.outputs.number }}" >> codex-selftest/latest.json
          printf '}\n' >> codex-selftest/latest.json

          git add codex-selftest/latest.json
          git commit -m "Self-test telemetry [skip ci]" || echo "No changes."
          git pull --rebase origin gh-pages || git rebase --abort
          git push origin gh-pages || true

      - name: Trigger telemetry merge
        run: |
          gh workflow run codex-telemetry-merge-v3.yml
