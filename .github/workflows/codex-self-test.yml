# yamllint disable rule:truthy
---
name: Codex Self-Test

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  actions: read
  repository-projects: write

jobs:
  selftest:
    name: Run Codex Self-Test
    runs-on: ubuntu-latest

    env:
      CODEX_PROJECT_URL: ${{ vars.CODEX_PROJECT_URL }}
      CODEX_PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}
      CODEX_PROJECT_NUMBER: ${{ vars.CODEX_PROJECT_NUMBER }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # ---------------------------------------------------------
      # 1. Checkout repo
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # 2. Create a unique self-test issue (no --json flag)
      # ---------------------------------------------------------
      - name: Create self-test issue
        id: create_issue
        run: |
          TITLE="Codex Self-Test $(date +%s)"
          BODY="Codex automated self-test issue."

          echo "Creating issue: $TITLE"

          gh issue create \
            --title "$TITLE" \
            --body "$BODY" \
            --repo "${{ github.repository }}"

          # Retrieve newly-created issue URL via list search
          ISSUE_URL=$(gh issue list \
            --state open \
            --limit 1 \
            --search "$TITLE" \
            --json url \
            | jq -r '.[0].url')

          echo "issue_url=$ISSUE_URL" >> "$GITHUB_OUTPUT"

      # ---------------------------------------------------------
      # 3. Add issue to Project V2 (correct GH CLI syntax)
      # ---------------------------------------------------------
      - name: Add issue to Codex project
        run: |
          echo "Adding issue to project: $CODEX_PROJECT_URL"

          ISSUE_URL=${{ steps.create_issue.outputs.issue_url }}

          gh project item-add "$CODEX_PROJECT_NUMBER" \
            --url "$ISSUE_URL" \
            --owner "garybayes"

      # ---------------------------------------------------------
      # 4. Close issue
      # ---------------------------------------------------------
      - name: Close self-test issue
        run: |
          ISSUE_URL=${{ steps.create_issue.outputs.issue_url }}
          gh issue close "$ISSUE_URL"

      # ---------------------------------------------------------
      # 5. Prepare self-test telemetry JSON
      # ---------------------------------------------------------
      - name: Generate self-test telemetry
        run: |
          mkdir -p activity-telemetry

          cat <<EOF > activity-telemetry/latest.json
          {
            "selftest": [
              {
                "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
                "status": "ok",
                "issue": "${{ steps.create_issue.outputs.issue_url }}"
              }
            ]
          }
          EOF

          echo "Generated self-test telemetry:"
          cat activity-telemetry/latest.json

      # ---------------------------------------------------------
      # 6. Checkout gh-pages to write telemetry
      # ---------------------------------------------------------
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
          path: ghp

      # ---------------------------------------------------------
      # 7. Write self-test telemetry to gh-pages
      # ---------------------------------------------------------
      - name: Copy telemetry to gh-pages
        run: |
          mkdir -p ghp/activity-telemetry
          cp activity-telemetry/latest.json ghp/activity-telemetry/latest.json

      # ---------------------------------------------------------
      # 8. Commit telemetry update
      # ---------------------------------------------------------
      - name: Commit telemetry file
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd ghp

          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          git add activity-telemetry/latest.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "[skip ci] Codex: self-test telemetry update"
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" gh-pages

      # ---------------------------------------------------------
      # 9. Summary
      # ---------------------------------------------------------
      - name: Summary
        run: |
          echo "---------------------------------------"
          echo "Codex Self-Test completed successfully."
          echo "Issue URL: ${{ steps.create_issue.outputs.issue_url }}"
          echo "Telemetry stored at: gh-pages/activity-telemetry/latest.json"
          echo "---------------------------------------"
