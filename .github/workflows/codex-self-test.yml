---
name: Codex Self-Test (v7.5)

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  selftest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Ensure telemetry directories exist
        run: |
          mkdir -p gh-pages/telemetry
          mkdir -p gh-pages/dashboard
          mkdir -p gh-pages/merged

      - name: Resolve milestone ID
        id: ms
        run: |
          SELFTEST_MS="${CODEX_SELFTEST_MILESTONE:-0}"

          if [ "$SELFTEST_MS" = "0" ]; then
            echo "FALLBACK: Using milestone 'Codex Internal'"
            SELFTEST_MS=$(gh api "/repos/${GITHUB_REPOSITORY}/milestones" \
              --jq '.[] | select(.title=="Codex Internal") | .number')
          fi

          if [ -z "$SELFTEST_MS" ]; then
            echo "ERROR: Could not resolve self-test milestone."
            exit 0
          fi

          echo "milestone=$SELFTEST_MS" >> "$GITHUB_OUTPUT"

      - name: Create self-test issue
        working-directory: repo
        run: |
          NOW_UTC="$(date -u +"%Y-%m-%d %H:%M UTC")"

          gh issue create \
            --title "Codex Self-Test: $NOW_UTC" \
            --body "Automated Codex self-test issue." \
            --label "codex" \
            --label "codex-selftest" \
            --milestone "${{ steps.ms.outputs.milestone }}" || true

      - name: Write telemetry record
        run: |
          OUT="gh-pages/telemetry/self-test-${GITHUB_RUN_ID}.json"
          TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          {
            printf '{\n'
            printf '  "component": "selftest",\n'
            printf '  "timestamp": "%s",\n' "$TS"
            printf '  "run_id": "%s",\n' "$GITHUB_RUN_ID"
            printf '  "milestone": "%s"\n' "${{ steps.ms.outputs.milestone }}"
            printf '}\n'
          } > "$OUT"

          echo "Wrote telemetry â†’ $OUT"

      - name: Commit telemetry
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add telemetry/*.json || true
          git commit -m "Self-Test telemetry update" || true
          git push origin gh-pages || true
