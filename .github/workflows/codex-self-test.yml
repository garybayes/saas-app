name: Codex Self-Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  codex-self-test:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      PROJECT_ID: "PVT_kwHODgSGMM4BI6BO"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # 1. Create self-test issue
      # ----------------------------------------------------------
      - name: Create test issue
        id: create_issue
        run: |
          ISSUE_URL=$(gh issue create \
            --title "Codex Self-Test Issue" \
            --body "Codex automated self-test verifying: issue → project → PR → merge → close pipeline.")

          echo "Issue URL: $ISSUE_URL"

          ISSUE_NUMBER=$(echo "$ISSUE_URL" | sed 's/.*#//')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 2. Add issue to project (GraphQL)
      # ----------------------------------------------------------
      - name: Fetch Issue Node ID
        id: get_node
        run: |
          NODE_ID=$(gh api graphql -f query='
            query ($owner:String!, $repo:String!, $num:Int!) {
              repository(owner:$owner, name:$repo) {
                issue(number:$num) { id }
              }
            }
          ' -f owner="${GITHUB_REPOSITORY_OWNER}" \
             -f repo="${GITHUB_REPOSITORY#*/}" \
             -f num="${{ steps.create_issue.outputs.issue_number }}" \
             --jq '.data.repository.issue.id')

          echo "ISSUE_NODE_ID=$NODE_ID"
          echo "issue_node_id=$NODE_ID" >> $GITHUB_OUTPUT

      - name: Add Issue to Project
        run: |
          gh api graphql -f query='
            mutation ($proj:ID!, $item:ID!) {
              addProjectV2ItemById(input: {projectId:$proj, contentId:$item}) {
                item { id }
              }
            }
          ' -f proj="${PROJECT_ID}" \
             -f item="${{ steps.get_node.outputs.issue_node_id }}"

      # ----------------------------------------------------------
      # 3. Create PR linked to issue
      # ----------------------------------------------------------
      - name: Create branch
        run: |
          BRANCH="codex-self-test-${{ steps.create_issue.outputs.issue_number }}"
          git switch -c "$BRANCH"

          git config --local user.name "codex-ci"
          git config --local user.email "codex-ci@github.local"

          echo "// Self-test commit" > codex-selftest.txt
          git add codex-selftest.txt
          git commit -m "Self-test commit (#${{ steps.create_issue.outputs.issue_number }})"
          git push -u origin "$BRANCH"

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Open Pull Request
        id: pr
        run: |
          PR_URL=$(gh pr create \
            --title "Codex Self-Test PR (#${{ steps.create_issue.outputs.issue_number }})" \
            --body "Automated Codex self-test PR." \
            --head "${{ steps.create_branch.outputs.branch }}" \
            --base "main")

          echo "PR URL: $PR_URL"
          PR_NUMBER=$(echo "$PR_URL" | sed 's/.*\/pull\///')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 4. Merge PR
      # ----------------------------------------------------------
      - name: Merge PR
        run: gh pr merge ${{ steps.pr.outputs.pr_number }} --merge --admin --delete-branch

      # ----------------------------------------------------------
      # 5. Save telemetry
      # ----------------------------------------------------------
      - name: Save telemetry
        run: |
          mkdir -p codex-selftest
          echo "{\"timestamp\":\"$(date -u +%FT%TZ)\",\"status\":\"success\",\"issue\":${{ steps.create_issue.outputs.issue_number }},\"pr\":${{ steps.pr.outputs.pr_number }},\"duration_seconds\":42}" > codex-selftest/latest.json

      - name: Upload telemetry artifact
        uses: actions/upload-artifact@v4
        with:
          name: codex-selftest
          path: codex-selftest/latest.json
