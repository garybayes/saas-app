---
name: Codex Self-Test v6

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

jobs:
  selftest:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}

    steps:

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: repo

      #
      # Determine milestone
      #
      - name: Determine milestone
        id: milestone
        working-directory: repo
        run: |
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          # Read milestone title from repo variables or fallback
          SELFTEST_MILESTONE_TITLE="$(gh variable get CODEX_SELFTEST_MILESTONE -q 2>/dev/null || echo 'Codex Internal')"

          ms_json="$(gh api "/repos/$OWNER/$REPO/milestones")"

          SELFTEST_MILESTONE_NUMBER="$(
            echo "$ms_json" |
            jq -r --arg T "$SELFTEST_MILESTONE_TITLE" '.[] | select(.title==$T) | .number'
          )"

          if [ -z "$SELFTEST_MILESTONE_NUMBER" ] || [ "$SELFTEST_MILESTONE_NUMBER" = "null" ]; then
            echo "skip=yes" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=no" >> "$GITHUB_OUTPUT"
          echo "title=$SELFTEST_MILESTONE_TITLE" >> "$GITHUB_OUTPUT"
          echo "number=$SELFTEST_MILESTONE_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Skip if milestone missing
        if: steps.milestone.outputs.skip == 'yes'
        run: echo "Self-Test skipped (milestone missing)."

      #
      # Create Self-Test issue
      #
      - name: Create Self-Test Issue
        if: steps.milestone.outputs.skip == 'no'
        id: create_selftest_issue
        working-directory: repo
        run: |
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          TITLE="Codex Self-Test: $(date -u +'%Y-%m-%d %H:%M UTC')"
          BODY="Automated nightly self-test of Codex subsystem."

          MILESTONE="${{ steps.milestone.outputs.title }}"

          issue_url="$(
            gh issue create \
              --title "$TITLE" \
              --body "$BODY" \
              --label "codex" \
              --label "codex-selftest" \
              --milestone "$MILESTONE" \
              --project "Codex Dual-Track Development"
          )"

          issue_number="$(basename "$issue_url")"
          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"

      #
      # Write telemetry JSON
      #
      - name: Prepare telemetry file
        id: telemetry
        working-directory: repo
        run: |
          ISSUE_NUMBER="${{ steps.create_selftest_issue.outputs.issue_number }}"
          [ -z "$ISSUE_NUMBER" ] && ISSUE_NUMBER="none"

          ts="$(date -u +"%Y%m%dT%H%M%SZ")"
          outfile="../gh-pages/telemetry/selftest-${ts}.json"

          mkdir -p ../gh-pages/telemetry

          {
            printf '{\n'
            printf '  "component": "selftest",\n'
            printf '  "timestamp": "%s",\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            printf '  "issue": "%s"\n' "$ISSUE_NUMBER"
            printf '}\n'
          } > "$outfile"

          echo "outfile=$outfile" >> "$GITHUB_OUTPUT"

      #
      # Commit telemetry
      #
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Commit telemetry
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add telemetry/*.json
          git commit -m "Self-Test telemetry update" || echo "No changes"
          git push origin gh-pages
