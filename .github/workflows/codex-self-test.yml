name: Codex Self-Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  codex-self-test:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      PROJECT_ID: "PVT_kwHODgSGMM4BI6BO"

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 1. Create self-test issue (GH CLI, old-version safe)
      # ---------------------------------------------------
      - name: Create test issue
        id: create_issue
        run: |
          ISSUE_URL=$(gh issue create \
            --title "Codex Self-Test Issue" \
            --body "Codex automated self-test: issue → project → PR → merge → telemetry." )

          echo "Issue URL: $ISSUE_URL"

          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT

      # ---------------------------------------------------
      # 2. Get Issue Node ID (for ProjectV2 GraphQL)
      # ---------------------------------------------------
      - name: Resolve Issue Node ID
        id: resolve_node
        run: |
          ISSUE_NODE_ID=$(gh api graphql -f query='
            query($repo:String!,$owner:String!,$num:Int!) {
              repository(name:$repo, owner:$owner) {
                issue(number:$num) { id }
              }
            }
          ' -F repo="saas-app" \
             -F owner="${{ github.repository_owner }}" \
             -F num="${{ steps.create_issue.outputs.issue_number }}" \
             --jq '.data.repository.issue.id')

          echo "node_id=$ISSUE_NODE_ID" >> $GITHUB_OUTPUT

      # ---------------------------------------------------
      # 3. Add Issue to ProjectV2
      # ---------------------------------------------------
      - name: Add issue to Codex project
        id: project_add
        run: |
          RESULT=$(gh api graphql -f query='
            mutation($project:ID!, $item:ID!) {
              addProjectV2ItemById(input:{
                projectId:$project
                contentId:$item
              }) {
                item { id }
              }
            }
          ' \
          -F project="${PROJECT_ID}" \
          -F item="${{ steps.resolve_node.outputs.node_id }}")

          echo "$RESULT"

      # ---------------------------------------------------
      # 4. Configure git identity
      # ---------------------------------------------------
      - name: Configure git
        run: |
          git config --global user.email "codex-ci@github"
          git config --global user.name "Codex CI"

      # ---------------------------------------------------
      # 5. Create temporary branch
      # ---------------------------------------------------
      - name: Create working branch
        id: branch
        run: |
          BRANCH="codex-self-test-${{ steps.create_issue.outputs.issue_number }}"
          git checkout -b "$BRAN
