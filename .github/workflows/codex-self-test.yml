name: Codex Self-Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  codex-self-test:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      PROJECT_ID: "PVT_kwHODgSGMM4BI6BO"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------
      # 1. Create test issue (GH CLI, no JSON mode required)
      # -------------------------------------------------------
      - name: Create self-test issue
        id: create_issue
        run: |
          set -e

          ISSUE_URL=$(gh issue create \
            --title "Codex Self-Test Issue" \
            --body "Codex automated self-test: verifies issue → project → PR → merge → close pipeline.")

          echo "Created issue URL: $ISSUE_URL"

          # Extract number using grep
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -o '[0-9]\+$')
          echo "Extracted issue number: $ISSUE_NUMBER"

          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"

      # -------------------------------------------------------
      # 2. Insert issue into ProjectV2 (requires PAT scopes)
      # -------------------------------------------------------
      - name: Add issue to ProjectV2
        id: project_link
        run: |
          set -e

          OWNER_REPO="${GITHUB_REPOSITORY}"
          OWNER="$(echo "$OWNER_REPO" | cut -d'/' -f1)"
          REPO="$(echo "$OWNER_REPO" | cut -d'/' -f2)"
          NUM="${{ steps.create_issue.outputs.issue_number }}"

          echo "Owner: $OWNER"
          echo "Repo: $REPO"
          echo "Issue #: $NUM"

          # Fetch Issue Node ID
          ISSUE_NODE_ID=$(gh api graphql -f query="
            query {
              repository(owner:\"$OWNER\", name:\"$REPO\") {
                issue(number:$NUM) { id }
              }
            }" --jq '.data.repository.issue.id')

          echo "Issue Node ID: $ISSUE_NODE_ID"

          # Add to project (requires PAT)
          ITEM_ID=$(gh api graphql -f query="
            mutation {
              addProjectV2ItemById(input:{projectId:\"$PROJECT_ID\", contentId:\"$ISSUE_NODE_ID\"}) {
                item { id }
              }
            }" --jq '.data.addProjectV2ItemById.item.id')

          echo "Project Item ID: $ITEM_ID"
          echo "project_item_id=$ITEM_ID" >> "$GITHUB_OUTPUT"

      # -------------------------------------------------------
      # 3. Create branch safely
      # -------------------------------------------------------
      - name: Create working branch
        id: create_branch
        run: |
          set -e
          ISSUE="${{ steps.create_issue.outputs.issue_number }}"
          BRANCH="codex-self-test-$ISSUE"

          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      # -------------------------------------------------------
      # 4. Commit a test change
      # -------------------------------------------------------
      - name: Commit test file
        run: |
          set -e
          ISSUE="${{ steps.create_issue.outputs.issue_number }}"

          mkdir -p codex-selftest
          echo "Codex test run: $ISSUE at $(date -u)" > codex-selftest/selftest-$ISSUE.txt

          git add codex-selftest
          git -c user.name="Codex Bot" -c user.email="codex@bot" commit -m "Codex self-test: update file for issue #$ISSUE"

      # -------------------------------------------------------
      # 5. Push branch
      # -------------------------------------------------------
      - name: Push branch
        run: |
          set -e
          BRANCH="${{ steps.create_branch.outputs.branch }}"
          git push origin "$BRANCH"

      # -------------------------------------------------------
      # 6. Open PR
      # -------------------------------------------------------
      - name: Open Pull Request
        id: create_pr
        run: |
          set -e
          ISSUE="${{ steps.create_issue.outputs.issue_number }}"
          BRANCH="${{ steps.create_branch.outputs.branch }}"

          PR_URL=$(gh pr create \
            --title "Codex Self-Test: Issue #$ISSUE" \
            --body "Automated self-test PR for issue #$ISSUE." \
            --head "$BRANCH" \
            --base "main")

          echo "PR URL: $PR_URL"

          PR_NUMBER=$(echo "$PR_URL" | grep -o '[0-9]\+$')
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      # -------------------------------------------------------
      # 7. Merge PR
      # -------------------------------------------------------
      - name: Merge PR
        run: |
          set -e
          PR="${{ steps.create_pr.outputs.pr_number }}"
          gh pr merge "$PR" --merge --delete-branch

      # ----------------------------------------------------------
      # 8. Append telemetry entry to codex-data.json on main
      # ----------------------------------------------------------
      - name: Append telemetry record
        run: |
          # Fetch existing telemetry file from main
          gh api \
            /repos/${GITHUB_REPOSITORY}/contents/codex-data.json \
            --jq '.content' | base64 --decode > codex-data.json

          # Build telemetry entry
          cat <<EOF > entry.json
{
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "event": "codex-self-test",
  "issue": "${ISSUE_URL}",
  "project_id": "${PROJECT_ID}",
  "status": "ok"
}
EOF

          # Append entry into array
          jq '. += [input]' codex-data.json entry.json > updated.json
          mv updated.json codex-data.json

          # Commit back to main
          git config --global user.email "actions@github.com"
          git config --global user.name  "github-actions"

          git checkout main
          git pull --rebase

          git add codex-data.json
          git commit -m "Codex telemetry update: self-test"
          git push origin main
