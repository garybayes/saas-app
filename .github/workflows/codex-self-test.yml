name: Codex Automation Self-Test

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  self-test:
    name: Run Codex Automation Full Test
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # SETUP
      # --------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install GitHub CLI + jq
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Authenticate GH CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh auth setup-git

      # --------------------------------------------------------
      # 1. CREATE FIRST TEST ISSUE
      # --------------------------------------------------------
      - name: Create Test Issue
        id: issue
        run: |
          ISSUE_URL=$(gh issue create \
            --title "Codex Self-Test Issue" \
            --body "Synthetic issue for Codex automation test." \
            --label "codex-test")

          ISSUE_NUMBER=$(echo "$ISSUE_URL" | sed 's/.*issues\///')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          echo "Created issue #$ISSUE_NUMBER"

      # --------------------------------------------------------
      # 2. ASSIGN FIRST ISSUE TO CODEX (assignment trigger)
      # --------------------------------------------------------
      - name: Assign Issue
        run: |
          gh issue edit ${{ steps.issue.outputs.issue_number }} \
            --add-assignee garybayes

      # --------------------------------------------------------
      # 3. CREATE BRANCH + EMPTY COMMIT REFERENCING ISSUE
      # --------------------------------------------------------
      - name: Create Branch and Commit
        id: branch
        run: |
          ISSUE=${{ steps.issue.outputs.issue_number }}
          BRANCH="codex-test-$ISSUE"

          git checkout -b "$BRANCH"
          git commit --allow-empty -m "Start work on #$ISSUE"
          git push --set-upstream origin "$BRANCH"

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      # --------------------------------------------------------
      # 4. OPEN PR FOR FIRST ISSUE
      # --------------------------------------------------------
      - name: Open PR
        id: pr
        run: |
          PR_URL=$(gh pr create \
            --title "Codex Self-Test PR (#${{ steps.issue.outputs.issue_number }})" \
            --body "Fixes #${{ steps.issue.outputs.issue_number }}" \
            --base main)

          PR_NUMBER=$(echo "$PR_URL" | sed 's/.*pull\///')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          echo "Opened PR #$PR_NUMBER"

      # --------------------------------------------------------
      # 5. VERIFY STATUS MOVED TO "IN PROGRESS"
      # --------------------------------------------------------
      - name: Verify In Progress
        run: |
          ISSUE=${{ steps.issue.outputs.issue_number }}

          PROJECT_ID="PVT_kwHODgSGMM4BI6BO"
          STATUS_FIELD_ID="PVTSSF_lAHODgSGMM4BI6BOzg5OjrU"

          STATUS=$(gh api graphql -f query='
            {
              node(id:"'"$PROJECT_ID"'") {
                ... on ProjectV2 {
                  items(first:100) {
                    nodes {
                      content { ... on Issue { number } }
                      fieldValues(first:10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            fieldId
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' | jq -r '
            .data.node.items.nodes[]
            | select(.content.number == ('"$ISSUE"' | tonumber))
            | .fieldValues.nodes[]
            | select(.fieldId=="'"$STATUS_FIELD_ID"'")
            | .name
          ')

          echo "Status after PR open = $STATUS"
          [[ "$STATUS" == "In Progress" ]] || (echo "::error::Not In Progress!" && exit 1)

      # --------------------------------------------------------
      # 6. MERGE PR
      # --------------------------------------------------------
      - name: Merge PR
        run: |
          gh pr merge ${{ steps.pr.outputs.pr_number }} --merge --admin

      # --------------------------------------------------------
      # 7. VERIFY STATUS MOVED TO "DONE"
      # --------------------------------------------------------
      - name: Verify Done
        run: |
          ISSUE=${{ steps.issue.outputs.issue_number }}

          PROJECT_ID="PVT_kwHODgSGMM4BI6BO"
          STATUS_FIELD_ID="PVTSSF_lAHODgSGMM4BI6BOzg5OjrU"

          STATUS=$(gh api graphql -f query='
            {
              node(id:"'"$PROJECT_ID"'") {
                ... on ProjectV2 {
                  items(first:100) {
                    nodes {
                      content { ... on Issue { number } }
                      fieldValues(first:10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            fieldId
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' | jq -r '
            .data.node.items.nodes[]
            | select(.content.number == ('"$ISSUE"' | tonumber))
            | .fieldValues.nodes[]
            | select(.fieldId=="'"$STATUS_FIELD_ID"'")
            | .name
          ')

          echo "Status after merge = $STATUS"
          [[ "$STATUS" == "Done" ]] || (echo "::error::Not Done!" && exit 1)

      # --------------------------------------------------------
      # 8. CREATE SECOND ISSUE TO TEST "CLOSED WITHOUT MERGE"
      # --------------------------------------------------------
      - name: Create Issue 2
        id: issue2
        run: |
          URL=$(gh issue create \
            --title "Codex Self-Test Issue 2" \
            --body "Tests PR close behavior." \
            --label "codex-test")

          NUM=$(echo "$URL" | sed 's/.*issues\///')
          echo "issue_number=$NUM" >> $GITHUB_OUTPUT
          echo "Created issue #$NUM"

      # Assign
      - name: Assign Issue 2
        run: |
          gh issue edit ${{ steps.issue2.outputs.issue_number }} \
            --add-assignee garybayes

      # --------------------------------------------------------
      # 9. CREATE BRANCH + PR FOR ISSUE 2
      # --------------------------------------------------------
      - name: Create PR for Issue 2
        id: pr2
        run: |
          ISSUE=${{ steps.issue2.outputs.issue_number }}
          BRANCH="codex-test2-$ISSUE"

          git checkout -b "$BRANCH"
          git commit --allow-empty -m "Test close path #$ISSUE"
          git push --set-upstream origin "$BRANCH"

          URL=$(gh pr create \
            --title "Close Test (#$ISSUE)" \
            --body "Fixes #$ISSUE" \
            --base main)

          PRNUM=$(echo "$URL" | sed 's/.*pull\///')
          echo "pr_number=$PRNUM" >> $GITHUB_OUTPUT

      # --------------------------------------------------------
      # 10. CLOSE SECOND PR WITHOUT MERGE
      # --------------------------------------------------------
      - name: Close PR2
        run: |
          gh pr close ${{ steps.pr2.outputs.pr_number }} --delete-branch

      # --------------------------------------------------------
      # 11. VERIFY SECOND ISSUE RETURNED TO TODO
      # --------------------------------------------------------
      - name: Verify Back to Todo
        run: |
          ISSUE=${{ steps.issue2.outputs.issue_number }}

          PROJECT_ID="PVT_kwHODgSGMM4BI6BO"
          STATUS_FIELD_ID="PVTSSF_lAHODgSGMM4BI6BOzg5OjrU"

          STATUS=$(gh api graphql -f query='
            {
              node(id:"'"$PROJECT_ID"'") {
                ... on ProjectV2 {
                  items(first:100) {
                    nodes {
                      content { ... on Issue { number } }
                      fieldValues(first:10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            fieldId
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' | jq -r '
            .data.node.items.nodes[]
            | select(.content.number == ('"$ISSUE"' | tonumber))
            | .fieldValues.nodes[]
            | select(.fieldId=="'"$STATUS_FIELD_ID"'")
            | .name
          ')

          echo "Status after PR close = $STATUS"
          [[ "$STATUS" == "Todo" ]] || (echo "::error::Not Todo!" && exit 1)

      # --------------------------------------------------------
      # FINAL SUMMARY
      # --------------------------------------------------------
      - name: Summary
        run: |
          echo ""
          echo "======================================================"
          echo "ðŸŸ¢ CODEX SELF TEST COMPLETE â€” ALL AUTOMATION VERIFIED "
          echo "======================================================"
          echo "âœ“ Assignment Trigger"
          echo "âœ“ Commit Status Trigger"
          echo "âœ“ PR Opened Trigger"
          echo "âœ“ PR Merged Trigger"
          echo "âœ“ PR Closed Trigger"
          echo "âœ“ ProjectV2 Status Field Updates"
          echo "âœ“ All Workflow Paths Functional"
          echo ""
