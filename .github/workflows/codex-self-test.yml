---
name: Codex Self-Test v6

"on":
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  codex-selftest:
    name: Codex Self-Test
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      CODEX_SELFTEST_MILESTONE: ${{ vars.CODEX_SELFTEST_MILESTONE }}
      CODEX_SELFTEST_DEFAULT_MILESTONE: "Codex Internal"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        uses: cli/cli@v3
        with:
          version: latest

      - name: Run Codex Self-Test
        run: |
          set -euo pipefail

          REPO="${GITHUB_REPOSITORY}"
          OWNER="${REPO%/*}"
          REPO_NAME="${REPO#*/}"

          mkdir -p gh-pages/telemetry

          ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          telemetry="gh-pages/telemetry/self-test-${GITHUB_RUN_ID}.json"

          # Determine milestone
          M="${CODEX_SELFTEST_MILESTONE:-$CODEX_SELFTEST_DEFAULT_MILESTONE}"

          # Verify milestone exists
          MS_ID=$(gh api \
            "/repos/${OWNER}/${REPO_NAME}/milestones" \
            --jq ".[] | select(.title == \"$M\") | .number" || true)

          if [[ -z "$MS_ID" ]]; then
            printf \
              '{"component":"selftest","status":"error","reason":"missing_milestone",\
              "milestone":"%s","timestamp":"%s","run_id":"%s","run_number":"%s","repository":"%s"}' \
              "$M" "$ts" "${GITHUB_RUN_ID}" "${GITHUB_RUN_NUMBER}" "$REPO" \
              > "$telemetry"
            exit 0
          fi

          title="[Codex Self-Test] $ts"
          body="Codex self-test issue created automatically."

          issue_num=$(
            gh issue create \
              --title "$title" \
              --body "$body" \
              --label "codex" \
              --label "codex-selftest" \
              --milestone "$M" \
              --json number \
              --jq '.number'
          )

          printf \
            '{"component":"selftest","status":"ok","milestone":"%s",\
            "issue_number":%s,"timestamp":"%s","run_id":"%s","run_number":"%s","repository":"%s"}' \
            "$M" "$issue_num" "$ts" "${GITHUB_RUN_ID}" "${GITHUB_RUN_NUMBER}" "$REPO" \
            > "$telemetry"
