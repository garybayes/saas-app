---
name: "Codex Self-Test (v7)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

env:
  CODEX_COMPONENT: selftest
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  selftest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Create self-test issue
        id: create
        working-directory: repo
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          TS="$(date -u +"%Y-%m-%d %H:%M UTC")"

          ms_num="$(gh variable get CODEX_SELFTEST_MILESTONE --repo "$OWNER/$REPO" --jq '.value')"

          title="Codex Self-Test: $TS"

          issue_json=$(gh api \
            --method POST \
            "/repos/$OWNER/$REPO/issues" \
            -f title="$title" \
            -f body="Codex Self-Test Run" \
            -f labels='["codex","codex-selftest"]' \
            -f milestone="$ms_num")

          num=$(echo "$issue_json" | jq -r '.number')

          echo "Created issue: $num"
          echo "issue_number=$num" >> "$GITHUB_OUTPUT"

      - name: Commit telemetry
        working-directory: gh-pages
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/*.json
          git commit -m "Self-Test telemetry update" || echo "No changes"
          git push origin gh-pages

      - name: Write Telemetry (Always-On)
        if: always()
        working-directory: gh-pages
        run: |
          mkdir -p telemetry
          ts="$(date -u +"%Y%m%dT%H%M%SZ")"
          outfile="telemetry/selftest-$ts.json"

          {
            printf '{\n'
            printf '  "component": "selftest",\n'
            printf '  "timestamp": "%s",\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            printf '  "issue_created": "%s",\n' "${{ steps.create.outputs.issue_number }}"
            printf '  "repository": "%s"\n' "$GITHUB_REPOSITORY"
            printf '}\n'
          } > "$outfile"

          git add telemetry/*.json
          git commit -m "Self-Test telemetry write" || echo "No changes"
          git push origin gh-pages
