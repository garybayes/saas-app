name: Codex Self-Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  codex-self-test:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PROJECT_ID: "PVT_kwHODgSGMM4BI6BO"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # 1. CREATE ISSUE INSIDE PROJECT
      # ----------------------------------------------------------
      - name: Create test issue
        id: create_issue
        run: |
          ISSUE_URL=$(gh issue create \
            --title "Codex Self-Test Issue" \
            --body "Automated Codex self-test: verifying issue → project → PR → merge → close pipeline." \
            --project "$PROJECT_ID")

          echo "Issue URL: $ISSUE_URL"

          ISSUE_NUMBER=$(echo "$ISSUE_URL" | sed 's/.*#//')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 2. CREATE BRANCH FOR PR
      # ----------------------------------------------------------
      - name: Create test branch
        run: |
          git switch -c codex-selftest-${{ steps.create_issue.outputs.issue_number }}
          echo "Self-test $(date)" > codex-selftest.txt
          git add codex-selftest.txt
          git commit -m "Codex self-test commit (issue #${{ steps.create_issue.outputs.issue_number }})"
          git push origin HEAD

      # ----------------------------------------------------------
      # 3. OPEN PR REFERENCING ISSUE
      # ----------------------------------------------------------
      - name: Open self-test PR
        id: create_pr
        run: |
          PR_URL=$(gh pr create \
            --title "Codex Self-Test PR" \
            --body "This PR was automatically generated for Codex self-test.\n\nFixes #${{ steps.create_issue.outputs.issue_number }}" \
            --head "codex-selftest-${{ steps.create_issue.outputs.issue_number }}" \
            --base main)

          echo "PR URL: $PR_URL"
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 4. MERGE THE PR (simulate Codex success)
      # ----------------------------------------------------------
      - name: Merge PR
        run: |
          gh pr merge "${{ steps.create_pr.outputs.pr_url }}" --squash --delete-branch

      # ----------------------------------------------------------
      # 5. CLOSE THE ISSUE (project automation will move it to Done)
      # ----------------------------------------------------------
      - name: Close issue
        run: |
          gh issue close ${{ steps.create_issue.outputs.issue_number }} --comment "Codex self-test complete."
