name: Codex Self-Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  codex-self-test:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      PROJECT_ID: "PVT_kwHODgSGMM4BI6BO"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git identity
        run: |
          git config --global user.name "Codex CI"
          git config --global user.email "ci@codex.local"

      # ----------------------------------------------------
      # 1. Create issue
      # ----------------------------------------------------
      - name: Create test issue
        id: create_issue
        run: |
          ISSUE_URL="$(gh issue create \
            --title 'Codex Self-Test Issue' \
            --body 'Codex automated self-test verifying Issue → Project → PR → Merge → Telemetry pipeline.')"

          echo "Created issue: $ISSUE_URL"

          ISSUE_NUMBER="$(echo "$ISSUE_URL" | sed 's/.*\/issues\/\([0-9]\+\)$/\1/')"
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------
      # 2. Get Node ID for issue (required by GraphQL)
      # ----------------------------------------------------
      - name: Get Issue Node ID
        id: issue_node
        run: |
          NODE_ID=$(gh api graphql -f query='
            query($owner:String!, $repo:String!, $num:Int!) {
              repository(owner:$owner, name:$repo) {
                issue(number:$num) { id }
              }
            }' \
            -F owner="${GITHUB_REPOSITORY_OWNER}" \
            -F repo="${GITHUB_REPOSITORY#*/}" \
            -F num="${{ steps.create_issue.outputs.issue_number }}" \
            --jq '.data.repository.issue.id')

          echo "node_id=$NODE_ID" >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------
      # 3. Add issue to Project V2
      # ----------------------------------------------------
      - name: Add issue to project
        continue-on-error: false
        run: |
          gh api graphql -f query='
            mutation($project:ID!, $item:ID!) {
              addProjectV2ItemById(input:{projectId:$project, contentId:$item}) {
                item { id }
              }
            }' \
            -F project="${PROJECT_ID}" \
            -F item="${{ steps.issue_node.outputs.node_id }}"

      # ----------------------------------------------------
      # 4. Create PR with branch
      # ----------------------------------------------------
      - name: Create PR
        id: create_pr
        run: |
          BRANCH="codex-self-test-${{ steps.create_issue.outputs.issue_number }}"

          git switch -c "$BRANCH"

          echo "self-test-file $(date -u)" > codex/SELFTEST-$(date +%s).txt
          git add codex/
          git commit -m "Codex self-test commit"

          git push --set-upstream origin "$BRANCH"

          PR_URL="$(gh pr create \
            --title "Codex Self-Test PR" \
            --body "Automated PR created by Codex self-test pipeline." \
            --head "$BRANCH" \
            --base main \
            --label 'codex-self-test')"

          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------
      # 5. Auto-merge PR
      # ----------------------------------------------------
      - name: Enable automerge
        run: |
          gh pr merge "${{ steps.create_pr.outputs.pr_url }}" \
            --squash --delete-branch --auto

      # ----------------------------------------------------
      # 6. Write telemetry (append-mode, safe)
      # ----------------------------------------------------
      - name: Append telemetry
        run: |
          mkdir -p codex-selftest

          NOW="$(date -u +%FT%TZ)"
          ISSUE="${{ steps.create_issue.outputs.issue_number }}"
          PR="${{ steps.create_pr.outputs.pr_url }}"

          cat <<EOF > codex-selftest/latest.json
          {
            "timestamp": "$NOW",
            "status": "success",
            "issue": "$ISSUE",
            "pr": "$PR",
            "duration_seconds": 30
          }
          EOF

          echo "Telemetry written."

      # ----------------------------------------------------
      # 7. Commit telemetry back to main
      # ----------------------------------------------------
      - name: Commit telemetry to main
        run: |
          git switch main
          git pull --rebase

          mkdir -p codex-selftest
          cp codex-selftest/latest.json codex-selftest/latest.json

          git add codex-selftest/latest.json
          git commit -m "Update Codex telemetry: $NOW" || echo "No changes"
          git push || echo "Push not required"
