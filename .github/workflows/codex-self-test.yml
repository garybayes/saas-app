---
# yamllint disable rule:truthy
name: Codex â€“ Self-Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write
  issues: write
  repository-projects: write

jobs:
  codex-self-test:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      REPO: ${{ github.repository }}
      PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 1

      - name: Git identity
        run: |
          git config --global user.name "codex-ci-bot"
          git config --global user.email "codex-ci-bot@users.noreply.github.com"

      # ------------------------------------------------------------------
      # 1. Create issue
      # ------------------------------------------------------------------
      - name: Create self-test issue
        id: issue
        run: |
          ISSUE_URL=$(gh issue create \
            --title "Codex Self-Test Issue" \
            --body  "Routine Codex self-test cycle.")
          NUM=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')
          echo "number=$NUM" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------------
      # 2. Add to project
      # ------------------------------------------------------------------
      - name: Add issue to project
        run: |
          NUM="${{ steps.issue.outputs.number }}"

          NODE=$(gh api graphql -f query='
            query($owner:String!, $repo:String!, $num:Int!) {
              repository(owner:$owner, name:$repo) {
                issue(number:$num) { id }
              }
            }' \
            -F owner="${GITHUB_REPOSITORY_OWNER}" \
            -F repo="${GITHUB_REPOSITORY#*/}" \
            -F num="$NUM")

          ID=$(echo "$NODE" | grep -oE '"id":"[^"]+"' | sed 's/"id":"\(.*\)"/\1/')

          gh api graphql -f query='
            mutation($project:ID!, $item:ID!) {
              addProjectV2ItemById(input:{projectId:$project, contentId:$item}) {
                item { id }
              }
            }' \
            -F project="$PROJECT_ID" \
            -F item="$ID"

      # ------------------------------------------------------------------
      # 3. Close issue
      # ------------------------------------------------------------------
      - name: Close issue
        run: |
          gh issue close "${{ steps.issue.outputs.number }}" \
            --comment "Codex self-test cycle successful."

      # ------------------------------------------------------------------
      # 4. Write telemetry
      # ------------------------------------------------------------------
      - name: Write telemetry
        run: |
          mkdir -p activity-telemetry
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          N="${{ steps.issue.outputs.number }}"

          printf '{\n'                                >  activity-telemetry/latest.json
          printf '  "timestamp": "%s",\n' "$TS"      >> activity-telemetry/latest.json
          printf '  "selftest_issue": %s,\n' "$N"    >> activity-telemetry/latest.json
          printf '  "selftest_status": "success",\n' >> activity-telemetry/latest.json
          printf '  "source": "codex-self-test"\n'   >> activity-telemetry/latest.json
          printf '}\n'                               >> activity-telemetry/latest.json

          git add activity-telemetry/latest.json
          git commit -m "Codex Self-Test Telemetry [skip ci]" || echo "no changes"
          git push origin gh-pages || echo "push skipped"

      # ------------------------------------------------------------------
      # 5. Trigger merge workflow
      # ------------------------------------------------------------------
      - name: Trigger telemetry merge
        run: |
          gh workflow run codex-telemetry-merge.yml || true
