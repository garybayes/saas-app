name: Codex Self-Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  codex-self-test:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PROJECT_ID: "PVT_kwHODgSGMM4BI6BO"

    steps:
      # -------------------------------
      # 0. Checkout
      # -------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------------------------------
      # 1. Create a test issue
      # -------------------------------
      - name: Create test issue
        id: create_issue
        run: |
          ISSUE_URL=$(gh issue create \
            --title "Codex Self-Test Issue" \
            --body "Automated Codex self-test: validating pipeline")

          echo "ISSUE_URL=$ISSUE_URL"

          ISSUE_NUMBER=$(echo "$ISSUE_URL" | sed 's/.*#//' | tr -d '\n' | tr -d '[:space:]')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          echo "Extracted ISSUE_NUMBER: $ISSUE_NUMBER"

      # -------------------------------
      # 2. Convert issue â†’ GraphQL node ID
      # -------------------------------
      - name: Resolve issue node ID
        id: issue_node
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO="${GITHUB_REPOSITORY#*/}"
          NUM="${{ steps.create_issue.outputs.issue_number }}"

          NUM_CLEAN=$(echo "$NUM" | tr -d '[:space:]')
          echo "NUM_CLEAN=$NUM_CLEAN"

          ISSUE_NODE_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $num: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $num) { id }
              }
            }
          ' -F owner="$OWNER" -F repo="$REPO" -F num="$NUM_CLEAN" --jq '.data.repository.issue.id')

          echo "ISSUE_NODE_ID=$ISSUE_NODE_ID"
          echo "issue_node_id=$ISSUE_NODE_ID" >> $GITHUB_OUTPUT

      # -------------------------------
      # 3. Add issue to Codex project
      # -------------------------------
      - name: Add issue to project
        id: project_add
        run: |
          gh api graphql -f query='
            mutation($project: ID!, $content: ID!) {
              addProjectV2ItemById(input: {
                projectId: $project,
                contentId: $content
              }) {
                item { id }
              }
            }
          ' -F project="$PROJECT_ID" -F content="${{ steps.issue_node.outputs.issue_node_id }}"

      # -------------------------------
      # 4. Create PR for the test
      # -------------------------------
      - name: Create self-test PR
        id: create_pr
        run: |
          BRANCH="codex-selftest-$(date +%s)"
          git checkout -b "$BRANCH"

          echo "// selftest $(date)" > codex-selftest.js
          git add codex-selftest.js
          git commit -m "Codex self-test commit"

          git push -u origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "Codex Self-Test PR" \
            --body "Automated PR for Codex pipeline validation" \
            --head "$BRANCH")

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      # -----------
