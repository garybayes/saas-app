name: Codex Self-Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  codex-self-test:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      PROJECT_ID: "PVT_kwHODgSGMM4BI6BO"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # 1. Create self-test issue
      # ----------------------------------------------------------
      - name: Create test issue
        id: create_issue
        run: |
          ISSUE_URL=$(gh issue create \
            --title "Codex Self-Test Issue" \
            --body "Codex automated self-test: verifies issue → project → PR → merge → close pipeline.")

          echo "Issue URL: $ISSUE_URL"

          ISSUE_NUMBER=$(echo "$ISSUE_URL" | sed 's/.*#//')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 2. Add issue to ProjectV2
      # ----------------------------------------------------------
      - name: Add issue to project
        id: add_to_project
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO="$(basename $GITHUB_REPOSITORY)"
          NUM="${{ steps.create_issue.outputs.issue_number }}"

          ISSUE_NODE_ID=$(gh api graphql -f query='
            query($repo: String!, $owner: String!, $num: Int!) {
              repository(name: $repo, owner: $owner) {
                issue(number: $num) { id }
              }
            }' \
            -f owner="$OWNER" -f repo="$REPO" -f num="$NUM" \
            --jq '.data.repository.issue.id')

          echo "ISSUE_NODE_ID=$ISSUE_NODE_ID"

          gh api graphql -f query='
            mutation($project: ID!, $node: ID!) {
              addProjectV2ItemById(input: {projectId: $project, contentId: $node}) {
                item { id }
              }
            }' \
            -f project="$PROJECT_ID" -f node="$ISSUE_NODE_ID"

      # ----------------------------------------------------------
      # 3. Create a branch & commit a test file
      # ----------------------------------------------------------
      - name: Create branch and commit file
        id: commit_file
        run: |
          ISSUE="${{ steps.create_issue.outputs.issue_number }}"
          BRANCH="codex-self-test-$ISSUE"

          git checkout -b "$BRANCH"

          git config --global user.name "codex-ci-bot"
          git config --global user.email "codex-bot@users.noreply.github.com"

          echo "Codex self-test file for issue $ISSUE" > "selftest-$ISSUE.txt"

          git add .
          git commit -m "Codex self-test commit (#$ISSUE)"
          git push origin "$BRANCH"

          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 4. Create Pull Request
      # ----------------------------------------------------------
      - name: Open Pull Request
        id: open_pr
        run: |
          PR_URL=$(gh pr create \
            --title "Codex Self-Test PR (#${{ steps.create_issue.outputs.issue_number }})" \
            --body "Automated PR for Codex self-test." \
            --head "${{ steps.commit_file.outputs.branch_name }}" \
            --base "main")

          echo "PR URL: $PR_URL"

          PR_NUMBER=$(echo "$PR_URL" | sed 's/.*\/pull\/\([0-9]*\).*/\1/')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 5. Merge the PR
      # ----------------------------------------------------------
      - name: Merge PR
        run: |
          gh pr merge ${{ steps.open_pr.outputs.pr_number }} \
            --squash --delete-branch

      # ----------------------------------------------------------
      # 6. Record telemetry results
      # ----------------------------------------------------------
      - name: Record self-test telemetry
        run: |
          mkdir -p codex-selftest

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat <<EOF > codex-selftest/latest.json
{
  "timestamp": "$TIMESTAMP",
  "status": "success",
  "issue": ${steps.create_issue.outputs.issue_number},
  "pr": ${steps.open_pr.outputs.pr_number},
  "duration_seconds": 30
}
EOF

          git pull --rebase
          git add codex-selftest/latest.json
          git commit -m "Codex self-test telemetry update"
          git push origin main
