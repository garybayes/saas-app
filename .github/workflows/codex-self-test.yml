name: Codex Self-Test

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  self-test:
    name: Codex Automated Self-Test
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # REQUIRED for gh CLI
      PROJECT_TITLE: "Codex Dual-Track Development"
      STATUS_FIELD: "Status"
      TODO_VALUE: "Todo"
      INPROGRESS_VALUE: "In Progress"
      DONE_VALUE: "Done"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # 1️⃣ Create Self-Test Issue
      # -----------------------------------------------------
      - name: Create test issue
        id: create_issue
        run: |
          ISSUE_URL=$(gh issue create \
            --title "Codex Self-Test Issue" \
            --body "This issue was automatically created by the Codex self-test workflow." \
            --label "codex-self-test" \
            --project "$PROJECT_TITLE")

          echo "Issue URL: $ISSUE_URL"
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | sed 's/.*#//')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      # -----------------------------------------------------
      # 2️⃣ Create a PR that references the issue
      # -----------------------------------------------------
      - name: Create PR branch & commit
        run: |
          git config user.email "codex-ci-bot@github"
          git config user.name  "codex-ci-bot"

          BRANCH="codex-selftest-${{ steps.create_issue.outputs.issue_number }}"
          git checkout -b "$BRANCH"

          echo "Self-test run at $(date)" > codex-selftest.txt
          git add codex-selftest.txt
          git commit -m "Codex self-test commit (#${{ steps.create_issue.outputs.issue_number }})"
          git push origin "$BRANCH"

      - name: Create PR
        id: create_pr
        run: |
          PR_URL=$(gh pr create \
            --title "Codex Self-Test PR" \
            --body "This PR was generated to verify Codex automation end-to-end.\n\nFixes #${{ steps.create_issue.outputs.issue_number }}" \
            --head "codex-selftest-${{ steps.create_issue.outputs.issue_number }}" \
            --base "main")

          echo "PR URL: $PR_URL"
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      # -----------------------------------------------------
      # 3️⃣ Wait briefly for project automation
      # -----------------------------------------------------
      - name: Wait for project automation
        run: sleep 8

      # -----------------------------------------------------
      # 4️⃣ Close PR (simulating Codex merging/closing)
      # -----------------------------------------------------
      - name: Close PR
        run: |
          gh pr close "${{ steps.create_pr.outputs.pr_url }}" --comment "Closing PR as part of Codex self-test."

      # -----------------------------------------------------
      # 5️⃣ Close Issue
      # -----------------------------------------------------
      - name: Close issue
        run: |
          gh issue close ${{ steps.create_issue.outputs.issue_number }} \
            --comment "Codex self-test workflow completed."

      # -----------------------------------------------------
      # 6️⃣ Cleanup branch
      # -----------------------------------------------------
      - name: Delete test branch
        run: |
          gh api --method DELETE \
            repos/${{ github.repository }}/git/refs/heads/codex-selftest-${{ steps.create_issue.outputs.issue_number }} \
            || echo "Branch already deleted"

      # -----------------------------------------------------
      # 7️⃣ Finished
      # -----------------------------------------------------
      - name: Done
        run: echo "Codex self-test workflow completed successfully."

