---
name: Codex Self-Test v6

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

jobs:
  selftest:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Determine milestone
        id: ms
        working-directory: repo
        run: |
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          # Use repo variable if set, otherwise fallback to Codex Internal
          SELFTEST_MILESTONE_TITLE="$(gh variable get CODEX_SELFTEST_MILESTONE -q 2>/dev/null || echo 'Codex Internal')"

          ms_json="$(gh api "/repos/$OWNER/$REPO/milestones")"
          SELFTEST_MILESTONE_NUMBER="$( \
            echo "$ms_json" | jq -r \
            --arg T "$SELFTEST_MILESTONE_TITLE" \
            '.[] | select(.title == $T) | .number' \
          )"

          if [ -z "$SELFTEST_MILESTONE_NUMBER" ] || [ "$SELFTEST_MILESTONE_NUMBER" = "null" ]; then
            echo "Milestone not found â†’ skipping self-test."
            echo "skip=yes" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=no" >> "$GITHUB_OUTPUT"
          echo "title=$SELFTEST_MILESTONE_TITLE" >> "$GITHUB_OUTPUT"
          echo "number=$SELFTEST_MILESTONE_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Skip if milestone missing
        if: steps.ms.outputs.skip == 'yes'
        run: echo "Self-test skipped because milestone missing."

      - name: Create Self-Test Issue
        if: steps.ms.outputs.skip == 'no'
        working-directory: repo
        run: |
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          SELFTEST_MILESTONE_TITLE="${{ steps.ms.outputs.title }}"

          ISSUE_TITLE="Codex Self-Test: $(date -u +'%Y-%m-%d %H:%M UTC')"
          ISSUE_BODY="Automated self-test of the Codex system."

          # Create new issue using proper CLI flags
          new_issue_url="$(
            gh issue create \
              --title "$ISSUE_TITLE" \
              --body "$ISSUE_BODY" \
              --label "codex" \
              --label "codex-selftest" \
              --milestone "$SELFTEST_MILESTONE_TITLE" \
              --project "Codex Dual-Track Development"
          )"

          issue_number="$(basename "$new_issue_url")"
          echo "Created Self-Test issue #$issue_number"

      - name: Update telemetry
        working-directory: repo
        run: |
          mkdir -p ../gh-pages/telemetry
          ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          outfile="../gh-pages/telemetry/selftest-${ts}.json"

          printf '{\n' > "$outfile"
          printf '  "component": "selftest",\n' >> "$outfile"
          printf '  "timestamp": "%s"\n' "$ts" >> "$outfile"
          printf '}\n' >> "$outfile"

          echo "Wrote telemetry: $outfile"

      - name: Commit telemetry
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add telemetry/*.json
          git commit -m "Self-Test telemetry update" || echo "No changes"
          git push origin gh-pages
