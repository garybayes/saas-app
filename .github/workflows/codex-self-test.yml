name: Codex Self-Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read
  repository-projects: write

jobs:
  codex-self-test:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PROJECT_ID: "PVT_kwHODgSGMM4BI6BO"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # 1. Create Issue (GH CLI, without project assignment)
      # ----------------------------------------------------------
      - name: Create self-test issue
        id: create_issue
        run: |
          ISSUE_URL=$(gh issue create \
            --title "Codex Self-Test Issue" \
            --body "Automated Codex self-test: validating issue → project → PR → merge → telemetry.")
          
          echo "Issue URL: $ISSUE_URL"

          ISSUE_NUMBER=$(echo "$ISSUE_URL" | sed 's/.*#//')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 2. Add Issue to ProjectV2 (GraphQL)
      # ----------------------------------------------------------
      - name: Add issue to project
        id: project_add
        run: |
          ISSUE_NODE_ID=$(gh api graphql -f query='
            query($repo: String!, $owner: String!, $num: Int!) {
              repository(name: $repo, owner: $owner) {
                issue(number: $num) { id }
              }
            }
          ' -f repo="saas-app" -f owner="garybayes" -F num=${{ steps.create_issue.outputs.issue_number }} --jq '.data.repository.issue.id')

          PROJECT_ITEM_ID=$(gh api graphql -f query='
            mutation($project: ID!, $content: ID!) {
              addProjectV2ItemById(input: {
                projectId: $project,
                contentId: $content
              }) {
                item { id }
              }
            }
          ' -f project="$PROJECT_ID" -f content="$ISSUE_NODE_ID" --jq '.data.addProjectV2ItemById.item.id')

          echo "project_item_id=$PROJECT_ITEM_ID" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 3. Create branch + commit
      # ----------------------------------------------------------
      - name: Create test branch & commit
        run: |
          BRANCH="codex-selftest-${{ steps.create_issue.outputs.issue_number }}"
          git switch -c "$BRANCH"
          echo "Codex self-test $(date -u)" > codex-selftest.txt
          git add codex-selftest.txt
          git commit -m "Codex self-test commit (#${{ steps.create_issue.outputs.issue_number }})"
          git push origin "$BRANCH"

      # ----------------------------------------------------------
      # 4. Create PR
      # ----------------------------------------------------------
      - name: Open self-test PR
        id: create_pr
        run: |
          PR_URL=$(gh pr create \
            --title "Codex Self-Test PR" \
            --body "Automated Codex self-test PR.\n\nFixes #${{ steps.create_issue.outputs.issue_number }}" \
            --head "codex-selftest-${{ steps.create_issue.outputs.issue_number }}" \
            --base main)
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 5. Merge PR
      # ----------------------------------------------------------
      - name: Merge PR
        run: |
          gh pr merge "${{ steps.create_pr.outputs.pr_url }}" --squash --delete-branch

      # ----------------------------------------------------------
      # 6. Write Telemetry
      # ----------------------------------------------------------
      - name: Write telemetry to codex-build
        run: |
          mkdir -p codex-build

          END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          START_TS=$(date -d "${{ github.run_started_at }}" +%s)
          END_TS=$(date +%s)
          DURATION=$((END_TS - START_TS))

          cat <<EOF > codex-build/selftest.json
          {
            "timestamp": "$END_TIME",
            "status": "success",
            "duration_seconds": $DURATION,
            "issue": ${{ steps.create_issue.outputs.issue_number }},
            "pr": $(echo "${{ steps.create_pr.outputs.pr_url }}" | sed 's/.*pull\///')
          }
          EOF

      # ----------------------------------------------------------
      # 7. Commit telemetry into main
      # ----------------------------------------------------------
      - name: Commit telemetry
        run: |
          git config user.email "codex-ci@github.com"
          git config user.name "codex-bot"

          git add codex-build/selftest.json
          git commit -m "Update Codex self-test telemetry" || echo "No changes"
          git push origin main || echo "Push skipped"
