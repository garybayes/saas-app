name: Codex Self-Test

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read
  repository-projects: write

jobs:
  codex-self-test:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      REPO: ${{ github.event.repository.name }}
      OWNER: ${{ github.repository_owner }}
      PROJECT_ID: "PVT_kwHODgSGMM4BI6BO"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # 1. Create the test issue (NO --json flag)
      # ----------------------------------------------------------
      - name: Create test issue
        id: create_issue
        run: |
          ISSUE_URL=$(gh issue create \
            --title "Codex Self-Test Issue" \
            --assignee "@me" \
            --body "Automated Codex self-test: verifying issue → project → PR → merge → close pipeline.")

          echo "ISSUE_URL=$ISSUE_URL"

          ISSUE_NUMBER=$(echo "$ISSUE_URL" | sed -E 's#.*/issues/([0-9]+)#\1#')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 2. Lookup Issue Node ID for GraphQL
      # ----------------------------------------------------------
      - name: Fetch issue node ID
        id: issue_node
        run: |
          NODE_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $num: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $num) { id }
              }
            }' \
            -F owner=$OWNER -F repo=$REPO -F num=${{ steps.create_issue.outputs.issue_number }} \
            --jq '.data.repository.issue.id')

          echo "node_id=$NODE_ID" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # 3. Add issue to ProjectV2 (PAT required)
      # ----------------------------------------------------------
      - name: Add issue to project
        id: project_add
        run: |
          gh api graphql -f query='
            mutation($project: ID!, $item: ID!) {
              addProjectV2ItemById(input: {
                projectId: $project,
                contentId: $item
              }) {
                item { id }
              }
            }' \
            -F project=$PROJECT_ID \
            -F item=${{ steps.issue_node.outputs.node_id }}

      # ----------------------------------------------------------
      # 4. Create PR for the issue
      # ----------------------------------------------------------
      - name: Create self-test PR
        id: open_pr
        run: |
          BRANCH="codex-self-test-${{ steps.create_issue.outputs.issue_number }}"
          git switch -c "$BRANCH"

          echo "TEST=$(date)" > codex-selftest.txt
          git add codex-selftest.txt
          git commit -m "Codex self-test commit (#${{ steps.create_issue.outputs.issue_number }})"

          git push origin "$BRANC
