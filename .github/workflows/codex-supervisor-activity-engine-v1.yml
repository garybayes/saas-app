---
# yamllint disable rule:truthy
name: Codex Supervisor Activity Engine v1

on:
  schedule:
    - cron: "*/30 * * * *"   # Runs every 30 minutes
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  project: write

jobs:
  activity-engine:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 1

      - name: Configure git identity
        run: |
          git config --global user.name "codex-ci-bot"
          git config --global user.email "codex-ci-bot@users.noreply.github.com"

      ##################################################################
      # 1. SCAN REPOSITORY STATE
      #    - PRs open/stalled
      #    - Issues open/blockers
      #    - Sprint progress
      ##################################################################

      - name: Fetch open PRs
        id: prscan
        run: |
          PRS=$(gh pr list --json number,title,updatedAt,author,url)
          echo "$PRS" > pr.json
          echo "prs=$(echo "$PRS" | jq -r '. | length')" >> $GITHUB_OUTPUT

      - name: Fetch open issues
        id: issuescan
        run: |
          ISSUES=$(gh issue list --state open --json number,title,labels,updatedAt,url)
          echo "$ISSUES" > issues.json
          echo "issues=$(echo "$ISSUES" | jq -r '. | length')" >> $GITHUB_OUTPUT

      - name: Detect stale PRs
        id: stalescan
        run: |
          STALE=$(jq '[ .[] | select((now - ( .updatedAt | fromdate )) > 86400) ]' pr.json)
          echo "$STALE" > stale-prs.json
          echo "stale_count=$(echo "$STALE" | jq -r 'length')" >> $GITHUB_OUTPUT

      - name: Detect blockers (issues with label:blocked)
        id: blockerscan
        run: |
          BLOCKERS=$(jq '[ .[] | select(.labels[].name? == "blocked") ]' issues.json)
          echo "$BLOCKERS" > blockers.json
          echo "blocked_count=$(echo "$BLOCKERS" | jq -r 'length')" >> $GITHUB_OUTPUT

      ##################################################################
      # 2. PERFORM SUPERVISOR ACTIONS
      #    - For stale PRs: leave reminders
      #    - For blocked issues: tag/escalate
      #    - For sprint issues: ensure they are in the project
      ##################################################################

      - name: Leave comments on stale PRs (if any)
        if: steps.stalescan.outputs.stale_count != '0'
        run: |
          echo "Stale PRs detected. Sending reminders..."
          jq -r '.[].number' stale-prs.json | while read PR; do
            gh pr comment "$PR" --body "â° **Codex Supervisor:** This PR appears stale. Please review or update its status."
          done

      - name: Escalate blocked issues
        if: steps.blockerscan.outputs.blocked_count != '0'
        run: |
          echo "Blocked issues detected. Tagging PRIO and adding Escalation notes..."
          jq -r '.[].number' blockers.json | while read ISS; do
            gh issue edit "$ISS" --add-label "needs-attention"
            gh issue comment "$ISS" --body "ðŸš¨ **Codex Supervisor:** This issue is marked *blocked*. Please provide an update or action plan."
          done

      - name: Ensure sprint issues are added to the project
        run: |
          echo "Syncing sprint issues..."
          jq -r '.[].number' issues.json | while read ISS; do
            gh project item-add  "${{ secrets.CODex_PROJECT_ID }}" --url "https://github.com/$REPO/issues/$ISS" || true
          done

      ##################################################################
      # 3. WRITE SUPERVISOR ACTION TELEMETRY
      ##################################################################

      - name: Write Activity Engine Telemetry Snapshot
        run: |
          mkdir -p supervisor-telemetry

          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          PRS="${{ steps.prscan.outputs.prs }}"
          ISSUES="${{ steps.issuescan.outputs.issues }}"
          STALE="${{ steps.stalescan.outputs.stale_count }}"
          BLOCKED="${{ steps.blockerscan.outputs.blocked_count }}"

          printf '{\n' > supervisor-telemetry/latest.json
          printf '  "timestamp": "%s",\n' "$TS" >> supervisor-telemetry/latest.json
          printf '  "status": "ok",\n' >> supervisor-telemetry/latest.json
          printf '  "source": "activity-engine-v1",\n' >> supervisor-telemetry/latest.json
          printf '  "pr_open": %s,\n' "$PRS" >> supervisor-telemetry/latest.json
          printf '  "issues_open": %s,\n' "$ISSUES" >> supervisor-telemetry/latest.json
          printf '  "pr_stale": %s,\n' "$STALE" >> supervisor-telemetry/latest.json
          printf '  "issues_blocked": %s\n' "$BLOCKED" >> supervisor-telemetry/latest.json
          printf '}\n' >> supervisor-telemetry/latest.json

      - name: Commit telemetry
        run: |
          git add supervisor-telemetry/latest.json
          git commit -m "Supervisor Activity Engine telemetry [skip ci]" || echo "No changes."

          git pull --rebase origin gh-pages || git rebase --abort
          git push origin gh-pages

      ##################################################################
      # 4. TRIGGER MERGE WORKFLOW
      ##################################################################

      - name: Trigger merge workflow
        run: |
          gh workflow run codex-telemetry-merge.yml
          echo "Triggered post-activity telemetry merge."
