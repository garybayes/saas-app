---
# yamllint disable rule:truthy
name: Codex – Activity Engine

on:
  schedule:
    - cron: "*/20 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  repository-projects: write

jobs:
  activity-engine:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      REPO: ${{ github.repository }}
      ACTIVITY_STALE: ${{ vars.CODEX_ACTIVITY_STALE_DAYS }}
      ACTIVITY_ESC: ${{ vars.CODEX_ACTIVITY_ESCALATE_DAYS }}

    steps:
      - name: Start Activity Engine
        run: |
          echo "Codex Activity Engine starting…"
          gh --version

      # -------------------------------------------------------------
      # 1. Get all open issues with activity label
      # -------------------------------------------------------------
      - name: Fetch issues
        id: fetch
        run: |
          ISSUES=$(gh issue list --state open --label "activity" --json number,title,updatedAt,url)
          echo "$ISSUES" > activity.json

          COUNT=$(echo "$ISSUES" | jq 'length')
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      # -------------------------------------------------------------
      # 2. Apply stale/escalation logic
      # -------------------------------------------------------------
      - name: Process activity issues
        run: |
          NOW=$(date -u +%s)

          jq '.[]' activity.json | while read -r ITEM; do
            NUM=$(echo "$ITEM" | jq '.number')
            UPDATED=$(echo "$ITEM" | jq -r '.updatedAt')
            URL=$(echo "$ITEM" | jq -r '.url')

            UPDATED_TS=$(date -u -d "$UPDATED" +%s)
            AGE_DAYS=$(( (NOW - UPDATED_TS) / 86400 ))

            echo "Activity Issue #$NUM | Age: ${AGE_DAYS} days | $URL"

            if [ "$AGE_DAYS" -ge "$ACTIVITY_ESC" ]; then
              gh issue comment "$NUM" --body "[Activity Engine] Escalated after $ACTIVITY_ESC days."
              gh issue edit "$NUM" --add-label "codex:escalated"
            elif [ "$AGE_DAYS" -ge "$ACTIVITY_STALE" ]; then
              gh issue comment "$NUM" --body "[Activity Engine] Stale after $ACTIVITY_STALE days."
              gh issue edit "$NUM" --add-label "codex:stale"
            fi
          done

      # -------------------------------------------------------------
      # 3. Emit telemetry
      # -------------------------------------------------------------
      - name: Write telemetry
        run: |
          mkdir -p codex-telemetry
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          printf '{\n'                         >  codex-telemetry/activity.json
          printf '  "timestamp": "%s",\n' "$TS" >> codex-telemetry/activity.json
          printf '  "activity_count": %s,\n' "${{ steps.fetch.outputs.count }}" >> codex-telemetry/activity.json
          printf '  "source": "activity-engine"\n' >> codex-telemetry/activity.json
          printf '}\n'                       >> codex-telemetry/activity.json

      # -------------------------------------------------------------
      # 4. Trigger telemetry merge
      # -------------------------------------------------------------
      - name: Trigger telemetry merge
        run: |
          gh workflow run codex-telemetry-merge.yml || true
