---
# yamllint disable rule:truthy
name: Codex Activity Engine Supervisor

on:
  workflow_dispatch:
  schedule:
    - cron: "15 * * * *"

permissions:
  contents: write
  issues: write

jobs:
  activity:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Enable GitHub CLI
        run: gh --version
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Validate project_items.json exists
        run: |
          if [[ ! -f "project_items.json" ]]; then
            echo "::error::Missing project_items.json in gh-pages"
            exit 1
          fi

      - name: Run Activity Engine
        id: engine
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          FILE="project_items.json"
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          issues=$(jq -c '.[]' "$FILE")
          total=0

          echo "{}" > activity-telemetry/latest.json

          for row in $issues; do
            total=$((total+1))
          done

          jq -n --arg ts "$NOW" --argjson total "$total" '
          {
            activity: {
              timestamp: $ts,
              items_checked: $total
            }
          }' > activity-telemetry/latest.json

          echo "ok=true" >> $GITHUB_OUTPUT

      - name: Commit activity telemetry
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git add activity-telemetry/latest.json
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git commit -m "[skip ci] Activity Engine Telemetry" || true
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" gh-pages
