# yamllint disable rule:truthy
---
name: Codex Activity Engine Supervisor

on:
  schedule:
    - cron: "15 */6 * * *"   # Offset from dual-track by 15 minutes
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  repository-projects: write

jobs:
  activity:
    name: Codex Activity Engine
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      ACTIVITY_STALE: ${{ vars.CODEX_ACTIVITY_STALE_DAYS }}
      ACTIVITY_ESCALATE: ${{ vars.CODEX_ACTIVITY_ESCALATE_DAYS }}

    steps:
      # -----------------------------------------------------------
      # 1. Setup
      # -----------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq & GNU date support
        run: |
          sudo apt-get update
          sudo apt-get install -y jq coreutils

      # -----------------------------------------------------------
      # 2. Fetch all open issues (not milestone-limited)
      # -----------------------------------------------------------
      - name: Fetch all open issues
        id: fetch
        run: |
          echo "Fetching all open issues..."

          gh issue list \
            --state open \
            --limit 200 \
            --json number,title,updatedAt,createdAt,labels \
            > issues.json

          echo "issues_json=issues.json" >> "$GITHUB_OUTPUT"

      # -----------------------------------------------------------
      # 3. Process activity-based stale/escalation
      # -----------------------------------------------------------
      - name: Activity Logic
        id: activity
        run: |
          FILE="${{ steps.fetch.outputs.issues_json }}"

          echo "Processing activity-based stale/escalation rules..."
          ISSUES=$(jq -c '.[]' "$FILE")

          NOW_TS=$(date +%s)

          while IFS= read -r ISSUE; do
            NUM=$(jq -r '.number' <<< "$ISSUE")
            TITLE=$(jq -r '.title' <<< "$ISSUE")
            UPDATED=$(jq -r '.updatedAt' <<< "$ISSUE")
            LABELS=$(jq -r '.labels[].name' <<< "$ISSUE" || true)

            UPDATED_TS=$(date -d "$UPDATED" +%s)
            DIFF_DAYS=$(( (NOW_TS - UPDATED_TS) / 86400 ))

            echo "#$NUM â€” $TITLE (updated $DIFF_DAYS days ago)"

            # -------------------------------
            # Stale threshold
            # -------------------------------
            if [[ $DIFF_DAYS -ge $ACTIVITY_STALE && $DIFF_DAYS -lt $ACTIVITY_ESCALATE ]]; then
              if [[ "$LABELS" != *"stale"* ]]; then
                echo "  â†’ Marking stale"
                gh issue edit "$NUM" --add-label "stale"
                gh issue comment "$NUM" --body "â³ This issue has been marked **stale** due to inactivity ($DIFF_DAYS days)."
              fi
            fi

            # -------------------------------
            # Escalation threshold
            # -------------------------------
            if [[ $DIFF_DAYS -ge $ACTIVITY_ESCALATE ]]; then
              if [[ "$LABELS" != *"needs-attention"* ]]; then
                echo "  â†’ Escalating"
                gh issue edit "$NUM" --add-label "needs-attention"
                gh issue comment "$NUM" --body "ðŸš¨ This issue requires **attention** â€” no updates for $DIFF_DAYS days."
              fi
            fi

          done <<< "$ISSUES"

      # -----------------------------------------------------------
      # 4. Write activity telemetry snapshot
      # -----------------------------------------------------------
      - name: Write activity telemetry snapshot
        run: |
          TS=$(date +%s)
          OUT_DIR="activity-telemetry"
          OUT="$OUT_DIR/activity-$TS.json"

          mkdir -p "$OUT_DIR"
          cp issues.json "$OUT"

          echo "Telemetry written: $OUT"

      # -----------------------------------------------------------
      # 5. Summary
      # -----------------------------------------------------------
      - name: Activity Summary
        run: |
          echo "---------------------------------------"
          echo "Codex Activity Engine Supervisor Completed"
          echo "---------------------------------------"
