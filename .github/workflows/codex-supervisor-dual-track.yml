---
# yamllint disable rule:truthy
name: Codex – Dual-Track Supervisor

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  repository-projects: write

jobs:
  supervisor:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      REPO: ${{ github.repository }}
      PROJECT_URL: ${{ vars.CODEX_PROJECT_URL }}
      PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}
      MAIN_MILESTONE: ${{ vars.CODEX_MAIN_MILESTONE }}
      DASH_MILESTONE: ${{ vars.CODEX_DASHBOARD_MILESTONE }}
      MAIN_STALE: ${{ vars.CODEX_MAIN_STALE_DAYS }}
      MAIN_ESC: ${{ vars.CODEX_MAIN_ESCALATE_DAYS }}
      DASH_STALE: ${{ vars.CODEX_DASHBOARD_STALE_DAYS }}
      DASH_ESC: ${{ vars.CODEX_DASHBOARD_ESCALATE_DAYS }}

    steps:
      - name: Start Supervisor
        run: |
          echo "Codex Dual-Track Supervisor starting…"
          gh --version

      # -------------------------------------------------------------
      # 1. Load all open issues
      # -------------------------------------------------------------
      - name: Fetch issues
        id: fetch
        run: |
          ISSUES=$(gh issue list --state open --json number,title,milestone,updatedAt,url)
          echo "$ISSUES" > issues.json

          MAIN_COUNT=$(echo "$ISSUES" | jq --arg M "$MAIN_MILESTONE" '[.[] | select(.milestone.title == $M)] | length')
          DASH_COUNT=$(echo "$ISSUES" | jq --arg M "$DASH_MILESTONE" '[.[] | select(.milestone.title == $M)] | length')

          echo "main_count=$MAIN_COUNT" >> $GITHUB_OUTPUT
          echo "dash_count=$DASH_COUNT" >> $GITHUB_OUTPUT

      # -------------------------------------------------------------
      # 2. Process each track
      # -------------------------------------------------------------
      - name: Evaluate stale/escalation
        run: |
          NOW=$(date -u +%s)

          process_track () {
            TRACK_NAME="$1"
            MILESTONE="$2"
            STALE="$3"
            ESC="$4"

            echo "Processing track: $TRACK_NAME (milestone: $MILESTONE)"

            jq --arg M "$MILESTONE" '.[] | select(.milestone.title == $M)' issues.json |
            while read -r ITEM; do
              NUM=$(echo "$ITEM" | jq '.number')
              UPDATED=$(echo "$ITEM" | jq -r '.updatedAt')
              URL=$(echo "$ITEM" | jq -r '.url')

              UPDATED_TS=$(date -u -d "$UPDATED" +%s)
              AGE_DAYS=$(( (NOW - UPDATED_TS) / 86400 ))

              echo "Issue #$NUM | Age: ${AGE_DAYS} days | $URL"

              if [ "$AGE_DAYS" -ge "$ESC" ]; then
                echo "Escalating #$NUM"
                gh issue comment "$NUM" --body "[Codex Supervisor] Issue has exceeded escalation threshold ($ESC days)."
                gh issue edit "$NUM" --add-label "codex:escalated"
              elif [ "$AGE_DAYS" -ge "$STALE" ]; then
                echo "Marking stale #$NUM"
                gh issue comment "$NUM" --body "[Codex Supervisor] Issue has become stale ($STALE days)."
                gh issue edit "$NUM" --add-label "codex:stale"
              fi

            done
          }

          # Main development track
          process_track "Main" "$MAIN_MILESTONE" "$MAIN_STALE" "$MAIN_ESC"

          # Dashboard track
          process_track "Dashboard" "$DASH_MILESTONE" "$DASH_STALE" "$DASH_ESC"

      # -------------------------------------------------------------
      # 3. Emit telemetry
      # -------------------------------------------------------------
      - name: Write telemetry
        run: |
          mkdir -p codex-telemetry
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          printf '{\n'                                  >  codex-telemetry/supervisor.json
          printf '  "timestamp": "%s",\n' "$TS"        >> codex-telemetry/supervisor.json
          printf '  "main_count": %s,\n' "${{ steps.fetch.outputs.main_count }}" >> codex-telemetry/supervisor.json
          printf '  "dash_count": %s,\n' "${{ steps.fetch.outputs.dash_count }}" >> codex-telemetry/supervisor.json
          printf '  "source": "dual-track-supervisor"\n' >> codex-telemetry/supervisor.json
          printf '}\n'                                 >> codex-telemetry/supervisor.json

      # -------------------------------------------------------------
      # 4. Trigger merge workflow
      # -------------------------------------------------------------
      - name: Trigger telemetry merge
        run: |
          gh workflow run codex-telemetry-merge.yml || true
