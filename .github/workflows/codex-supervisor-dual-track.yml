# yamllint disable rule:truthy
---
name: Codex Dual-Track Supervisor

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  repository-projects: write

jobs:
  supervise:
    name: Codex Dual-Track Review
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}

      PROJECT_ID: ${{ vars.CODEX_PROJECT_ID }}
      MAIN_MILESTONE: ${{ vars.CODEX_MAIN_MILESTONE }}
      DASHBOARD_MILESTONE: ${{ vars.CODEX_DASHBOARD_MILESTONE }}

      MAIN_STALE: ${{ vars.CODEX_MAIN_STALE_DAYS }}
      MAIN_ESCALATE: ${{ vars.CODEX_MAIN_ESCALATE_DAYS }}
      DASH_STALE: ${{ vars.CODEX_DASHBOARD_STALE_DAYS }}
      DASH_ESCALATE: ${{ vars.CODEX_DASHBOARD_ESCALATE_DAYS }}

    steps:
      # -----------------------------------------------------------
      # 1. Setup
      # -----------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq & GNU date support
        run: |
          sudo apt-get update
          sudo apt-get install -y jq coreutils

      # -----------------------------------------------------------
      # 2. Pull issues by milestone
      # -----------------------------------------------------------
      - name: Fetch issues for both tracks
        id: issues
        run: |
          echo "Fetching milestone issues..."

          gh issue list \
            --state open \
            --milestone "$MAIN_MILESTONE" \
            --limit 200 \
            --json number,title,updatedAt,labels \
            > main.json

          gh issue list \
            --state open \
            --milestone "$DASHBOARD_MILESTONE" \
            --limit 200 \
            --json number,title,updatedAt,labels \
            > dashboard.json

          echo "main_json=main.json" >> "$GITHUB_OUTPUT"
          echo "dash_json=dashboard.json" >> "$GITHUB_OUTPUT"

      # -----------------------------------------------------------
      # 3. Supervisor logic (shared function)
      # -----------------------------------------------------------
      - name: Supervise Each Track
        id: supervisor
        run: |
          process_track() {
            FILE="$1"
            NAME="$2"
            STALE="$3"
            ESCALATE="$4"

            echo "Processing $NAME track: stale=$STALE, escalate=$ESCALATE"

            jq -c '.[]' "$FILE" | while read -r ISSUE; do
              NUM=$(jq -r '.number' <<< "$ISSUE")
              TITLE=$(jq -r '.title' <<< "$ISSUE")
              UPDATED=$(jq -r '.updatedAt' <<< "$ISSUE")

              UPDATED_TS=$(date -d "$UPDATED" +%s)
              NOW_TS=$(date +%s)

              DIFF_DAYS=$(( (NOW_TS - UPDATED_TS) / 86400 ))

              echo "#$NUM â€” $TITLE (updated $DIFF_DAYS days ago)"

              LABELS=$(jq -r '.labels[].name' <<< "$ISSUE" || true)

              # ----------------------------
              # Stale condition
              # ----------------------------
              if [[ $DIFF_DAYS -ge $STALE && $DIFF_DAYS -lt $ESCALATE ]]; then
                if [[ "$LABELS" != *"stale"* ]]; then
                  echo "  â†’ Marking stale"
                  gh issue edit "$NUM" --add-label "stale"
                  gh issue comment "$NUM" --body "â³ This issue has been marked **stale** due to no updates for $DIFF_DAYS days."
                fi
              fi

              # ----------------------------
              # Escalation condition
              # ----------------------------
              if [[ $DIFF_DAYS -ge $ESCALATE ]]; then
                if [[ "$LABELS" != *"needs-attention"* ]]; then
                  echo "  â†’ Escalating"
                  gh issue edit "$NUM" --add-label "needs-attention"
                  gh issue comment "$NUM" --body "ðŸš¨ This issue requires **attention** â€” inactive for $DIFF_DAYS days."
                fi
              fi
            done
          }

          process_track "${{ steps.issues.outputs.main_json }}" "Main" "$MAIN_STALE" "$MAIN_ESCALATE"
          process_track "${{ steps.issues.outputs.dash_json }}" "Dashboard" "$DASH_STALE" "$DASH_ESCALATE"

      # -----------------------------------------------------------
      # 4. Write telemetry snapshot
      # -----------------------------------------------------------
      - name: Write Supervisor Telemetry
        run: |
          TS=$(date +%s)
          OUT="project-telemetry/supervisor-$TS.json"
          mkdir -p project-telemetry

          jq -n \
            --arg main "$(cat main.json)" \
            --arg dash "$(cat dashboard.json)" \
            '{ main: ($main|fromjson), dashboard: ($dash|fromjson) }' \
            > "$OUT"

          echo "Telemetry written: $OUT"

      # -----------------------------------------------------------
      # 5. Summary
      # -----------------------------------------------------------
      - name: Supervisor Summary
        run: |
          echo "---------------------------------------"
          echo "Codex Dual-Track Supervisor Completed"
          echo "---------------------------------------"
