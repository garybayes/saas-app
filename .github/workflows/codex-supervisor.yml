---
name: "Codex Supervisor (v7.4)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "0 */4 * * *"  # every 4 hours
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  supervisor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Ensure telemetry directories exist
        run: |
          mkdir -p gh-pages/telemetry
          mkdir -p gh-pages/dashboard
          mkdir -p gh-pages/merged

      - name: Run Codex Supervisor
        working-directory: repo
        run: |
          set -euo pipefail

          echo "Running Codex Supervisor (v7.4) for $GITHUB_REPOSITORY"

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          get_var() {
            local name="$1"
            gh variable get "$name" --jq .value 2>/dev/null || echo ""
          }

          MAIN_MS="$(get_var CODEX_MAIN_MILESTONE)"
          DASH_MS="$(get_var CODEX_DASHBOARD_MILESTONE)"

          MAIN_STALE="$(get_var CODEX_MAIN_STALE_DAYS)"
          MAIN_ESC="$(get_var CODEX_MAIN_ESCALATION_DAYS)"
          DASH_STALE="$(get_var CODEX_DASHBOARD_STALE_DAYS)"
          DASH_ESC="$(get_var CODEX_DASHBOARD_ESCALATION_DAYS)"

          echo "Main: milestone=$MAIN_MS, stale=${MAIN_STALE:-?}, escalation=${MAIN_ESC:-?}"
          echo "Dashboard: milestone=$DASH_MS, stale=${DASH_STALE:-?}, escalation=${DASH_ESC:-?}"

          if [ -z "$MAIN_MS" ] || [ -z "$DASH_MS" ]; then
            echo "ERROR: Missing milestone numbers. Supervisor will not modify issues."
            exit 0
          fi

          now_ts="$(date -u +%s)"

          > supervisor_raw.json

          process_track() {
            local track="$1"
            local track_label="$2"
            local milestone="$3"
            local stale_days="$4"
            local esc_days="$5"

            if [ -z "$stale_days" ] || [ -z "$esc_days" ]; then
              echo "Skipping track '$track' due to missing thresholds."
              return 0
            fi

            echo "Processing track '$track' with label '$track_label' and milestone $milestone…"

            gh api --paginate "/repos/$OWNER/$REPO/issues" \
              -X GET \
              -F state="open" \
              -F milestone="$milestone" \
              -F labels="codex,$track_label" \
              > "issues-${track}.json"

            jq -c '.[] | {number, updated_at}' "issues-${track}.json" | \
            while read -r row; do
              num=$(echo "$row" | jq -r '.number')
              updated=$(echo "$row" | jq -r '.updated_at')

              issue_ts=$(date -u -d "$updated" +%s || echo "$now_ts")
              age_days=$(( (now_ts - issue_ts) / 86400 ))

              status="normal"

              if [ "$age_days" -ge "$esc_days" ]; then
                status="escalation"
                gh issue edit "$num" \
                  --add-label "needs-escalation" \
                  --remove-label "needs-attention" || true
              elif [ "$age_days" -ge "$stale_days" ]; then
                status="stale"
                gh issue edit "$num" \
                  --add-label "needs-attention" \
                  --remove-label "needs-escalation" || true
              else
                gh issue edit "$num" \
                  --remove-label "needs-attention" \
                  --remove-label "needs-escalation" || true
              fi

              printf '{"track":"%s","number":%s,"age_days":%s,"status":"%s"}\n' \
                "$track" "$num" "$age_days" "$status" >> supervisor_raw.json
            done
          }

          process_track "main" "codex-trackmain" "$MAIN_MS" "$MAIN_STALE" "$MAIN_ESC"
          process_track "dashboard" "codex-trackdashboard" "$DASH_MS" "$DASH_STALE" "$DASH_ESC"

          TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          OUT="../gh-pages/telemetry/supervisor-${GITHUB_RUN_ID}.json"

          if [ -s supervisor_raw.json ]; then
            jq -s --arg ts "$TS" --arg repo "$GITHUB_REPOSITORY" \
              '{component:"supervisor",timestamp:$ts,repository:$repo,issues:.}' \
              supervisor_raw.json > "$OUT"
          else
            jq -n --arg ts "$TS" --arg repo "$GITHUB_REPOSITORY" \
              '{component:"supervisor",timestamp:$ts,repository:$repo,issues:[]}' > "$OUT"
          fi

          echo "Wrote supervisor telemetry → $OUT"

      - name: Commit supervisor telemetry
        working-directory: gh-pages
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/*.json || true
          git commit -m "Supervisor telemetry update" || true
          git push origin gh-pages || true
