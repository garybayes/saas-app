---
name: "Codex Supervisor (v7.1)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "0 */4 * * *"  # every 4 hours
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  supervisor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Configure token
        run: |
          set -euo pipefail
          echo "Configuring GH_CI_PAT…"

          # Override GitHub’s auto-injected GH_TOKEN
          unset GH_TOKEN || true

          if [ -z "${GH_CI_PAT:-}" ]; then
            echo "ERROR: GH_CI_PAT missing."
            exit 1
          fi

          echo "$GH_CI_PAT" | gh auth login --with-token
          echo "Authentication complete."
        env:
          GH_CI_PAT: ${{ secrets.GH_CI_PAT }}

      - name: Run Supervisor
        working-directory: repo
        env:
          GH_TOKEN: ${{ secrets.GH_CI_PAT }}
        run: |
          set -euo pipefail

          echo "Running Codex Supervisor (v7.1) for $GITHUB_REPOSITORY"

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          # Thresholds from repo variables
          MAIN_STALE=$(gh variable get CODEX_MAIN_STALE_DAYS --repo "$OWNER/$REPO" --json | jq -r '.[0].value')
          MAIN_ESC=$(gh variable get CODEX_MAIN_ESCALATION_DAYS --repo "$OWNER/$REPO" --json | jq -r '.[0].value')
          DASH_STALE=$(gh variable get CODEX_DASHBOARD_STALE_DAYS --repo "$OWNER/$REPO" --json | jq -r '.[0].value')
          DASH_ESC=$(gh variable get CODEX_DASHBOARD_ESCALATION_DAYS --repo "$OWNER/$REPO" --json | jq -r '.[0].value')

          echo "Main thresholds: stale=${MAIN_STALE} days, escalation=${MAIN_ESC} days"
          echo "Dashboard thresholds: stale=${DASH_STALE} days, escalation=${DASH_ESC} days"

          echo "Fetching Codex issues (no Search API)…"

          # Search-free API: issues filtered by codex label
          issues_json="$(
            gh api \
              "/repos/$OWNER/$REPO/issues" \
              -f labels="codex" \
              -f state="open" \
              -f per_page=100 \
              --jq '.[]'
          )"

          if [ -z "$issues_json" ]; then
            echo "No Codex issues found."
            exit 0
          fi

          echo "$issues_json" | jq -c '.' | while read -r issue; do
            NUMBER=$(echo "$issue" | jq -r '.number')
            TITLE=$(echo "$issue" | jq -r '.title')
            CREATED=$(echo "$issue" | jq -r '.created_at')

            echo ""
            echo "Processing issue #$NUMBER: $TITLE"

            age_days=$(( ( $(date -u +%s) - $(date -u -d "$CREATED" +%s) ) / 86400 ))

            if echo "$TITLE" | grep -q "Self-Test"; then
              STALE="$MAIN_STALE"
              ESC="$MAIN_ESC"
            elif echo "$TITLE" | grep -q "Dashboard"; then
              STALE="$DASH_STALE"
              ESC="$DASH_ESC"
            else
              STALE="$MAIN_STALE"
              ESC="$MAIN_ESC"
            fi

            if [ "$age_days" -ge "$ESC" ]; then
              echo " → Needs escalation"
              gh issue edit "$NUMBER" \
                --add-label "needs-escalation" \
                --remove-label "needs-attention" || true

            elif [ "$age_days" -ge "$STALE" ]; then
              echo " → Needs attention"
              gh issue edit "$NUMBER" \
                --add-label "needs-attention" || true

            else
              echo " → Normal"
            fi
          done

          echo "Supervisor run complete."
