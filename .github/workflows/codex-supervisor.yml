---
name: "Codex Supervisor (v7.3)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch: {}

permissions:
  issues: write
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}
  CODEX_COMPONENT: supervisor

jobs:
  supervisor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Run Supervisor
        id: sup
        working-directory: repo
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          s_main=$(gh variable get CODEX_MAIN_STALE_DAYS     --repo "$OWNER/$REPO" --jq '.value')
          e_main=$(gh variable get CODEX_MAIN_ESCALATION_DAYS --repo "$OWNER/$REPO" --jq '.value')
          s_dash=$(gh variable get CODEX_DASHBOARD_STALE_DAYS --repo "$OWNER/$REPO" --jq '.value')
          e_dash=$(gh variable get CODEX_DASHBOARD_ESCALATION_DAYS --repo "$OWNER/$REPO" --jq '.value')

          issues=$(gh api "/repos/$OWNER/$REPO/issues" \
            -f labels="codex" \
            -f state="open" \
            -f per_page=100)

          declare -a escalated=()

          count=$(echo "$issues" | jq 'length')
          for i in $(seq 0 $((count - 1))); do
            number=$(echo "$issues" | jq -r ".[$i].number")
            labels=$(echo "$issues" | jq -r ".[$i].labels[].name")
            updated_at=$(echo "$issues" | jq -r ".[$i].updated_at")
            updated_sec=$(date -d "$updated_at" +%s)
            now_sec=$(date -u +%s)
            age_days=$(( (now_sec - updated_sec) / 86400 ))

            track=""
            stale_threshold=9999
            esc_threshold=9999

            if echo "$labels" | grep -q "codex-trackmain"; then
              track="main"
              stale_threshold=$s_main
              esc_threshold=$e_main
            elif echo "$labels" | grep -q "codex-trackdashboard"; then
              track="dashboard"
              stale_threshold=$s_dash
              esc_threshold=$e_dash
            else
              continue
            fi

            if (( age_days >= esc_threshold )); then
              gh api --method PATCH "/repos/$OWNER/$REPO/issues/$number" \
                -f labels='["codex","needs-escalation"]'
              escalated+=("$number")
            elif (( age_days >= stale_threshold )); then
              gh api --method PATCH "/repos/$OWNER/$REPO/issues/$number" \
                -f labels='["codex","needs-attention"]'
            fi
          done

          echo "escalated=$(printf '%s\n' "${escalated[@]:-}" | jq -R . | jq -s .)" \
            >> "$GITHUB_OUTPUT"

      - name: Write Telemetry (Always-On)
        if: always()
        working-directory: gh-pages
        run: |
          mkdir -p telemetry
          ts="$(date -u +"%Y%m%dT%H%M%SZ")"
          outfile="telemetry/supervisor-$ts.json"

          {
            printf '{\n'
            printf '  "component": "supervisor",\n'
            printf '  "timestamp": "%s",\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            printf '  "escalated": %s,\n' '${{ steps.sup.outputs.escalated }}'
            printf '  "repository": "%s"\n' "$GITHUB_REPOSITORY"
            printf '}\n'
          } > "$outfile"

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/*.json
          git commit -m "Supervisor telemetry update" || echo "No changes"
          git push origin gh-pages
