---
name: "Codex Supervisor (v7.3)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  supervisor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Configure token
        env:
          GH_CI_PAT: ${{ secrets.GH_CI_PAT }}
        run: |
          set -euo pipefail

          unset GH_TOKEN || true

          if [ -z "${GH_CI_PAT:-}" ]; then
            echo "ERROR: GH_CI_PAT missing."
            exit 1
          fi

          echo "$GH_CI_PAT" | gh auth login --with-token

      - name: Run Supervisor
        working-directory: repo
        env:
          GH_TOKEN: ${{ secrets.GH_CI_PAT }}
        run: |
          set -euo pipefail

          echo "Running Codex Supervisor (v7.3) for $GITHUB_REPOSITORY"

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          getvar() {
            gh variable get "$1" \
              --repo "$OWNER/$REPO" \
              --json value \
              --jq '.value'
          }

          MAIN_STALE=$(getvar CODEX_MAIN_STALE_DAYS)
          MAIN_ESC=$(getvar CODEX_MAIN_ESCALATION_DAYS)
          DASH_STALE=$(getvar CODEX_DASHBOARD_STALE_DAYS)
          DASH_ESC=$(getvar CODEX_DASHBOARD_ESCALATION_DAYS)

          echo "Main thresholds: stale=$MAIN_STALE, escalate=$MAIN_ESC"
          echo "Dashboard thresholds: stale=$DASH_STALE, escalate=$DASH_ESC"

          echo "Fetching Codex issues…"

          issues_json="$(
            gh api \
              "/repos/$OWNER/$REPO/issues?state=open&labels=codex&per_page=100" \
              --jq '.[]'
          )"

          if [ -z "$issues_json" ]; then
            echo "No codex issues found."
            exit 0
          fi

          echo "$issues_json" | jq -c '.' | while read -r issue; do
            NUMBER=$(echo "$issue" | jq -r '.number')
            TITLE=$(echo "$issue" | jq -r '.title')
            CREATED=$(echo "$issue" | jq -r '.created_at')

            echo ""
            echo "→ Processing #$NUMBER: $TITLE"

            age_days=$(( ( $(date -u +%s) - $(date -u -d "$CREATED" +%s) ) / 86400 ))

            if echo "$TITLE" | grep -iq "dashboard"; then
              STALE="$DASH_STALE"
              ESC="$DASH_ESC"
            else
              STALE="$MAIN_STALE"
              ESC="$MAIN_ESC"
            fi

            if [ "$age_days" -ge "$ESC" ]; then
              echo "  Escalation threshold reached."
              gh issue edit "$NUMBER" \
                --add-label needs-escalation \
                --remove-label needs-attention || true

            elif [ "$age_days" -ge "$STALE" ]; then
              echo "  Stale threshold reached."
              gh issue edit "$NUMBER" \
                --add-label needs-attention || true

            else
              echo "  No action needed."
            fi

          done

          echo "Supervisor run complete."
