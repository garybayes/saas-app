# yamllint disable rule:truthy
---
name: Codex Telemetry Merge

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # hourly merge to keep telemetry fresh

permissions:
  contents: write

jobs:
  merge:
    name: Merge Codex telemetry into codex-data.json
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      # 1. Checkout gh-pages as the working branch
      # -----------------------------------------------------------
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      # -----------------------------------------------------------
      # 2. Install jq for JSON processing
      # -----------------------------------------------------------
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # -----------------------------------------------------------
      # 3. Ensure telemetry directories exist (tolerant merge)
      #    Diagnostics workflow is responsible for strict checks;
      #    here we just warn and continue with whatever exists.
      # -----------------------------------------------------------
      - name: Verify telemetry directories
        run: |
          for DIR in "project-telemetry" "activity-telemetry"; do
            if [[ -d "$DIR" ]]; then
              echo "âœ” Found telemetry directory: $DIR"
            else
              echo "::warning::Telemetry directory missing (will be treated as empty): $DIR"
            fi
          done

      # -----------------------------------------------------------
      # 4. Collect telemetry JSON files from both directories
      # -----------------------------------------------------------
      - name: Gather telemetry files
        run: |
          echo "Collecting telemetry files from project-telemetry/ and activity-telemetry/..."

          mkdir -p merged
          > merged/all.jsonlist

          if [[ -d "project-telemetry" ]]; then
            find project-telemetry -maxdepth 1 -name "*.json" >> merged/all.jsonlist || true
          fi

          if [[ -d "activity-telemetry" ]]; then
            find activity-telemetry -maxdepth 1 -name "*.json" >> merged/all.jsonlist || true
          fi

          echo "Telemetry files to merge:"
          cat merged/all.jsonlist || echo "(none found)"

      # -----------------------------------------------------------
      # 5. Merge telemetry JSON into codex-data.json at repo root
      #    - No codex/ prefix
      #    - Root file must be gh-pages:/codex-data.json
      # -----------------------------------------------------------
      - name: Merge telemetry JSON
        run: |
          echo "[]" > codex-data.json

          if [[ ! -s merged/all.jsonlist ]]; then
            echo "No telemetry found. Leaving codex-data.json as empty array."
            exit 0
          fi

          # Merge each telemetry file as array elements
          while IFS= read -r FILE; do
            echo "Merging: $FILE"

            # Wrap telemetry object into a list element: [{...}]
            WRAPPED=$(jq -c '[.]' "$FILE")

            # Combine arrays
            jq -s 'add' <(echo "$WRAPPED") codex-data.json > codex-data.tmp
            mv codex-data.tmp codex-data.json
          done < merged/all.jsonlist

          echo "Merged codex-data.json:"
          cat codex-data.json

      # -----------------------------------------------------------
      # 6. Commit & push changes to gh-pages
      # -----------------------------------------------------------
      - name: Commit and push merged telemetry
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          git add codex-data.json

          if git diff --cached --quiet; then
            echo "No telemetry changes to commit."
            exit 0
          fi

          git commit -m "[skip ci] Codex: merged telemetry update"
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" gh-pages

      # -----------------------------------------------------------
      # 7. Summary
      # -----------------------------------------------------------
      - name: Summary
        run: |
          echo "-----------------------------------------"
          echo "Codex Telemetry Merge completed."
          echo "Updated gh-pages:/codex-data.json"
          echo "-----------------------------------------"
