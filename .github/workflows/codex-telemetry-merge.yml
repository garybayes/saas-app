---
name: "Codex Telemetry Merge (v7.5.4)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "30 */4 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  telemetry-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: repo

      # ---------------------------------------------------------
      # Ensure directory structure exists (self-healing)
      # ---------------------------------------------------------
      - name: Prepare directory structure
        run: |
          mkdir -p gh-pages/telemetry
          mkdir -p gh-pages/telemetry/merged
          mkdir -p gh-pages/dashboard

      # ---------------------------------------------------------
      # Validate & filter JSON files (skip corrupted files)
      # ---------------------------------------------------------
      - name: Validate JSON files
        id: validate
        run: |
          set -euo pipefail

          VALID_FILES=""
          INVALID_FILES=""

          for f in gh-pages/telemetry/*.json; do
            [ -e "$f" ] || continue

            if jq empty "$f" 2>/dev/null; then
              echo "VALID:   $f"
              VALID_FILES="$VALID_FILES $f"
            else
              echo "INVALID: $f"
              INVALID_FILES="$INVALID_FILES $f"
            fi
          done

          echo "valid_files=$VALID_FILES" >> "$GITHUB_OUTPUT"
          echo "invalid_files=$INVALID_FILES" >> "$GITHUB_OUTPUT"

      # ---------------------------------------------------------
      # Merge all valid telemetry files into dashboard.json
      # ---------------------------------------------------------
      - name: Merge telemetry
        run: |
          set -euo pipefail

          OUT="gh-pages/dashboard/dashboard.json"
          FILES="${{ steps.validate.outputs.valid_files }}"

          if [ -z "$FILES" ]; then
            echo "[] " > "$OUT"
            echo "No valid telemetry files. Wrote empty dashboard."
            exit 0
          fi

          # Safe merge only valid JSON files
          jq -s 'flatten' $FILES > "$OUT"

          echo "Merged telemetry into $OUT"

      # ---------------------------------------------------------
      # Commit/push updated dashboard.json
      # ---------------------------------------------------------
      - name: Commit and push
        run: |
          set -euo pipefail
          cd gh-pages

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add dashboard/dashboard.json
          git commit -m "Telemetry merge update" || echo "No changes"
          git push origin gh-pages
