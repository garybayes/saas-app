---
"name": "Codex Telemetry Merge (v6)"

"on":
  schedule:
    - cron: "30 */4 * * *"  # run after supervisor + sync + activity
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Install GitHub CLI
        uses: actions/setup-gh@v3
        with:
          version: latest

      - name: Configure token
        run: |
          if gh auth token >/dev/null 2>&1; then
            echo "Using gh auth token"
          else
            if [ -n "${GH_CI_PAT:-}" ]; then
              gh auth login --with-token <<< "$GH_CI_PAT"
            else
              echo "ERROR: No token found."
              exit 1
            fi
          fi

      - name: Collect telemetry files
        id: collect
        working-directory: gh-pages
        run: |
          mkdir -p dashboard

          SUPERVISOR=$(ls telemetry/supervisor-*.json 2>/dev/null | sort -V | tail -1)
          CLEANER=$(ls telemetry/cleaner-*.json 2>/dev/null | sort -V | tail -1)
          SELFTEST=$(ls telemetry/self-test-*.json 2>/dev/null | sort -V | tail -1)
          SYNC=$(ls telemetry/sync-*.json 2>/dev/null | sort -V | tail -1)
          ACTIVITY=$(ls telemetry/activity-*.json 2>/dev/null | sort -V | tail -1)

          echo "supervisor=$SUPERVISOR" >> "$GITHUB_OUTPUT"
          echo "cleaner=$CLEANER"       >> "$GITHUB_OUTPUT"
          echo "selftest=$SELFTEST"     >> "$GITHUB_OUTPUT"
          echo "sync=$SYNC"             >> "$GITHUB_OUTPUT"
          echo "activity=$ACTIVITY"     >> "$GITHUB_OUTPUT"

      - name: Merge telemetry into dashboard.json
        working-directory: gh-pages
        run: |
          sup="${{ steps.collect.outputs.supervisor }}"
          cln="${{ steps.collect.outputs.cleaner }}"
          st="${{ steps.collect.outputs.selftest }}"
          sync="${{ steps.collect.outputs.sync }}"
          act="${{ steps.collect.outputs.activity }}"

          # Build JSON structure using jq
          jq -n \
            --argfile sup "$sup" \
            --argfile cl "$cln" \
            --argfile st "$st" \
            --argfile sy "$sync" \
            --argfile ac "$act" \
            '{
              supervisor: $sup,
              cleaner:    $cl,
              selftest:   $st,
              sync:       $sy,
              activity:   $ac
            }' > dashboard/dashboard.json

      - name: Commit and push dashboard
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dashboard/dashboard.json

          if git commit -m "Update Codex dashboard ${GITHUB_RUN_ID}"; then
            git push
          else
            echo "No dashboard changes."
          fi
