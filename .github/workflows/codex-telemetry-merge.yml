---
name: "Codex Telemetry Merge (v7.5.1)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "30 */4 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  merge_telemetry:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1. Checkout gh-pages branch (must commit there)
      # ------------------------------------------------------------
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0
          persist-credentials: false   # always false in Codex v7+

      # ------------------------------------------------------------
      # 2. Checkout repository (unused but standard for all Codex workflows)
      # ------------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      # ------------------------------------------------------------
      # 3. Ensure telemetry folders exist
      # ------------------------------------------------------------
      - name: Prepare telemetry directories
        run: |
          mkdir -p gh-pages/telemetry/diagnostics
          mkdir -p gh-pages/telemetry/activity
          mkdir -p gh-pages/telemetry/project-sync
          mkdir -p gh-pages/telemetry/merged

      # ------------------------------------------------------------
      # 4. Collect JSON sources into a merge buffer
      # ------------------------------------------------------------
      - name: Scan available telemetry
        id: scan
        run: |
          set -euo pipefail

          DIAG=$(ls gh-pages/telemetry/diagnostics/*.json 2>/dev/null | wc -l)
          ACT=$(ls gh-pages/telemetry/activity/*.json 2>/dev/null | wc -l)
          PSYNC=$(ls gh-pages/telemetry/project-sync/*.json 2>/dev/null | wc -l)

          echo "diag_count=$DIAG" >> "$GITHUB_OUTPUT"
          echo "activity_count=$ACT" >> "$GITHUB_OUTPUT"
          echo "psync_count=$PSYNC" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # 5. Produce merged JSON payload
      # ------------------------------------------------------------
      - name: Merge telemetry
        run: |
          set -euo pipefail

          OUT="gh-pages/telemetry/merged/telemetry-merged-$(date -u +"%Y%m%dT%H%M%SZ").json"

          echo
