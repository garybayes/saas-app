---
# yamllint disable rule:truthy
name: Codex Telemetry Merge

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - "Codex Activity Engine Supervisor"
      - "Codex Self-Test"
      - "Codex Supervisor"
    types:
      - completed

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Merge telemetry
        run: |
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Load existing root or create new
          if [[ -f "codex-data.json" ]]; then
            ROOT=$(cat codex-data.json)
          else
            ROOT="{}"
          fi

          # Activity telemetry
          if [[ -f "activity-telemetry/latest.json" ]]; then
            ACTIVITY=$(cat activity-telemetry/latest.json)
          else
            ACTIVITY="{}"
          fi

          # Self-test telemetry
          if [[ -f "activity-telemetry/selftest.json" ]]; then
            SELF=$(cat activity-telemetry/selftest.json)
          else
            SELF="{}"
          fi

          jq -n \
            --argjson root "$ROOT" \
            --argjson activity "$ACTIVITY" \
            --argjson selftest "$SELF" \
            --arg now "$NOW" \
            '($root + {activity: $activity.activity} + {selftest: $selftest.selftest}) + {updated_at: $now}' \
            > codex-data.json

      - name: Commit merged file
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git add codex-data.json
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git commit -m "[skip ci] Update Codex Telemetry" || true
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" gh-pages
