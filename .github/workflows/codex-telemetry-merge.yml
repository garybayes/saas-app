---
name: "Codex Telemetry Merge (v7)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "30 */4 * * *"  # after supervisor + sync + activity
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Configure token
        env:
          GH_CI_PAT: ${{ secrets.GH_CI_PAT }}
        run: |
          set -euo pipefail

          echo "Unsetting system GH_TOKEN so workflow can use GH_CI_PAT…"
          unset GH_TOKEN || true

          if [ -z "${GH_CI_PAT:-}" ]; then
            echo "ERROR: GH_CI_PAT secret missing."
            exit 1
          fi

          echo "$GH_CI_PAT" | gh auth login --with-token
          echo "Authenticated using GH_CI_PAT."

      - name: Merge Telemetry
        working-directory: gh-pages
        env:
          GH_TOKEN: ${{ secrets.GH_CI_PAT }}
        run: |
          set -euo pipefail

          echo "Running Codex Telemetry Merge (v7)…"

          mkdir -p telemetry/merged

          timestamp="$(date -u +"%Y%m%dT%H%M%SZ")"
          outfile="telemetry/merged/telemetry-merged-$timestamp.json"

          echo "Collecting telemetry files…"

          # Gather all JSON telemetry files
          files=$(find telemetry -maxdepth 1 -type f -name '*.json' | sort)

          if [ -z "$files" ]; then
            echo "No telemetry files found — nothing to merge."
            exit 0
          fi

          echo "Merging $(echo "$files" | wc -l) files…"

          # Merge every JSON object into a single JSON array
          jq -s '.' $files > "$outfile"

          echo "Merged telemetry written to $outfile"

      - name: Commit Merged Telemetry
        working-directory: gh-pages
        env:
          GH_TOKEN: ${{ secrets.GH_CI_PAT }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add telemetry/merged/*.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Codex Telemetry Merge update"
          git push origin gh-pages

          echo "Merged telemetry committed and pushed."
