---
name: "Codex Telemetry Merge (v7.5.3)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "30 */4 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  telemetry-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          path: repo

      # ------------------------------------------------------------------
      # Ensure telemetry & dashboard directories exist (self-healing)
      # ------------------------------------------------------------------
      - name: Prepare directory structure
        run: |
          mkdir -p gh-pages/telemetry
          mkdir -p gh-pages/dashboard
          mkdir -p gh-pages/telemetry/merged

      # ------------------------------------------------------------------
      # Scan for telemetry files (flat layout)
      # ------------------------------------------------------------------
      - name: Scan available telemetry
        id: scan
        run: |
          set -euo pipefail

          DIAG=$(ls gh-pages/telemetry/diagnostics-*.json 2>/dev/null | wc -l || true)
          ACT=$(ls gh-pages/telemetry/activity-*.json 2>/dev/null | wc -l || true)
          PSYNC=$(ls gh-pages/telemetry/project-sync-*.json 2>/dev/null | wc -l || true)

          echo "diag_count=$DIAG" >> "$GITHUB_OUTPUT"
          echo "activity_count=$ACT" >> "$GITHUB_OUTPUT"
          echo "psync_count=$PSYNC" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------------
      # Merge telemetry into a single array
      # ------------------------------------------------------------------
      - name: Merge telemetry
        id: merge
        run: |
          set -euo pipefail

          OUTFILE="gh-pages/dashboard/dashboard.json"

          # Collect all telemetry files (flat)
          FILES=$(ls gh-pages/telemetry/*-*.json 2>/dev/null || true)

          if [ -z "$FILES" ]; then
            echo "[] " > "$OUTFILE"
            echo "Merged empty telemetry set"
            exit 0
          fi

          # Merge using jq
          jq -s 'flatten' $FILES > "$OUTFILE"

          echo "Telemetry merged into $OUTFILE"

      # ------------------------------------------------------------------
      # Commit and push updated dashboard.json
      # ------------------------------------------------------------------
      - name: Commit and push merged telemetry
        run: |
          set -euo pipefail
          cd gh-pages

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add dashboard/dashboard.json

          git commit -m "Telemetry merge update" || echo "No changes to commit"

          git push origin gh-pages
