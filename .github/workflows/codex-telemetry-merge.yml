---
name: "Codex Telemetry Merge (v7)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "30 */4 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}
  CODEX_COMPONENT: merge

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Merge telemetry
        working-directory: gh-pages
        run: |
          set -euo pipefail

          mkdir -p telemetry
          mkdir -p dashboard

          merged="dashboard/dashboard.json"

          files=(telemetry/*.json)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No telemetry to merge."
            echo "[]" > "$merged"
          else
            jq -s '.' telemetry/*.json > "$merged"
          fi

      - name: Commit merged dashboard
        working-directory: gh-pages
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add dashboard/dashboard.json
          git commit -m "Telemetry merged" || echo "No changes"
          git push origin gh-pages
