---
name: "Codex Activity Engine (v7.5.1)"

# yamllint disable-line rule:truthy
on:
  schedule:
    - cron: "45 */4 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

env:
  GH_TOKEN: ${{ secrets.GH_CI_PAT }}

jobs:
  activity_engine:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1. Checkout gh-pages WITH full git history (needed for commits)
      # ------------------------------------------------------------
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0
          persist-credentials: false   # always false in Codex v7+

      # ------------------------------------------------------------
      # 2. Checkout repository source
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo

      # ------------------------------------------------------------
      # 3. Self-heal telemetry folder
      # ------------------------------------------------------------
      - name: Prepare telemetry directory
        run: |
          mkdir -p gh-pages/telemetry/activity

      # ------------------------------------------------------------
      # 4. Load configuration from repo variables
      # ------------------------------------------------------------
      - name: Load configuration
        id: config
        run: |
          set -euo pipefail

          echo "main_stale=${CODEX_MAIN_STALE_DAYS:-}" >> "$GITHUB_OUTPUT"
          echo "main_esc=${CODEX_MAIN_ESCALATION_DAYS:-}" >> "$GITHUB_OUTPUT"
          echo "dash_stale=${CODEX_DASHBOARD_STALE_DAYS:-}" >> "$GITHUB_OUTPUT"
          echo "dash_esc=${CODEX_DASHBOARD_ESCALATION_DAYS:-}" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # 5. Fetch codex issues (search-free API call)
      # ------------------------------------------------------------
      - name: Fetch codex issues
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          ISSUES_JSON="$(gh api "/repos/$OWNER/$REPO/issues?labels=codex&state=all&per_page=100")"
          echo "$ISSUES_JSON" > issues.json

      # ------------------------------------------------------------
      # 6. Process issues (stale + escalation logic)
      # ------------------------------------------------------------
      - name: Process activity state
        run: |
          set -euo pipefail

          MAIN_STALE="${{ steps.config.outputs.main_stale }}"
          MAIN_ESC="${{ steps.config.outputs.main_esc }}"
          DASH_STALE="${{ steps.config.outputs.dash_stale }}"
          DASH_ESC="${{ steps.config.outputs.dash_esc }}"

          NOW=$(date -u +%s)

          while IFS= read -r issue; do
            NUM=$(echo "$issue" | jq -r '.number')
            TITLE=$(echo "$issue" | jq -r '.title')
            UPDATED=$(echo "$issue" | jq -r '.updated_at')

            UPDATED_TS=$(date -d "$UPDATED" +%s)
            AGE=$(( (NOW - UPDATED_TS) / 86400 ))

            TRACK_MAIN=$(echo "$issue" | jq -e '[.labels[].name] | index("codex-trackmain")' >/dev/null && echo "1" || echo "0")
            TRACK_DASH=$(echo "$issue" | jq -e '[.labels[].name] | index("codex-trackdashboard")' >/dev/null && echo "1" || echo "0")

            if [ "$TRACK_MAIN" = "1" ]; then
              STALE="$MAIN_STALE"; ESC="$MAIN_ESC"
            elif [ "$TRACK_DASH" = "1" ]; then
              STALE="$DASH_STALE"; ESC="$DASH_ESC"
            else
              continue
            fi

            if [ "$AGE" -ge "$STALE" ]; then
              gh api --method POST "/repos/${GITHUB_REPOSITORY}/issues/$NUM/labels" \
                -f labels='["needs-attention"]'
            fi

            if [ "$AGE" -ge "$ESC" ]; then
              gh api --method POST "/repos/${GITHUB_REPOSITORY}/issues/$NUM/labels" \
                -f labels='["needs-escalation"]'
            fi

          done < <(jq -c '.[]' issues.json)

      # ------------------------------------------------------------
      # 7. Commit telemetry snapshot (with fixed authentication)
      # ------------------------------------------------------------
      - name: Commit activity telemetry
        run: |
          set -euo pipefail
          cd gh-pages

          SNAP="telemetry/activity/activity-$(date -u +"%Y%m%dT%H%M%SZ").json"

          printf '{\n' > "$SNAP"
          printf '  "component": "activity-engine",\n' >> "$SNAP"
          printf '  "timestamp": "%s"\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$SNAP"
          printf '}\n' >> "$SNAP"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$SNAP"
          git commit -m "Codex Activity Engine telemetry update" || echo "No changes"

          # FIX: restore authentication removed by persist-credentials: false
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git

          git push origin gh-pages
