---
# yamllint disable rule:truthy
name: Codex – Telemetry Merge

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write
  repository-projects: write

jobs:
  merge:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_CI_PAT }}
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 1

      # -------------------------------------------------------------
      # Ensure folder exists
      # -------------------------------------------------------------
      - name: Prepare folders
        run: |
          mkdir -p codex
          mkdir -p codex-telemetry
          touch codex/codex-data.json

      # -------------------------------------------------------------
      # Merge all telemetry JSON files
      # -------------------------------------------------------------
      - name: Merge telemetry
        run: |
          echo "Merging telemetry…"

          # Find all telemetry snapshots
          FILES=$(find . -type f -path "./**/latest.json")

          # Start fresh file
          printf '{\n  "telemetry": [\n' > codex/codex-data.json

          COUNT=0
          for F in $FILES; do
            CONTENT=$(cat "$F")
            if [[ $COUNT -gt 0 ]]; then
              printf ',\n' >> codex/codex-data.json
            fi

            printf '    %s' "$CONTENT" >> codex/codex-data.json
            COUNT=$((COUNT+1))
          done

          printf '\n  ]\n}\n' >> codex/codex-data.json

      # -------------------------------------------------------------
      # Commit merged data
      # -------------------------------------------------------------
      - name: Commit & Push
        run: |
          git config --global user.name  "codex-ci-bot"
          git config --global user.email "codex-ci-bot@users.noreply.github.com"

          git add codex/codex-data.json

          if ! git diff --cached --quiet; then
            git commit -m "Codex Telemetry Merge [skip ci]"
            git push origin gh-pages
          else
            echo "No telemetry changes."
          fi
