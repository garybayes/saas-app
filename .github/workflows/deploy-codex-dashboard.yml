---
# yamllint disable rule:truthy
name: Deploy Codex Dashboard

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - codex/**
      - codex-data.json
      - .github/workflows/deploy-codex-dashboard.yml

permissions:
  contents: write
  pages: write

jobs:
  build-deploy-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure git identity
        run: |
          git config --global user.name "codex-ci-bot"
          git config --global user.email "codex-ci-bot@users.noreply.github.com"

      - name: Checkout gh-pages worktree
        run: |
          rm -rf ghp
          git worktree add ghp gh-pages

      - name: Fetch supervisor telemetry
        id: supervisor
        run: |
          if [ -f ghp/supervisor-telemetry/latest.json ]; then
            SUP=$(cat ghp/supervisor-telemetry/latest.json)
          else
            SUP="null"
          fi
          echo "sup=$SUP" >> "$GITHUB_OUTPUT"

      - name: Fetch self-test telemetry
        id: selftest
        run: |
          if [ -f ghp/codex-selftest/latest.json ]; then
            ST=$(cat ghp/codex-selftest/latest.json)
          else
            ST="null"
          fi
          echo "st=$ST" >> "$GITHUB_OUTPUT"

      - name: Merge telemetry into codex-data.json
        run: |
          mkdir -p ghp
          jq -n \
            --argjson sup "${{ steps.supervisor.outputs.sup }}" \
            --argjson st  "${{ steps.selftest.outputs.st }}" \
            '{
              supervisor: $sup,
              selftest: $st
            }' > ghp/codex-data.json

      - name: Build dashboard index.html
        run: |
          mkdir -p ghp
          cp codex/index.html ghp/index.html

          # Inject JSON into placeholder
          DATA=$(cat ghp/codex-data.json | jq -c .)
          sed -i "s|__CODEX_DATA__|$DATA|" ghp/index.html

      - name: Commit and push dashboard to gh-pages
        run: |
          cd ghp
          git add codex-data.json index.html
          git commit -m "Dashboard updated with merged telemetry [skip ci]" || echo "No changes"
          git push origin gh-pages
