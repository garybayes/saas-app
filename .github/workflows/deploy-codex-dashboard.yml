---
# yamllint disable rule:truthy
name: Deploy Codex Dashboard

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "codex/**"
      - ".github/workflows/deploy-codex-dashboard.yml"

jobs:
  deploy-dashboard:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:

      # -----------------------------------------
      # 1. Checkout gh-pages
      # -----------------------------------------
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      # -----------------------------------------
      # 2. Setup Node
      # -----------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # -----------------------------------------
      # 3. Install dependencies (for generate.mjs)
      # -----------------------------------------
      - name: Install dependencies
        run: |
          npm install

      # -----------------------------------------
      # 4. Run generator to rebuild the dashboard
      # -----------------------------------------
      - name: Generate dashboard
        run: |
          echo "Running dashboard generator..."
          node codex/generate.mjs

      # -----------------------------------------
      # 5. Commit + push updated dashboard
      # -----------------------------------------
      - name: Commit and push updated dashboard
        run: |
          set -e

          git config --global user.name "codex-ci-bot"
          git config --global user.email "codex-ci-bot@users.noreply.github.com"

          git add index.html codex-data.json || true

          # Allow "no changes" without failing the workflow
          git commit -m "Deploy updated Codex dashboard [skip ci]" || {
            echo "No changes to commit"
            exit 0
          }

          git push origin gh-pages
