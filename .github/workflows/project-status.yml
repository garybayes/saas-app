---
name: Project Status

# yamllint disable-line rule:truthy
on:
  pull_request:
    types: [closed]

jobs:
  close_issues_and_move_to_done:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Extract linked issues from PR body
        id: extract
        run: |
          echo "issues=$(echo '${{ github.event.pull_request.body }}' | grep -oE '#[0-9]+' | tr -d '#')" >> $GITHUB_OUTPUT

      - name: Stop if false issue references found
        if: ${{ steps.extract.outputs.issues == '' }}
        run: echo "No issues referenced. Skipping."

      - name: Close referenced issues
        if: ${{ steps.extract.outputs.issues != '' }}
        run: |
          for issue in ${{ steps.extract.outputs.issues }}; do
            gh issue close "$issue" --comment "Closed automatically via PR #${{ github.event.pull_request.number }}"
          done

      - name: Move to Done
        if: ${{ steps.extract.outputs.issues != '' }}
        uses: alex-page/github-project-automation-plus@v0.9.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          project: "Codex Dual-Track Development"
          status: "Done"
          action: status
          pattern: "#([0-9]+)"
