<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Codex Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      background: #f8f9fa;
    }
    h1, h2 {
      margin-top: 0;
    }
    .box {
      background: #ffffff;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .flex-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .flex-col {
      flex: 1;
      min-width: 280px;
    }
    code, pre {
      background: #eee;
      padding: 6px;
      border-radius: 4px;
    }
    a {
      color: #0077cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <h1>ðŸ“Š Codex Dashboard</h1>
  <p>Status panels below reflect the latest Codex Self-Test cycles and Supervisor activity.</p>

  <!-- Supervisor Status -->
  <div class="box">
    <h2>ðŸ§­ Codex Supervisor</h2>
    <div id="supervisor-panel">Loading supervisor statusâ€¦</div>
  </div>

  <!-- Self-Test Status -->
  <div class="box">
    <h2>ðŸ§ª Codex Self-Test Telemetry</h2>
    <div id="selftest-latest">Loading latest self-testâ€¦</div>
  </div>

  <!-- Heartbeat -->
  <div class="box">
    <h2>ðŸ’“ Codex Self-Test Heartbeat</h2>
    <canvas id="heartbeat" width="700" height="250"></canvas>
  </div>

  <script>
    fetch("codex-data.json")
      .then((r) => r.json())
      .then((data) => {
        // ================================
        // Supervisor Panel
        // ================================
        const sup = data.supervisor || {};
        const supEl = document.getElementById("supervisor-panel");

        if (!sup.last_run) {
          supEl.innerHTML = "<p>No supervisor telemetry yet.</p>";
        } else {
          supEl.innerHTML = `
            <p><strong>Last Run:</strong> ${sup.last_run}</p>
            <p><strong>Issue:</strong> ${
              sup.last_issue ? "#" + sup.last_issue : "None"
            }</p>
            <p><strong>PR:</strong> ${
              sup.last_pr ? `<a href="${sup.last_pr}" target="_blank">${sup.last_pr}</a>` : "None"
            }</p>
            <p><strong>Status:</strong> ${sup.last_status}</p>
          `;
        }

        // ================================
        // Self-Test Telemetry Panel
        // ================================
        const tel = data.telemetry || {};
        const selfEl = document.getElementById("selftest-latest");

        if (!tel.last_run) {
          selfEl.innerHTML = "<p>No self-test runs recorded.</p>";
        } else {
          selfEl.innerHTML = `
            <p><strong>Last Run:</strong> ${tel.last_run}</p>
            <p><strong>Status:</strong> ${tel.last_status}</p>
            <p><strong>Issue:</strong> ${
              tel.last_issue ? "#" + tel.last_issue : "None"
            }</p>
            <p><strong>PR:</strong> ${
              tel.last_pr ? `<a href="${tel.last_pr}" target="_blank">${tel.last_pr}</a>` : "None"
            }</p>

            <p><strong>Total Runs:</strong> ${tel.stats?.total_runs || 0}</p>
            <p><strong>Success Rate:</strong> ${
              Math.round((tel.stats?.success_rate || 0) * 100)
            }%</p>
            <p><strong>Failures:</strong> ${tel.stats?.failures || 0}</p>
            <p><strong>Avg Duration:</strong> ${
              tel.stats?.average_duration || "N/A"
            } sec</p>
          `;
        }

        // ================================
        // Heartbeat Chart
        // ================================
        const history = data.telemetry?.history || [];
        const canvas = document.getElementById("heartbeat");
        const ctx = canvas.getContext("2d");

        if (!history.length) {
          ctx.fillText("No self-test history yet.", 10, 20);
          return;
        }

        const points = history.slice(0, 25).map((h, i) => ({
          x: i,
          y: h.status === "success" ? 1 : 0,
        }));

        const width = canvas.width;
        const height = canvas.height;
        const margin = 20;
        const stepX = points.length > 1
          ? (width - margin * 2) / (points.length - 1)
          : width - margin * 2;

        // Background
        ctx.fillStyle = "#fafafa";
        ctx.fillRect(0, 0, width, height);

        // Axes
        ctx.strokeStyle = "#999";
        ctx.beginPath();
        ctx.moveTo(margin, margin);
        ctx.lineTo(margin, height - margin);
        ctx.lineTo(width - margin, height - margin);
        ctx.stroke();

        // Values line
        ctx.strokeStyle = "#0077cc";
        ctx.lineWidth = 2;
        ctx.beginPath();
        points.forEach((p, i) => {
          const x = margin + i * stepX;
          const y = margin + (1 - p.y) * (height - margin * 2);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // Legend
        ctx.fillStyle = "#444";
        ctx.fillText("1 = success    0 = failure", margin + 5, height - 5);
      })
      .catch((err) => {
        console.error("Codex dashboard error:", err);
        document.getElementById("supervisor-panel").innerHTML =
          "<p>Error loading dashboard data.</p>";
      });
  </script>
</body>
</html>
